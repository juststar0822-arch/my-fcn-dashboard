<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN æ——è‰¦å ±åƒ¹ç³»çµ± v3.7</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #fafafa; font-family: 'Inter', "Microsoft JhengHei", sans-serif; color: #1e293b; }
        [v-cloak] { display: none; }
        
        .glass-input { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; transition: all 0.2s; }
        .glass-input:focus { border-color: #3b82f6; outline: none; }
        .btn-premium { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; font-weight: 900; }

        /* æˆªåœ–ç·©è¡å€ */
        .capture-box { width: 440px; margin: 0 auto; background: white; padding: 15px; }
        .page-container { width: 405px; border: 1.5px solid #000; background: #fff; margin: 0 auto; overflow: hidden; }
        
        /* æ‘˜è¦å¡æ¨£å¼ */
        .summary-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .summary-header { font-size: 22px; font-weight: 900; text-align: center; border-bottom: 2px solid #000; padding: 12px; background: #fff; }
        .navy-cell { background: #2c3e50; color: white; border: 1px solid #000; text-align: center; font-size: 12px; font-weight: bold; padding: 10px 2px; }
        .white-cell { background: #fff; border: 1px solid #000; text-align: center; font-weight: 900; font-size: 18px; padding: 8px 2px; height: 50px; }

        /* è©³ç´°å ±åƒ¹æ¨£å¼ */
        .orange-bar { background: #fbbf24; border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 4px; text-align: center; font-weight: 900; font-size: 13px; }
        .detail-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .detail-table td { border: 1px solid #000; font-size: 11px; font-weight: bold; padding: 5px 2px; }
        
        .row-container { display: flex; width: 100%; border-bottom: 1px solid #000; }
        .data-side { width: 125px; border-right: 1px solid #000; flex-shrink: 0; }
        .chart-side { flex-grow: 1; padding: 0px 5px 2px 0px; background: #fff; display: flex; flex-direction: column; overflow: visible; }
        .chart-box { height: 145px; width: 100%; } 
        
        /* ä¸‹æ–¹åœ–ä¾‹ - æ”¹ç‚ºè™›ç·š */
        .chart-legend-bottom { display: flex; justify-content: center; gap: 8px; font-size: 8px; padding: 4px 0; font-weight: bold; color: #64748b; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dash { width: 15px; height: 0px; border-top: 2px dashed; }
        .legend-solid { width: 15px; height: 2px; background: #3b82f6; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-xl mx-auto">
        
        <!-- 1. è¼¸å…¥é¢æ¿ -->
        <div v-if="!isLocked" class="bg-white rounded-[2rem] p-8 shadow-xl border border-slate-100 mb-8 no-print">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-black italic text-slate-800 tracking-tighter">FCN QUOTE <span class="text-blue-600">v3.7</span></h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Real-time Terminal (2026 Checked)</p>
            </div>

            <div class="space-y-4">
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button @click="form.market = 'US'" :class="['flex-1 py-2 rounded-lg font-bold text-xs transition', form.market==='US'?'bg-white shadow-sm text-blue-600':'text-slate-400']">US ç¾è‚¡</button>
                    <button @click="form.market = 'JP'" :class="['flex-1 py-2 rounded-lg font-bold text-xs transition', form.market==='JP'?'bg-white shadow-sm text-blue-600':'text-slate-400']">JP æ—¥è‚¡</button>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-500 mb-1 px-1 uppercase">é€£çµæ¨™çš„ä»£ç¢¼</label>
                    <input v-model="form.tickers" class="w-full glass-input text-center text-lg font-black uppercase" placeholder="NVDA,TSM,AMD">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">ç™¼è¡Œæ©Ÿæ§‹</label><input v-model="form.issuer" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">å ±åƒ¹æ—¥æœŸ</label><input v-model="form.date" type="date" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">å¤©æœŸ (æœˆ)</label><input v-model="form.tenor" type="number" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">ä¿è­‰é ˜æ¯</label><input v-model="form.guarantee" type="number" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">åˆ©ç‡ %</label><input v-model="form.coupon" type="number" class="w-full glass-input text-sm text-blue-600"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">KO %</label><input v-model="form.koP" type="number" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">Strike %</label><input v-model="form.strikeP" type="number" class="w-full glass-input text-sm"></div>
                    <div><label class="text-[10px] font-black text-slate-500 mb-1">KI %</label><input v-model="form.kiP" type="number" class="w-full glass-input text-sm"></div>
                </div>
                <button @click="generate" :disabled="isSyncing" class="w-full btn-premium py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3">
                    <i v-if="isSyncing" class="fa-solid fa-circle-notch animate-spin"></i>
                    {{ isSyncing ? 'æ­£åœ¨æŠ“å– 2026 æœ€æ–°è‚¡åƒ¹...' : 'ç”Ÿæˆ 2026 ç²¾ç¢ºå ±åƒ¹é è¦½' }}
                </button>
            </div>
        </div>

        <!-- 2. æ§åˆ¶æŒ‰éˆ• -->
        <div v-if="isGenerated" class="flex flex-col items-center gap-3 mb-8 no-print sticky top-2 z-[500]">
            <button @click="isLocked = !isLocked" class="bg-slate-800 text-white px-8 py-2 rounded-full font-bold text-xs shadow-md">{{ isLocked ? 'ğŸ”“ é¡¯ç¤ºä¿®æ”¹é¢æ¿' : 'ğŸ”’ é–å®šéš±è—é¢æ¿' }}</button>
            <div class="flex gap-3">
                <button @click="capture('summary')" class="bg-blue-600 text-white px-5 py-3 rounded-xl font-bold text-xs shadow-lg">ğŸ“¸ ä¸‹è¼‰æ‘˜è¦å¡</button>
                <button @click="capture('detail')" class="bg-emerald-600 text-white px-5 py-3 rounded-xl font-bold text-xs shadow-lg">ğŸ“¸ ä¸‹è¼‰è©³ç´°å ±åƒ¹</button>
            </div>
        </div>

        <!-- 3. é è¦½å€åŸŸ -->
        <div v-show="isGenerated" class="fade-in">
            <!-- åœ– 1 -->
            <div id="capture-summary" class="capture-box">
                <div class="page-container shadow-sm">
                    <div class="summary-header">å ±åƒ¹æ—¥æœŸ {{ form.date.replace(/-/g, '/') }}</div>
                    <table class="summary-table">
                        <tr><td class="navy-cell">ç™¼è¡Œæ©Ÿæ§‹</td><td class="white-cell">{{ form.issuer }}</td><td class="navy-cell">æå‰å‡ºå ´åƒ¹(KO)</td><td class="white-cell">{{ form.koP.toFixed(2) }}%</td></tr>
                        <tr><td class="navy-cell">è¨ˆåƒ¹å¹£åˆ¥</td><td class="white-cell">{{ form.market === 'JP' ? 'JPY' : 'USD' }}</td><td class="navy-cell" rowspan="2">å±¥ç´„åƒ¹<br>(Strike)</td><td class="white-cell text-2xl" rowspan="2">{{ form.strikeP.toFixed(2) }}%</td></tr>
                        <tr><td class="navy-cell">äº¤æ˜“é¡å‹</td><td class="white-cell">FCN</td></tr>
                        <tr><td class="navy-cell">å¤©æœŸ(æœˆ)</td><td class="white-cell">{{ form.tenor }}</td><td class="navy-cell" rowspan="2">è§¸åŠç”Ÿæ•ˆåƒ¹<br>(KI)</td><td class="white-cell text-2xl" :class="{'text-red-500': form.kiP > 0}" rowspan="2">{{ form.kiP == 0 ? '-' : form.kiP.toFixed(2) + '%' }}</td></tr>
                        <tr><td class="navy-cell text-orange-400 font-bold">ä¿è­‰é ˜æ¯</td><td class="white-cell text-orange-500 font-black">{{ form.guarantee }}</td></tr>
                        <tr><td class="navy-cell">å¹´åŒ–å ±é…¬</td><td class="white-cell text-blue-700 font-black text-2xl" colspan="3">{{ form.coupon.toFixed(2) }}%</td></tr>
                    </table>
                    <div class="bg-blue-50 text-center py-2 font-bold border-t border-b border-black text-xs uppercase">é€£çµæ¨™çš„</div>
                    <div v-for="s in stockData" :key="'sum-'+s.symbol" class="text-center py-3 border-b border-gray-100 font-black text-lg">
                        {{ s.symbol.replace('.T', '') }} {{ getStockName(s.symbol) }}
                    </div>
                </div>
            </div>

            <div class="h-8 no-print"></div>

            <!-- åœ– 2 -->
            <div id="capture-detail" class="capture-box">
                <div class="page-container shadow-sm">
                    <div class="text-center pt-3">
                        <h1 class="text-2xl font-black tracking-widest leading-none">FCNå ±åƒ¹å–®</h1>
                        <div class="flex justify-between px-3 text-[9px] font-bold text-red-600 mt-1">
                            <span>å¹£åˆ¥ï¼š{{ form.market === 'JP' ? 'JPY' : 'USD' }}</span>
                            <span>â—åƒ…ä¾›å…§éƒ¨åƒè€ƒï¼Œä»¥å¯¦éš›æˆäº¤ç‚ºæº– â—æ¨™çš„æ­·å²èµ°å‹¢</span>
                        </div>
                    </div>
                    <table class="detail-table text-center mt-2">
                        <tr class="bg-yellow-50"><td rowspan="2" width="22%">æ—¥æœŸ</td><td rowspan="2" width="10%">æœˆ</td><td colspan="3">æ¢ä»¶ (%)</td><td rowspan="2" width="22%">Coupon</td></tr>
                        <tr class="bg-white text-[8px]"><td>KO</td><td>Strike</td><td>KI</td></tr>
                        <tr class="text-blue-700 font-black"><td>{{ form.date.split('-').slice(1).join('/') }}</td><td>{{ form.tenor }}</td><td>{{ form.koP.toFixed(2) }}%</td><td>{{ form.strikeP.toFixed(2) }}%</td><td>{{ form.kiP == 0 ? '-' : form.kiP.toFixed(2) + '%' }}</td><td>{{ form.coupon.toFixed(2) }}%</td></tr>
                    </table>
                    <div v-for="(stock, index) in stockData" :key="'det-'+stock.symbol">
                        <div class="orange-bar">æ¨™çš„ {{ index + 1 }} : {{ stock.symbol.replace('.T', '') }}</div>
                        <div class="row-container">
                            <div class="data-side">
                                <table class="detail-table w-full h-full border-none">
                                    <tr><td colspan="2" class="text-center text-blue-900 text-sm py-2 leading-tight">{{ getStockName(stock.symbol) }}</td></tr>
                                    <tr class="bg-slate-50"><td>å‰æ—¥æ”¶ç›¤</td><td class="text-right">{{ stock.price }}</td></tr>
                                    <tr><td>KO</td><td class="text-right">{{ (stock.price * form.koP/100).toFixed(2) }}</td></tr>
                                    <tr><td>Strike</td><td class="text-right">{{ (stock.price * form.strikeP/100).toFixed(2) }}</td></tr>
                                    <tr><td>KI</td><td class="text-right">{{ form.kiP == 0 ? '-' : (stock.price * form.kiP/100).toFixed(2) }}</td></tr>
                                </table>
                            </div>
                            <div class="chart-side">
                                <div class="chart-box"><canvas :id="'chart-' + index"></canvas></div>
                                <div class="chart-legend-bottom">
                                    <div class="legend-item"><span class="legend-dash" style="border-color:#f97316"></span>KO</div>
                                    <div class="legend-item"><span class="legend-dash" style="border-color:#94a3b8"></span>Strike</div>
                                    <div class="legend-item"><span class="legend-dash" style="border-color:#fbbf24"></span>KI</div>
                                    <div class="legend-item"><span class="legend-solid"></span>æ”¶ç›¤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'TSM':'å°ç©é›»','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','AAPL':'è˜‹æœ','MSFT':'å¾®è»Ÿ','AMZN':'äºé¦¬éœ','GOOG':'è°·æ­Œ','META':'è‡‰æ›¸','AMD':'è¶…å¾®','MU':'ç¾å…‰','AVGO':'åšé€š','NFLX':'ç¶²é£›','PLTR':'å¸•è˜­æçˆ¾','ORCL':'ç”²éª¨æ–‡','SMCI':'ç¾è¶…å¾®','DELL':'æˆ´çˆ¾','ARM':'å®‰è¬€','OKLO':'Oklo','BRK.B':'æ³¢å…‹å¤','6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…'};

        createApp({
            data() {
                return {
                    isLocked: false, isCapturing: false, isGenerated: false, isSyncing: false,
                    form: { market: 'US', date: new Date().toISOString().split('T')[0], issuer: 'Nomura', tenor: 6, guarantee: 1, coupon: 12, koP: 100, strikeP: 75, kiP: 55, tickers: 'TSM,NVDA,ORCL,AMD' },
                    stockData: []
                }
            },
            methods: {
                getStockName(s){ return stockNames[s.toUpperCase()] || ''; },
                async generate() {
                    this.isSyncing = true; this.isGenerated = false;
                    let tickerList = [...new Set(this.form.tickers.split(',').map(s => s.trim().toUpperCase()).filter(t => t))];
                    if(this.form.market === 'JP') tickerList = tickerList.map(t => t.endsWith('.T') ? t : t + '.T');
                    
                    const startDate = new Date('2024/09/01').getTime() / 1000;
                    const cacheBuster = new Date().getTime(); // å¼·åˆ¶æŠ“æœ€æ–°æ•¸æ“š

                    const results = await Promise.all(tickerList.map(async (ticker) => {
                        try {
                            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/'+ticker+'?range=2y&interval=1d&cb='+cacheBuster)}`);
                            const json = JSON.parse((await res.json()).contents);
                            const result = json.chart.result[0];
                            const prices = result.indicators.quote[0].close;
                            const timestamps = result.timestamp;
                            
                            const validPrices = []; const validLabels = [];
                            for(let i = 0; i < prices.length; i++) {
                                if(prices[i] != null && timestamps[i] >= startDate) {
                                    validPrices.push(prices[i]);
                                    const d = new Date(timestamps[i] * 1000);
                                    validLabels.push(`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`);
                                }
                            }
                            return { symbol: ticker, price: validPrices[validPrices.length - 1].toFixed(2), history: validPrices, labels: validLabels };
                        } catch (e) { return null; }
                    }));

                    this.stockData = results.filter(r => r !== null);
                    this.isGenerated = true;
                    this.isSyncing = false;

                    this.$nextTick(() => {
                        this.stockData.forEach((s, i) => {
                            let retry = 0;
                            const checkAndDraw = setInterval(() => {
                                const el = document.getElementById('chart-' + i);
                                if (el || retry > 15) {
                                    clearInterval(checkAndDraw);
                                    if(el) this.drawChart(i, s);
                                }
                                retry++;
                            }, 100);
                        });
                    });
                },
                drawChart(idx, stock) {
                    const canvas = document.getElementById('chart-' + idx);
                    const ctx = canvas.getContext('2d');
                    const ko = stock.price * (this.form.koP / 100);
                    const strike = stock.price * (this.form.strikeP / 100);
                    const ki = this.form.kiP > 0 ? stock.price * (this.form.kiP / 100) : null;
                    
                    const minP = Math.min(...stock.history, ko, strike, ki || 99999);
                    const maxP = Math.max(...stock.history, ko, strike, ki || 0);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: stock.labels,
                            datasets: [
                                { data: stock.history, borderColor: '#3b82f6', borderWidth: 1.5, pointRadius: 0 },
                                { data: Array(stock.history.length).fill(ko), borderColor: '#f97316', borderWidth: 1.2, pointRadius: 0, borderDash: [2, 2] },
                                { data: Array(stock.history.length).fill(strike), borderColor: '#94a3b8', borderWidth: 1.2, pointRadius: 0, borderDash: [2, 2] },
                                ...(ki ? [{ data: Array(stock.history.length).fill(ki), borderColor: '#fbbf24', borderWidth: 1.2, pointRadius: 0, borderDash: [4, 2] }] : [])
                            ]
                        },
                        options: {
                            animation: false, responsive: true, maintainAspectRatio: false,
                            layout: { padding: { right: 35 } }, 
                            plugins: { legend: { display: false } },
                            scales: { 
                                x: { display: true, ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 45, autoSkip: true, maxTicksLimit: 8 }, grid: { display: false } }, 
                                y: { position: 'right', min: minP * 0.95, max: maxP * 1.05, ticks: { font: { size: 9, weight: 'bold' } }, grid: { color: '#f0f0f0' } } 
                            }
                        }
                    });
                },
                async capture(type) {
                    this.isCapturing = true;
                    const element = document.getElementById(type === 'summary' ? 'capture-summary' : 'capture-detail');
                    await new Promise(r => setTimeout(r, 600));
                    const canvas = await html2canvas(element, { scale: 3, useCORS: true, backgroundColor: '#ffffff', width: 440 });
                    const link = document.createElement('a');
                    link.download = `FCN-${type}-${this.form.date}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    this.isCapturing = false;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
