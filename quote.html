<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN å°ˆæ¥­å ±åƒ¹ç³»çµ± v2.1</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f4f4f4; font-family: "Microsoft JhengHei", sans-serif; }
        .page-container { width: 400px; margin: 0 auto; background: white; border: 1px solid #000; }
        
        /* æ‘˜è¦å¡æ¨£å¼ */
        .summary-header { background: #fff; border-bottom: 2px solid #000; padding: 5px; font-weight: bold; }
        .navy-cell { background: #2c3e50; color: white; border: 1px solid #ccc; text-align: center; font-size: 14px; padding: 10px 5px; }
        .white-cell { background: #fff; border: 1px solid #ccc; text-align: center; font-weight: 900; font-size: 18px; padding: 10px 5px; }
        .ki-red { color: #e74c3c; }

        /* è©³ç´°è¡¨æ¨£å¼ */
        .orange-bar { background: #f1c40f; border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; font-size: 14px; }
        .detail-table td { border: 1px solid #000; font-size: 13px; font-weight: bold; padding: 4px; }
        .chart-box { height: 180px; width: 100%; border-bottom: 1px solid #eee; }
        
        /* éš±è—è¼¸å…¥é¢æ¿ */
        @media print { .no-print { display: none; } }
        .market-btn { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid #ccc; }
        .market-btn.active { background: #1e40af; color: white; border-color: #1e40af; }
    </style>
</head>
<body>
    <div id="app" class="pb-20">
        
        <!-- è¼¸å…¥é¢æ¿ -->
        <div v-if="!isLocked" class="no-print p-4 bg-white shadow-md mb-6 max-w-md mx-auto rounded-b-xl">
            <h2 class="font-black text-blue-800 mb-3 border-b-2 border-blue-800">FCN å ±åƒ¹è¼¸å…¥é¢æ¿ v2.1</h2>
            
            <!-- å¸‚å ´åˆ‡æ› -->
            <div class="flex gap-2 mb-3 items-center">
                <span class="text-xs font-bold">å¸‚å ´é¸æ“‡ï¼š</span>
                <div @click="form.market = 'US'" :class="['market-btn', form.market === 'US' ? 'active' : '']">ç¾è‚¡</div>
                <div @click="form.market = 'JP'" :class="['market-btn', form.market === 'JP' ? 'active' : '']">æ—¥è‚¡ (.T)</div>
            </div>

            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="col-span-2">æ¨™çš„ä»£ç¢¼ (é€—è™Ÿåˆ†éš”) <input v-model="form.tickers" class="w-full border p-2 rounded mt-1" placeholder="ä¾‹å¦‚: TSM,NVDA,TSLA æˆ– 6146,6501"></div>
                <div>ç™¼è¡Œæ©Ÿæ§‹ <input v-model="form.issuer" class="w-full border p-2 rounded mt-1"></div>
                <div>å ±åƒ¹æ—¥æœŸ <input v-model="form.date" type="date" class="w-full border p-2 rounded mt-1"></div>
                <div>å¤©æœŸ(æœˆ) <input v-model="form.tenor" type="number" class="w-full border p-2 rounded mt-1"></div>
                <div>ä¿è­‰é ˜æ¯(æœˆ) <input v-model="form.guarantee" type="number" class="w-full border p-2 rounded mt-1"></div>
                <div>å¹´åŒ–åˆ©ç‡% <input v-model="form.coupon" type="number" class="w-full border p-2 rounded mt-1"></div>
                <div>KO % <input v-model="form.koP" type="number" class="w-full border p-2 rounded mt-1"></div>
                <div>Strike % <input v-model="form.strikeP" type="number" class="w-full border p-2 rounded mt-1"></div>
                <div>KI % (NAå¡«0) <input v-model="form.kiP" type="number" class="w-full border p-2 rounded mt-1"></div>
            </div>
            <button @click="generate" class="w-full mt-4 bg-blue-700 text-white font-black py-3 rounded-lg shadow-lg">ç”Ÿæˆå ±åƒ¹é è¦½</button>
        </div>

        <div class="flex justify-center mb-4 no-print">
            <button @click="isLocked = !isLocked" class="bg-black text-white px-6 py-2 rounded-full font-bold shadow-md italic">
                {{ isLocked ? 'ğŸ”“ é¡¯ç¤ºä¿®æ”¹é¢æ¿' : 'ğŸ”’ éš±è—é¢æ¿æº–å‚™æˆªåœ–' }}
            </button>
        </div>

        <!-- å ±åƒ¹å–®å…§å®¹å€ -->
        <div v-if="stockData.length > 0" class="space-y-10">
            
            <!-- ç¬¬ä¸€å¼µï¼šæ‘˜è¦å¡ -->
            <div class="page-container shadow-2xl">
                <div class="summary-header flex justify-between px-4">
                    <span>å ±åƒ¹æ—¥æœŸ</span>
                    <span>{{ form.date.replace(/-/g, '/') }}</span>
                </div>
                <div class="grid grid-cols-12">
                    <div class="col-span-3 navy-cell">ç™¼è¡Œæ©Ÿæ§‹</div>
                    <div class="col-span-3 white-cell">{{ form.issuer }}</div>
                    <div class="col-span-3 navy-cell">æå‰å‡ºå ´åƒ¹<br>(KO)</div>
                    <div class="col-span-3 white-cell text-2xl flex items-center justify-center">{{ form.koP.toFixed(2) }}%</div>
                    
                    <div class="col-span-3 navy-cell">è¨ˆåƒ¹å¹£åˆ¥</div>
                    <div class="col-span-3 white-cell">{{ form.market === 'JP' ? 'JPY' : 'USD' }}</div>
                    <div class="col-span-3 navy-cell" style="grid-row: span 2;">å±¥ç´„åƒ¹<br>(Strike)</div>
                    <div class="col-span-3 white-cell text-2xl flex items-center justify-center" style="grid-row: span 2;">{{ form.strikeP.toFixed(2) }}%</div>
                    
                    <div class="col-span-3 navy-cell">äº¤æ˜“é¡å‹</div>
                    <div class="col-span-3 white-cell">FCN</div>

                    <div class="col-span-3 navy-cell">å¤©æœŸ(æœˆ)</div>
                    <div class="col-span-3 white-cell">{{ form.tenor }}</div>
                    <div class="col-span-3 navy-cell" style="grid-row: span 2;">è§¸åŠç”Ÿæ•ˆåƒ¹<br>(KI)</div>
                    <div class="col-span-3 white-cell text-2xl ki-red flex items-center justify-center" style="grid-row: span 2;">{{ form.kiP == 0 ? 'NA' : form.kiP + '%' }}</div>

                    <div class="col-span-3 navy-cell text-red-500 font-bold">ä¿è­‰é ˜æ¯(æœˆ)</div>
                    <div class="col-span-3 white-cell text-red-500">{{ form.guarantee }}</div>

                    <div class="col-span-3 navy-cell">å¹´åŒ–å ±é…¬ç‡</div>
                    <div class="col-span-3 white-cell text-xl text-blue-600">{{ form.coupon.toFixed(2) }}%</div>
                </div>
                <div class="bg-blue-50 text-center py-2 font-black border-t border-b border-black">é€£çµæ¨™çš„</div>
                <div v-for="s in stockData" class="text-center py-3 border-b border-gray-200 font-black text-lg">
                    {{ s.symbol.replace('.T', '') }} {{ getStockName(s.symbol) }}
                </div>
            </div>

            <!-- ç¬¬äºŒå¼µï¼šè©³ç´°å ±åƒ¹ (ä¿®æ­£ç©ºæ ¼å•é¡Œ) -->
            <div class="page-container shadow-2xl pb-4">
                <div class="text-center pt-4">
                    <h1 class="text-3xl font-black tracking-widest">FCNå ±åƒ¹</h1>
                    <div class="flex justify-between px-2 text-[9px] font-bold text-red-600 mt-1">
                        <span>äº¤å‰²å¹£åˆ¥ï¼š{{ form.market === 'JP' ? 'JPY' : 'USD' }}</span>
                        <span>â—åƒ…ä¾›å…§éƒ¨åƒè€ƒï¼Œä¸€åˆ‡ä»¥å¯¦éš›æˆäº¤ç‹€æ³ç‚ºä¸» â—æ¨™çš„è¿‘600å€‹äº¤æ˜“æ—¥èµ°å‹¢ä¾›åƒè€ƒ</span>
                    </div>
                </div>

                <!-- æ ¸å¿ƒæ¢ä»¶è¡¨ (ç§»é™¤å¤šé¤˜ç©ºæ ¼) -->
                <table class="w-full detail-table text-center mt-2 border-collapse">
                    <thead>
                        <tr class="bg-yellow-50">
                            <th class="border border-black p-1" rowspan="2">æ—¥æœŸ</th>
                            <th class="border border-black p-1" rowspan="2">å¤©æœŸ(æœˆ)</th>
                            <th class="border border-black p-1" colspan="3">æ¢ä»¶</th>
                            <th class="border border-black p-1" rowspan="2">Coupon</th>
                        </tr>
                        <tr class="bg-white">
                            <th class="border border-black p-1 text-[9px]">å‡ºå ´åƒ¹ KO</th>
                            <th class="border border-black p-1 text-[9px]">å±¥ç´„åƒ¹ Strike</th>
                            <th class="border border-black p-1 text-[9px]">ä¸‹é™åƒ¹ KI</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-blue-600 border border-black">{{ form.date.replace(/-/g, '/') }}</td>
                            <td class="text-blue-600 border border-black">{{ form.tenor }}</td>
                            <td class="text-blue-600 border border-black">{{ form.koP.toFixed(2) }}%</td>
                            <td class="text-blue-600 border border-black">{{ form.strikeP.toFixed(2) }}%</td>
                            <td class="text-blue-600 border border-black">{{ form.kiP == 0 ? 'NA' : form.kiP.toFixed(2) + '%' }}</td>
                            <td class="text-blue-600 border border-black">{{ form.coupon.toFixed(2) }}%</td>
                        </tr>
                    </tbody>
                </table>

                <!-- è‚¡ç¥¨å¾ªç’° -->
                <div v-for="(stock, index) in stockData" :key="stock.symbol">
                    <div class="orange-bar">æ¨™çš„ {{ index + 1 }}</div>
                    <div class="flex">
                        <div class="w-5/12 border-r border-black">
                            <table class="w-full detail-table">
                                <tr><td colspan="2" class="text-center text-blue-800 text-lg">{{ stock.symbol.replace('.T', '') }}</td></tr>
                                <tr><td colspan="2" class="text-center text-yellow-600 text-[10px]">{{ getStockName(stock.symbol) }}</td></tr>
                                <tr class="text-[10px] bg-gray-50"><td>å‰ä¸€æ—¥æ”¶ç›¤åƒ¹ï¼š</td><td class="text-right">{{ stock.price }}</td></tr>
                                <tr class="text-[10px]"><td>KO</td><td class="text-right">{{ (stock.price * form.koP/100).toFixed(2) }}</td></tr>
                                <tr class="text-[10px]"><td>Strike</td><td class="text-right">{{ (stock.price * form.strikeP/100).toFixed(2) }}</td></tr>
                                <tr class="text-[10px]"><td>KI</td><td class="text-right">{{ form.kiP == 0 ? '-' : (stock.price * form.kiP/100).toFixed(2) }}</td></tr>
                            </table>
                        </div>
                        <div class="w-7/12 p-1">
                            <div class="chart-box">
                                <canvas :id="'chart-' + index"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue;
        // æ“´å……æ¨™çš„å­—å…¸
        const stockNames = {
            'TSM':'å°ç©é›»','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','AAPL':'è˜‹æœ','MSFT':'å¾®è»Ÿ','AMZN':'äºé¦¬éœ','GOOG':'è°·æ­Œ','META':'è‡‰æ›¸','AMD':'è¶…å¾®','MU':'ç¾å…‰','AVGO':'åšé€š','NFLX':'ç¶²é£›','PLTR':'å¸•è˜­æçˆ¾','BRK.B':'æ³¢å…‹å¤',
            '6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…'
        };

        createApp({
            data() {
                return {
                    isLocked: false,
                    form: { market: 'US', date: new Date().toISOString().split('T')[0], issuer: 'Nomura', tenor: 6, guarantee: 1, coupon: 12, koP: 100, strikeP: 75, kiP: 55, tickers: 'TSM,NVDA,TSLA' },
                    stockData: []
                }
            },
            methods: {
                getStockName(s){ return stockNames[s] || ''; },
                async generate() {
                    this.stockData = [];
                    let tickerList = this.form.tickers.split(',').map(s => s.trim().toUpperCase());
                    
                    // æ—¥è‚¡ä»£ç¢¼è‡ªå‹•è™•ç†
                    if(this.form.market === 'JP') {
                        tickerList = tickerList.map(t => t.endsWith('.T') ? t : t + '.T');
                    }

                    for (let t of tickerList) {
                        try {
                            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/'+t+'?range=2y&interval=1d')}`);
                            const json = JSON.parse((await res.json()).contents);
                            const result = json.chart.result[0];
                            const prices = result.indicators.quote[0].close;
                            this.stockData.push({
                                symbol: t,
                                price: prices[prices.length - 1].toFixed(2),
                                history: prices.slice(-600)
                            });
                        } catch (e) { console.error('æŠ“å–å¤±æ•—:', t); }
                    }
                    setTimeout(() => this.stockData.forEach((s, i) => this.drawChart(i, s)), 500);
                },
                drawChart(idx, stock) {
                    const ctx = document.getElementById('chart-' + idx).getContext('2d');
                    const ko = stock.price * (this.form.koP / 100);
                    const strike = stock.price * (this.form.strikeP / 100);
                    const ki = this.form.kiP > 0 ? stock.price * (this.form.kiP / 100) : null;

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(stock.history.length).fill(''),
                            datasets: [
                                { data: stock.history, borderColor: '#3b82f6', borderWidth: 1, pointRadius: 0 },
                                { data: Array(600).fill(ko), borderColor: '#f97316', borderWidth: 1, pointRadius: 0, borderDash: [2, 2] },
                                { data: Array(600).fill(strike), borderColor: '#94a3b8', borderWidth: 1, pointRadius: 0, borderDash: [2, 2] },
                                ...(ki ? [{ data: Array(600).fill(ki), borderColor: '#fbbf24', borderWidth: 1, pointRadius: 0 }] : [])
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { position: 'right', ticks: { font: { size: 7 } }, grid: { display: false } } }
                        }
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
