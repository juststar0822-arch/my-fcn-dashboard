<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元元致富精算 - 110歲專業版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background: #0f172a; color: #f1f5f9; font-size: 14px; -webkit-font-smoothing: antialiased; }
        .input-card { background: #1e293b; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #334155; }
        input, select { background: #475569; border: 1px solid #64748b; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-top: 4px; outline: none; }
        label { color: #94a3b8; font-size: 11px; font-weight: bold; }
        .res-box { background: linear-gradient(135deg, #1e40af 0%, #111827 100%); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #3b82f6; }
    </style>
</head>
<body class="p-4">
<div id="app">
    <div class="res-box shadow-2xl">
        <p class="text-blue-200 text-xs">預估保障可支撐至</p>
        <div class="text-6xl font-black my-1 text-white">{{ age + survivalYears }} <span class="text-2xl font-normal">歲</span></div>
        <p class="text-sm text-blue-300 font-bold">美元預估總資產：USD ${{ smartFormatUSD(currentBalanceUSD) }}</p>
    </div>

    <div class="input-card">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>投保性別</label><select v-model="gender"><option value="male">男性</option><option value="female">女性</option></select></div>
            <div><label>試算匯率</label><input type="number" v-model.number="fx" step="0.1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div><label>投入保費 (萬)</label><input type="number" v-model.number="principal"></div>
            <div><label>目前年齡</label><input type="number" v-model.number="age"></div>
        </div>
    </div>

    <div class="input-card">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>基本保額 (萬)</label><input type="number" v-model.number="faceAmount"></div>
            <div><label>初始淨值 (USD)</label><input type="number" v-model.number="nav" step="0.1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>單位配息 (USD)</label><input type="number" v-model.number="divPerUnit" step="0.001"></div>
            <div><label>配息領走 (%)</label><input type="number" v-model.number="withdrawRatio"></div>
        </div>
        <div><label>淨值衝擊假設 (%)</label><input type="number" v-model.number="marketShock"></div>
    </div>

    <div class="space-y-3 mb-10">
        <div v-for="row in simulation" :key="row.age" class="bg-slate-800 p-4 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-sm font-bold text-white">{{ row.age }}歲 <span class="text-[10px] text-slate-500 font-normal ml-1">第{{ row.year + 1 }}年</span></p>
                    <p class="text-[11px] text-blue-400 font-mono mt-0.5">持分: {{ formatUnit(row.units) }}</p>
                </div>
                <div class="text-right">
                    <p class="text-base font-black text-green-400">{{ smartFormat(row.balance * 10000) }}</p>
                    <p class="text-[11px] text-white font-mono">USD ${{ smartFormatUSD(row.balance * 10000 / fx) }}</p>
                </div>
            </div>
            <div class="pt-2 border-t border-slate-700/50 grid grid-cols-2 gap-4 text-[10px]">
                <div class="text-slate-400">
                    <p>壽險成本: {{ Math.round(row.coiFee * 10000).toLocaleString() }} 元</p>
                    <p v-if="row.maintenanceFee > 0">行政費: 100 元</p>
                    <p v-else class="text-slate-500 italic text-[9px]">免收行政費 (≧300萬)</p>
                </div>
                <div class="text-right">
                    <p class="text-red-400 font-bold">月扣持分: {{ row.monthlyUnitFee.toFixed(3) }}</p>
                    <p class="text-blue-400">配息回買: {{ row.monthlyReinvest.toFixed(3) }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

// COI 費率表擴充至 110 歲
const COI_TABLE = {
    male: { 15:0.18, 20:0.25, 25:0.35, 30:0.48, 35:0.71, 40:1.27, 45:2.01, 50:2.89, 55:4.22, 60:6.22, 65:9.39, 70:15.42, 75:23.9, 80:37.65, 85:60.5, 90:105.2, 95:180.5, 100:300.0, 110:550.0 },
    female: { 15:0.08, 20:0.12, 25:0.18, 30:0.28, 35:0.39, 40:0.55, 45:0.85, 50:1.19, 55:1.80, 60:2.77, 65:4.67, 70:8.10, 75:13.61, 80:23.99, 85:42.5, 90:85.2, 95:150.8, 100:260.0, 110:500.0 }
};

const getCoiFactor = (g, a) => {
    const table = COI_TABLE[g];
    const keys = Object.keys(table).map(Number).sort((a, b) => a - b);
    if (a <= keys[0]) return table[keys[0]];
    if (a >= keys[keys.length - 1]) return table[keys[keys.length - 1]];
    let lower = keys[0], upper = keys[keys.length - 1];
    for (let k of keys) {
        if (k <= a) lower = k;
        if (k >= a) { upper = k; break; }
    }
    return table[lower] + (table[upper] - table[lower]) * (a - lower) / (upper - lower);
};

createApp({
    setup() {
        const gender = ref('female'), age = ref(40), principal = ref(500), fx = ref(32.5), marketShock = ref(0), faceAmount = ref(1000), nav = ref(9.0), divPerUnit = ref(0.055), withdrawRatio = ref(100);
        const smartFormat = (v) => v <= 0 ? '帳戶終止' : (v >= 10000 ? (v/10000).toFixed(2)+'萬' : Math.round(v).toLocaleString()+'元');
        const smartFormatUSD = (v) => Math.round(v).toLocaleString();
        const formatUnit = (v) => v.toLocaleString(undefined, {maximumFractionDigits: 1});
        
        const runSim = (isFull) => {
            const initialNav = nav.value;
            let currentNav = initialNav * (1 + (marketShock.value || 0) / 100);
            let currentUnits = (principal.value * 10000 / fx.value) / initialNav;
            let res = [];
            
            for (let y = 0; y <= 95; y++) { // 模擬拉長至 95 年
                let curAge = age.value + y;
                if (curAge > 110) break;
                let mC=0, mA=0, mAdminVal=0, mU=0, mR=0;
                
                for(let m = 0; m < 12; m++) {
                    let monthlyB = (currentUnits * currentNav * fx.value) / 10000;
                    let factor = getCoiFactor(gender.value, curAge);
                    let nar = Math.max(0, faceAmount.value - monthlyB);
                    let fR = (y < 3) ? (principal.value >= 1000 ? 0.00155 : 0.0016) : (y === 3 ? (principal.value >= 1000 ? 0.001 : 0.0012) : 0);
                    
                    let mCOIFee = (nar * factor) / 10000;
                    let mPctFee = (monthlyB * fR);
                    let mAdmin = (monthlyB >= 300) ? 0 : 0.01;
                    
                    let mTotalFee = mCOIFee + mPctFee + mAdmin;
                    let mUnitFee = (mTotalFee * 10000 / fx.value) / currentNav;
                    let rUnits = (currentUnits * divPerUnit.value * (1 - withdrawRatio.value / 100)) / initialNav;

                    mC=mCOIFee; mA=mPctFee; mAdminVal=mAdmin; mU=mUnitFee; mR=rUnits;
                    currentUnits += (rUnits - mUnitFee);
                }
                
                if (y % 5 === 0 && res.length < 25) {
                    res.push({ year: y, age: curAge, balance: (currentUnits * currentNav * fx.value) / 10000, units: currentUnits, coiFee: mC, maintenanceFee: mAdminVal, monthlyUnitFee: mU, monthlyReinvest: mR });
                }
                if (currentUnits <= 0) return isFull ? y : res;
            }
            return isFull ? 95 : res;
        };

        return { gender, age, principal, fx, marketShock, faceAmount, nav, divPerUnit, withdrawRatio, simulation: computed(()=>runSim(false)), survivalYears: computed(()=>runSim(true)), currentBalanceUSD: computed(()=>{ const r=runSim(false)[0]; return r?r.balance*10000/fx.value:0; }), smartFormat, smartFormatUSD, formatUnit };
    }
}).mount('#app');
</script>
</body>
</html>