<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元元致富精算 - 專業最終版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background: #0f172a; color: #f1f5f9; font-size: 14px; -webkit-font-smoothing: antialiased; }
        .input-card { background: #1e293b; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #334155; }
        input, select { background: #475569; border: 1px solid #64748b; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-top: 4px; outline: none; }
        label { color: #94a3b8; font-size: 11px; font-weight: bold; }
        .res-box { background: linear-gradient(135deg, #1e40af 0%, #111827 100%); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #3b82f6; }
    </style>
</head>
<body class="p-4">
<div id="app">
    <div class="res-box shadow-2xl">
        <p class="text-blue-200 text-xs">預估保障可支撐至</p>
        <div class="text-6xl font-black my-1 text-white">{{ age + survivalYears }} <span class="text-2xl font-normal">歲</span></div>
        <p class="text-sm text-blue-300 font-bold">美元預估總資產：USD ${{ smartFormatUSD(currentBalanceUSD) }}</p>
    </div>

    <div class="input-card">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>投保性別</label><select v-model="gender"><option value="male">男性</option><option value="female">女性</option></select></div>
            <div><label>試算匯率 (TWD/USD)</label><input type="number" v-model.number="fx" step="0.1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div><label>投入保費 (台幣萬)</label><input type="number" v-model.number="principal"></div>
            <div><label>目前年齡</label><input type="number" v-model.number="age"></div>
        </div>
    </div>

    <div class="input-card">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>基本保額 (台幣萬)</label><input type="number" v-model.number="faceAmount"></div>
            <div><label>初始淨值 (USD)</label><input type="number" v-model.number="nav" step="0.1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label>單位配息 (USD)</label><input type="number" v-model.number="divPerUnit" step="0.001"></div>
            <div><label>配息領走 (%)</label><input type="number" v-model.number="withdrawRatio"></div>
        </div>
        <div><label>淨值衝擊假設 (%)</label><input type="number" v-model.number="marketShock"></div>
    </div>

    <div class="space-y-3 mb-10">
        <div v-for="row in simulation" :key="row.age" class="bg-slate-800 p-4 rounded-xl border border-slate-700">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-sm font-bold text-white">{{ row.age }}歲 <span class="text-[10px] text-slate-500 font-normal ml-1">第{{ row.year + 1 }}年</span></p>
                    <p class="text-[11px] text-blue-400 font-mono mt-0.5">持分: {{ formatUnit(row.units) }}</p>
                    <p class="text-[10px] text-yellow-500">當前淨值: USD {{ row.currentNav.toFixed(2) }}</p>
                </div>
                <div class="text-right">
                    <p class="text-base font-black text-green-400">{{ smartFormat(row.balance * 10000) }}</p>
                    <p class="text-[11px] text-white font-mono">USD ${{ smartFormatUSD(row.balance * 10000 / fx) }}</p>
                </div>
            </div>
            
            <div class="pt-2 border-t border-slate-700/50 grid grid-cols-2 gap-4 text-[10px]">
                <div class="text-slate-400 space-y-1">
                    <p>壽險成本: {{ Math.round(row.coiFee * 10000).toLocaleString() }} 元</p>
                    <p>帳管費用: {{ Math.round(row.adminFee * 10000).toLocaleString() }} 元</p>
                    <p v-if="row.maintenanceFee > 0">行政維護費: 100 元</p>
                    <p v-else class="text-slate-500 italic">行政費: 免收 (≧300萬)</p>
                </div>
                <div class="text-right space-y-1">
                    <p class="text-red-400 font-bold">月扣持分: {{ row.monthlyUnitFee.toFixed(3) }}</p>
                    <p class="text-blue-400">配息回買: {{ row.monthlyReinvest.toFixed(3) }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

const COI_TABLE = {
    male: { 15:0.18, 16:0.19, 17:0.20, 18:0.21, 19:0.23, 20:0.25, 21:0.27, 22:0.29, 23:0.31, 24:0.33, 25:0.35, 26:0.37, 27:0.40, 28:0.43, 29:0.45, 30:0.48, 31:0.52, 32:0.56, 33:0.61, 34:0.66, 35:0.71, 36:0.80, 37:0.90, 38:1.01, 39:1.13, 40:1.27, 41:1.39, 42:1.52, 43:1.67, 44:1.83, 45:2.01, 46:2.16, 47:2.33, 48:2.51, 49:2.69, 50:2.89, 51:3.12, 52:3.37, 53:3.64, 54:3.92, 55:4.22, 56:4.57, 57:4.94, 58:5.34, 59:5.77, 60:6.22, 61:6.77, 62:7.36, 63:7.99, 64:8.67, 65:9.39, 66:10.42, 67:11.53, 68:12.72, 69:14.02, 70:15.42, 71:16.92, 72:18.52, 73:20.21, 74:22.01, 75:23.90, 76:26.21, 77:28.73, 78:31.46, 79:34.42, 80:37.65 },
    female: { 15:0.08, 16:0.09, 17:0.10, 18:0.10, 19:0.11, 20:0.12, 21:0.13, 22:0.14, 23:0.15, 24:0.17, 25:0.18, 26:0.20, 27:0.22, 28:0.24, 29:0.26, 30:0.28, 31:0.30, 32:0.32, 33:0.34, 34:0.37, 35:0.39, 36:0.42, 37:0.45, 38:0.48, 39:0.52, 40:0.55, 41:0.59, 42:0.64, 43:0.69, 44:0.74, 45:0.85, 46:0.91, 47:0.98, 48:1.05, 49:1.13, 50:1.19, 51:1.29, 52:1.40, 53:1.52, 54:1.65, 55:1.80, 56:1.97, 57:2.15, 58:2.34, 59:2.55, 60:2.77, 61:3.09, 62:3.44, 63:3.82, 64:4.23, 65:4.67, 66:5.26, 67:5.89, 68:6.57, 69:7.31, 70:8.10, 71:9.03, 72:10.03, 73:11.12, 74:12.31, 75:13.61, 76:15.31, 77:17.18, 78:19.24, 79:21.50, 80:23.99 }
};

createApp({
    setup() {
        const gender = ref('female');
        const age = ref(40);
        const principal = ref(500);
        const fx = ref(32.5);
        const marketShock = ref(0); 
        const faceAmount = ref(1000);
        const nav = ref(9.0);
        const divPerUnit = ref(0.055);
        const withdrawRatio = ref(100);

        const smartFormat = (v) => v <= 0 ? '帳戶終止' : (v >= 10000 ? (v/10000).toFixed(2)+'萬' : Math.round(v).toLocaleString()+'元');
        const smartFormatUSD = (v) => Math.round(v).toLocaleString();
        const formatUnit = (v) => v.toLocaleString(undefined, {maximumFractionDigits: 1});

        const runSim = (isFull) => {
            const initialNav = nav.value;
            let currentNav = initialNav * (1 + (marketShock.value || 0) / 100);
            let currentUnits = (principal.value * 10000 / fx.value) / initialNav;
            let res = [];
            const isLarge = principal.value >= 1000;

            for (let y = 0; y <= 65; y++) {
                let curAge = Math.min(80, age.value + y);
                let mC=0, mA=0, mAdminVal=0, mU=0, mR=0;

                for(let m = 0; m < 12; m++) {
                    let monthlyB = (currentUnits * currentNav * fx.value) / 10000;
                    let factor = COI_TABLE[gender.value][curAge] || COI_TABLE[gender.value][80];
                    let nar = Math.max(0, faceAmount.value - monthlyB);
                    let fR = (y < 3) ? (isLarge ? 0.00155 : 0.0016) : (y === 3 ? (isLarge ? 0.001 : 0.0012) : 0);
                    
                    let mCOIFee = (nar * factor) / 10000;
                    let mPctFee = (monthlyB * fR);
                    let mAdmin = (monthlyB >= 300) ? 0 : 0.01;
                    
                    let mTotalFee = mCOIFee + mPctFee + mAdmin;
                    let mUnitFee = (mTotalFee * 10000 / fx.value) / currentNav;
                    
                    let mDiv = (currentUnits * divPerUnit.value * fx.value) / 10000;
                    let rAmt = mDiv * (1 - withdrawRatio.value / 100);
                    let rUnits = (rAmt * 10000 / fx.value) / initialNav;

                    mC=mCOIFee; mA=mPctFee; mAdminVal=mAdmin; mU=mUnitFee; mR=rUnits;
                    currentUnits += (rUnits - mUnitFee);
                }
                let endB = (currentUnits * currentNav * fx.value) / 10000;
                if (y % 5 === 0 && res.length < 13) {
                    res.push({ year: y, age: curAge, balance: endB, units: currentUnits, currentNav, coiFee: mC, adminFee: mA, maintenanceFee: mAdminVal, monthlyUnitFee: mU, monthlyReinvest: mR });
                }
                if (currentUnits <= 0) return isFull ? y : res;
            }
            return isFull ? 65 : res;
        };

        return { gender, age, principal, fx, marketShock, faceAmount, nav, divPerUnit, withdrawRatio, simulation: computed(()=>runSim(false)), survivalYears: computed(()=>runSim(true)), currentBalanceUSD: computed(()=>{ const r=runSim(false)[0]; return r?r.balance*10000/fx.value:0; }), smartFormat, smartFormatUSD, formatUnit };
    }
}).mount('#app');
</script>
</body>
</html>