<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業期權損益分析器</title>
    <!-- 引入 Tailwind CSS 與 Chart.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .pnl-red { color: #ef4444; } /* 獲利顯示紅 (符合台灣盤勢習慣) */
        .pnl-green { color: #22c55e; } /* 虧損顯示綠 */
        input:focus { outline: none; border-color: #6366f1; ring: 2px; ring-color: #6366f1; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <!-- 標題 -->
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-slate-800">期權損益分析器 <span class="text-indigo-600 text-lg">PRO</span></h1>
            <div class="text-sm text-slate-500 text-right">
                每點價值：<input id="pointValue" type="number" value="50" class="w-16 border rounded px-1 py-0.5 text-center"> 元
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 左側：部位設定區 -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-60H6"></path></svg>
                        新增部位
                    </h2>
                    <div class="space-y-4 text-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="posType" class="border rounded-lg p-2 bg-slate-50 cursor-pointer">
                                <option value="Call">買權 (Call)</option>
                                <option value="Put">賣權 (Put)</option>
                                <option value="Future">期貨 (Future)</option>
                            </select>
                            <select id="posAction" class="border rounded-lg p-2 bg-slate-50 cursor-pointer">
                                <option value="Buy">買進 (Long)</option>
                                <option value="Sell">賣出 (Short)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input id="posStrike" type="number" placeholder="履約價/成交價" class="border rounded-lg p-2 bg-slate-50">
                            <input id="posPrice" type="number" placeholder="權利金/點數" class="border rounded-lg p-2 bg-slate-50">
                        </div>
                        <input id="posQty" type="number" placeholder="口數" value="1" class="border rounded-lg p-2 bg-slate-50 w-full">
                        <button onclick="addPosition()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-200 shadow-md">
                            加入清單
                        </button>
                    </div>
                </div>

                <!-- 已持有部位列表 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-4">目前部位</h2>
                    <div id="positionList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 部位會顯示在這裡 -->
                        <p class="text-slate-400 text-sm italic">尚無部位</p>
                    </div>
                </div>
            </div>

            <!-- 右側：圖表與分析 -->
            <div class="lg:col-span-2 space-y-8">
                <!-- 圖表區 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">損益分析圖 (Payoff Diagram)</h2>
                        <div class="flex gap-2 text-xs">
                            分析範圍：<input id="rangeStart" type="number" value="17500" class="w-16 border rounded text-center"> ~ 
                            <input id="rangeEnd" type="number" value="18500" class="w-16 border rounded text-center">
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>

                <!-- 損益表格區 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-4 text-slate-800">試算明細表</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-100 text-slate-600 text-sm">
                                <tr>
                                    <th class="p-3 font-semibold border-b">結算價</th>
                                    <th class="p-3 font-semibold border-b">總部位損益 (TWD)</th>
                                    <th class="p-3 font-semibold border-b">總點數損益</th>
                                </tr>
                            </thead>
                            <tbody id="pnlTableBody" class="text-sm font-medium">
                                <!-- 數據動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let positions = [];
        let chartInstance = null;

        // 新增部位
        function addPosition() {
            const type = document.getElementById('posType').value;
            const action = document.getElementById('posAction').value;
            const strike = parseFloat(document.getElementById('posStrike').value);
            const price = parseFloat(document.getElementById('posPrice').value);
            const qty = parseInt(document.getElementById('posQty').value);

            if (isNaN(strike) || isNaN(price) || isNaN(qty)) {
                alert("請填寫正確數值");
                return;
            }

            positions.push({ id: Date.now(), type, action, strike, price, qty });
            updateUI();
        }

        // 刪除部位
        function deletePosition(id) {
            positions = positions.filter(p => p.id !== id);
            updateUI();
        }

        // 更新 UI (列表、圖表、表格)
        function updateUI() {
            renderPositionList();
            renderPnlData();
        }

        function renderPositionList() {
            const list = document.getElementById('positionList');
            if (positions.length === 0) {
                list.innerHTML = `<p class="text-slate-400 text-sm italic">尚無部位</p>`;
                return;
            }

            list.innerHTML = positions.map(p => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100 mb-2 group">
                    <div>
                        <span class="font-bold ${p.action === 'Buy' ? 'text-blue-600' : 'text-orange-600'}">${p.action === 'Buy' ? '買' : '賣'} ${p.type}</span>
                        <div class="text-xs text-slate-500">${p.strike} @ ${p.price} (${p.qty}口)</div>
                    </div>
                    <button onclick="deletePosition(${p.id})" class="text-slate-300 hover:text-red-500 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function calculatePnL(spotPrice) {
            let totalPnLPoints = 0;
            positions.forEach(p => {
                let pnl = 0;
                if (p.type === 'Call') {
                    const intrinsic = Math.max(0, spotPrice - p.strike);
                    pnl = (p.action === 'Buy') ? (intrinsic - p.price) : (p.price - intrinsic);
                } else if (p.type === 'Put') {
                    const intrinsic = Math.max(0, p.strike - spotPrice);
                    pnl = (p.action === 'Buy') ? (intrinsic - p.price) : (p.price - intrinsic);
                } else if (p.type === 'Future') {
                    pnl = (p.action === 'Buy') ? (spotPrice - p.strike) : (p.strike - spotPrice);
                }
                totalPnLPoints += pnl * p.qty;
            });
            return totalPnLPoints;
        }

        function renderPnlData() {
            const start = parseInt(document.getElementById('rangeStart').value);
            const end = parseInt(document.getElementById('rangeEnd').value);
            const pointValue = parseFloat(document.getElementById('pointValue').value);
            const step = Math.max(10, (end - start) / 20); // 動態級距

            const labels = [];
            const dataPnL = [];
            const tableBody = document.getElementById('pnlTableBody');
            tableBody.innerHTML = '';

            for (let spot = start; spot <= end; spot += step) {
                const pnlPoints = calculatePnL(spot);
                const pnlCash = pnlPoints * pointValue;
                
                labels.push(spot);
                dataPnL.push(pnlCash);

                // 產生表格列 (每 50 點顯示一行於表格，避免過長)
                if (spot % 50 === 0 || spot === start || spot === end) {
                    const colorClass = pnlCash >= 0 ? 'pnl-red' : 'pnl-green';
                    const row = `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="p-3 text-slate-600 font-mono">${spot}</td>
                            <td class="p-3 ${colorClass}">${pnlCash.toLocaleString()}</td>
                            <td class="p-3 ${colorClass}">${pnlPoints.toFixed(1)}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                }
            }

            updateChart(labels, dataPnL);
        }

        function updateChart(labels, dataPnL) {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '總損益 (TWD)',
                        data: dataPnL,
                        borderColor: '#6366f1',
                        borderWidth: 3,
                        pointRadius: 0,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
                            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            grid: { color: '#e2e8f0' },
                            ticks: { callback: (val) => val.toLocaleString() }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 監聽範圍輸入變更
        document.querySelectorAll('#rangeStart, #rangeEnd, #pointValue').forEach(el => {
            el.addEventListener('change', updateUI);
        });

        // 初始化一組示範部位 (Bull Call Spread)
        window.onload = () => {
            positions = [
                { id: 1, type: 'Call', action: 'Buy', strike: 18000, price: 120, qty: 1 },
                { id: 2, type: 'Call', action: 'Sell', strike: 18200, price: 50, qty: 1 }
            ];
            updateUI();
        };
    </script>
</body>
</html>