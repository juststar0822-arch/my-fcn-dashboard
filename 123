<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å…ƒå…ƒè‡´å¯Œç”Ÿå‘½åŠ›æ¨¡æ“¬å™¨ - æ•´åˆç²¾ç¢ºè²»ç‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background: #0f172a; color: #f1f5f9; font-family: sans-serif; }
        .input-group { background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; }
        input { background: #334155; border: 1px solid #475569; color: white; padding: 5px 10px; border-radius: 4px; width: 100%; }
        .ki-marker { color: #f87171; font-weight: bold; border: 1px solid #f87171; padding: 2px 4px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body class="p-5">
<div id="app" class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-blue-400 text-center">ğŸ›¡ï¸ å…ƒå¤§äººå£½ã€Œå…ƒå…ƒè‡´å¯Œã€ç”Ÿå‘½åŠ›ç²¾ç®— (ç”²å‹)</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-4">
            <div class="input-group">
                <h3 class="text-orange-400 font-bold mb-3 border-b border-gray-600">å®¢æˆ¶åŸºæœ¬è³‡æ–™</h3>
                <label class="text-xs text-gray-400">èµ·å§‹å¹´é½¡ (é™å¥³æ€§è©¦ç®—)</label>
                <input type="number" v-model="age" class="mb-3">
                
                <label class="text-xs text-gray-400">ç¸½è³‡ç”¢ (å°å¹£æŠ•å…¥)</label>
                <div class="flex items-center gap-2 mb-1">
                    <input type="number" v-model="principal">
                </div>
                <p class="text-[10px] text-gray-400">
                    ç´„åˆï¼šUSD {{ formatCurr(principal/32.5) }} / JPY {{ formatCurr(principal*4.5) }}
                </p>
            </div>

            <div class="input-group">
                <h3 class="text-blue-400 font-bold mb-3 border-b border-gray-600">ä¿å–®åƒæ•¸</h3>
                <label class="text-xs text-gray-400">åŸºæœ¬ä¿é¡ (NTD)</label>
                <input type="number" v-model="faceAmount" class="mb-3">
                
                <label class="text-xs text-gray-400">å¸‚å ´å³æ™‚ç›ˆè™§ (%)</label>
                <input type="number" v-model="marketChange" class="mb-3">
                
                <label class="text-xs text-gray-400">é…æ¯å†æŠ•è³‡æ¯”ä¾‹ (%)</label>
                <input type="range" min="0" max="100" v-model="reinvestRatio" class="w-full">
                <div class="text-right text-xs">{{ reinvestRatio }}% å›æµå¸³æˆ¶</div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-slate-800 p-6 rounded-xl border-l-4 border-blue-500 shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-300">é ä¼°ä¿éšœæ”¯æ’å¹´é™</span>
                    <span v-if="hasTouchedKi" class="ki-marker">âš ï¸ å¸³æˆ¶æ›¾è§¸åŠ KI (ä½æ°´ä½è­¦ç¤º)</span>
                </div>
                <div class="text-6xl font-black text-white mb-2">{{ survivalYears }} <span class="text-2xl">å¹´</span></div>
                <p class="text-gray-400">é è¨ˆåœ¨ <span class="text-white font-bold">{{ age + survivalYears }} æ­²</span> æ™‚ï¼Œå¸³æˆ¶åƒ¹å€¼å°‡ä¸è¶³ä»¥æ‰£é™¤å£½éšªæˆæœ¬ã€‚</p>
            </div>

            <div class="bg-slate-800 rounded-xl overflow-hidden border border-gray-700">
                <table class="w-full text-sm">
                    <thead class="bg-slate-700 text-gray-300">
                        <tr>
                            <th class="p-3">å¹´é½¡</th>
                            <th class="p-3 text-right">å¸³æˆ¶é¤˜é¡ (å°å¹£)</th>
                            <th class="p-3 text-right">å£½éšªä¿‚æ•¸ (åœ–è¡¨å€¼)</th>
                            <th class="p-3 text-right">æ¯æœˆå£½éšªæˆæœ¬</th>
                            <th class="p-3 text-right">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="row in simulation" :key="row.age" class="border-b border-gray-700 hover:bg-slate-700/50">
                            <td class="p-3 text-center">{{ row.age }} æ­²</td>
                            <td class="p-3 text-right">{{ formatNum(row.balance) }}</td>
                            <td class="p-3 text-right text-yellow-500">{{ row.coiFactor }}</td>
                            <td class="p-3 text-right text-red-400">{{ formatNum(row.monthlyCOI) }}</td>
                            <td class="p-3 text-center">
                                <span v-if="row.isKi" class="text-red-500 text-[10px] font-bold">è§¸åŠ KI</span>
                                <span v-else class="text-green-500 text-xs">æ­£å¸¸</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

// æ•´åˆ IMG_3339.jpg ä¸­çš„å¥³æ€§è²»ç‡è¡¨
const FEMALE_COI_TABLE = {
    40: 0.55, 41: 0.59, 42: 0.64, 43: 0.69, 44: 0.74, 45: 0.85, 46: 0.91, 47: 0.98, 48: 1.05, 49: 1.13,
    50: 1.19, 55: 1.80, 60: 2.77, 65: 4.67, 70: 8.10, 75: 13.61, 80: 23.99, 85: 41.28, 90: 80.42
};

createApp({
    setup() {
        const age = ref(40);
        const principal = ref(500000);
        const faceAmount = ref(10000000);
        const marketChange = ref(-30);
        const reinvestRatio = ref(0);
        const hasTouchedKi = ref(false);

        const formatNum = (v) => Math.round(v).toLocaleString();
        const formatCurr = (v) => v.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

        const simulation = computed(() => {
            let results = [];
            let currentBalance = principal.value * (1 + marketChange.value / 100);
            let currentAge = age.value;
            hasTouchedKi.value = false;

            for (let i = 0; i <= 60; i++) {
                let checkAge = currentAge + i;
                if (checkAge > 100 || currentBalance <= 0) break;

                // å–å¾—å°æ‡‰å¹´é½¡è²»ç‡ (è‹¥ç„¡ç²¾ç¢ºå€¼å‰‡ç·šæ€§æ¨ç®—)
                let factor = FEMALE_COI_TABLE[checkAge] || 
                             FEMALE_COI_TABLE[Object.keys(FEMALE_COI_TABLE).reverse().find(a => a <= checkAge)] * Math.pow(1.08, (checkAge % 5));

                let nar = Math.max(0, faceAmount.value - currentBalance);
                let monthlyCOI = (nar / 10000) * factor;
                let otherFees = (currentBalance * 0.0016) + 100;
                
                // é…æ¯å›æµè¨ˆç®—
                let monthlyDiv = (currentBalance * 0.073 / 12);
                let netFlow = (monthlyDiv * reinvestRatio.value / 100) - (monthlyCOI + otherFees);

                let isKiThisYear = currentBalance < (principal.value * 0.5);
                if (isKiThisYear) hasTouchedKi.value = true; // æ°¸ä¹…æ¨™è¨˜è§¸åŠ KI

                if (i % 5 === 0 || i < 5) {
                    results.push({ age: checkAge, balance: currentBalance, coiFactor: factor.toFixed(2), monthlyCOI, isKi: isKiThisYear });
                }

                currentBalance += (netFlow * 12);
            }
            return results;
        });

        const survivalYears = computed(() => {
            let b = principal.value * (1 + marketChange.value / 100);
            for (let y = 0; y < 60; y++) {
                let ageIdx = age.value + y;
                let f = FEMALE_COI_TABLE[ageIdx] || FEMALE_COI_TABLE[Object.keys(FEMALE_COI_TABLE).reverse().find(a => a <= ageIdx)] * 1.1;
                let monthlyCost = ((faceAmount.value - b) / 10000 * f) + (b * 0.0016) + 100;
                b = b - (monthlyCost * 12) + (b * 0.073 * reinvestRatio.value / 100);
                if (b <= 0) return y;
            }
            return 60;
        });

        return { age, principal, faceAmount, marketChange, reinvestRatio, simulation, survivalYears, formatNum, formatCurr, hasTouchedKi };
    }
}).mount('#app');
</script>
</body>
</html>