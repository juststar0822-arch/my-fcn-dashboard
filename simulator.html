<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN 專業詢價模擬引擎 v3.1</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #f8fafc; color: #1e293b; font-family: 'Inter', "Microsoft JhengHei", sans-serif; }
        .bank-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .input-light { background: #f1f5f9; border: 1.5px solid #e2e8f0; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; }
        .input-light:focus { border-color: #3b82f6; background: white; outline: none; }
        .btn-navy { background: #1e293b; color: white; font-weight: 800; transition: 0.3s; }
        .result-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-md mx-auto">
        
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl font-black italic text-slate-800 tracking-tighter uppercase">FCN Quote</h1>
                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Simulator Professional v3.1</p>
            </div>
            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold">LIVE DATA</span>
        </div>

        <!-- 1. 設定面板 -->
        <div class="bank-card p-6 mb-6">
            <div class="space-y-5">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-black text-slate-500 uppercase">連結標的 (Ticker)</label>
                        <div class="flex gap-2">
                            <button @click="form.market = 'US'" :class="['text-[10px] px-2 py-1 rounded font-bold', form.market==='US'?'bg-slate-800 text-white':'bg-slate-100 text-slate-400']">US 美股</button>
                            <button @click="form.market = 'JP'" :class="['text-[10px] px-2 py-1 rounded font-bold', form.market==='JP'?'bg-slate-800 text-white':'bg-slate-100 text-slate-400']">JP 日股</button>
                        </div>
                    </div>
                    <input v-model="form.tickers" placeholder="例如: NVDA,TSLA,AMD" class="input-light text-center text-lg uppercase tracking-wider">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase">天期 (Months)</label><input type="number" v-model="form.tenor" class="input-light"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase">UF% (Upfront Fee)</label><input type="number" v-model="form.margin" step="0.1" class="input-light text-blue-600"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase">Strike (%)</label><input type="number" v-model="form.strike" class="input-light"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase">KI (%)</label><input type="number" v-model="form.ki" class="input-light"></div>
                </div>

                <button @click="simulate" :disabled="isSyncing" class="w-full btn-navy py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3">
                    <i v-if="isSyncing" class="fa-solid fa-spinner animate-spin"></i>
                    {{ isSyncing ? '正在串接市場數據...' : '進行即時模擬詢價' }}
                </button>
            </div>
        </div>

        <!-- 2. 結果面板 -->
        <div v-if="result" class="result-gradient rounded-[2.5rem] p-8 text-white shadow-2xl mb-8 fade-in">
            <div class="flex justify-between items-center opacity-60">
                <p class="text-[10px] font-bold uppercase tracking-widest">Estimated Coupon</p>
                <p class="text-[10px] font-bold italic">{{ result.date }}</p>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
                <span class="text-7xl font-black italic tracking-tighter text-yellow-400">{{ result.coupon }}</span>
                <span class="text-2xl font-bold opacity-80">%</span>
            </div>
            
            <div class="mt-8 pt-6 border-t border-white/10">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <p class="text-[10px] font-bold text-white/40 uppercase">Worst-of Vol (IV)</p>
                        <p class="text-xl font-black italic">{{ result.maxVol }}%</p>
                        <p class="text-[9px] font-bold text-red-300 mt-1 uppercase">{{ result.worstTicker }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-white/40 uppercase">Market Base (Rf)</p>
                        <p class="text-xl font-black italic">{{ result.rf }}%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 標的明細 (含補完之中文名稱) -->
        <div v-if="stockDetails.length > 0" class="bank-card p-6 mb-8">
            <h3 class="text-xs font-black text-slate-800 mb-4 uppercase tracking-widest">市場標的狀態</h3>
            <div class="space-y-4">
                <div v-for="s in stockDetails" class="flex justify-between items-center border-b border-slate-50 pb-3">
                    <div class="flex-1">
                        <p class="text-sm font-black text-slate-800">{{ s.symbol.replace('.T','') }}</p>
                        <p class="text-[10px] text-slate-400 font-bold">{{ s.name }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-black text-slate-800">{{ s.hv.toFixed(1) }}%</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Vol</p>
                    </div>
                </div>
            </div>
        </div>

        <p class="text-center text-[11px] font-bold text-slate-400 italic px-4 pb-20">
            ※ 模擬引擎 v3.1：採用非線性衰減模型 (Non-linear Decay Model)<br>
            實際配息以成交為準，本數據僅供詢價參考。
        </p>

    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {
            'TSM':'台積電','NVDA':'輝達','TSLA':'特斯拉','AAPL':'蘋果','MSFT':'微軟','AMZN':'亞馬遜','GOOG':'谷歌','META':'臉書','AMD':'超微','MU':'美光','AVGO':'博通','NFLX':'網飛','PLTR':'帕蘭提爾','ORCL':'甲骨文','SMCI':'美超微','DELL':'戴爾','ARM':'安謀','OKLO':'Oklo','BRK.B':'波克夏',
            '6146.T':'Disco','6501.T':'日立','7011.T':'三菱重工','6857.T':'愛德萬','7012.T':'川崎重工','7013.T':'IHI重工','7974.T':'任天堂','8035.T':'東京威力','5803.T':'藤倉電子','8697.T':'日本交易所','8002.T':'丸紅'
        };

        createApp({
            data() {
                return {
                    isSyncing: false,
                    result: null,
                    stockDetails: [],
                    form: { market: 'US', tickers: 'NVDA,TSLA,AMD', tenor: 6, strike: 75, ki: 55, margin: 1.5 }
                }
            },
            methods: {
                async simulate() {
                    let tickerList = this.form.tickers.split(',').map(t => t.trim().toUpperCase()).filter(t => t !== '');
                    if (tickerList.length === 0) return;

                    this.isSyncing = true;
                    this.result = null;
                    this.stockDetails = [];
                    if(this.form.market === 'JP') tickerList = tickerList.map(t => t.endsWith('.T') ? t : t + '.T');

                    try {
                        let maxHV = 0;
                        let worstTicker = '';
                        let rf = this.form.market === 'US' ? 4.8 : 0.8;

                        for (let t of tickerList) {
                            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/'+t+'?range=1mo&interval=1d')}`);
                            const json = JSON.parse((await res.json()).contents);
                            const quote = json.chart.result[0];
                            const prices = quote.indicators.quote[0].close.filter(p => p != null);
                            
                            let logReturns = [];
                            for(let i=1; i<prices.length; i++) logReturns.push(Math.log(prices[i]/prices[i-1]));
                            const stdDev = Math.sqrt(logReturns.map(x => Math.pow(x, 2)).reduce((a,b)=>a+b, 0) / logReturns.length);
                            const hv = stdDev * Math.sqrt(252) * 100;

                            this.stockDetails.push({ symbol: t, name: stockNames[t] || t.replace('.T',''), hv: hv });
                            if(hv > maxHV) { maxHV = hv; worstTicker = t; }
                        }

                        // --- v3.1 非線性定價引擎 ---
                        // 1. 基本波動率利潤 (與波動率正相關)
                        let volPremium = maxHV * 0.85;

                        // 2. 保護縮減因子 (Strike/KI 越低，利潤衰減越快，但不會變負)
                        // 使用 Power Function 模擬選擇權 Delta 變化
                        let strikeFactor = Math.pow(this.form.strike / 100, 3.5); 
                        let kiFactor = Math.pow(this.form.ki / 100, 0.5); 
                        if(this.form.ki == 0) kiFactor = 0.4; // 無 KI 視為極高保護

                        // 3. 資產數量溢價 (Worst-of 邏輯)
                        let assetMultiplier = 1 + (tickerList.length - 1) * 0.15;

                        // 4. 最終計算
                        let estimatedCoupon = rf + (volPremium * strikeFactor * kiFactor * assetMultiplier) - this.form.margin;
                        
                        // 確保利率不為負值，最低給予基準利率
                        if(estimatedCoupon < rf) estimatedCoupon = rf;

                        this.result = {
                            coupon: estimatedCoupon.toFixed(2),
                            maxVol: maxHV.toFixed(1),
                            worstTicker: worstTicker.replace('.T', ''),
                            rf: rf,
                            date: new Date().toLocaleTimeString()
                        };
                    } catch (e) {
                        alert('詢價失敗，請檢查代碼。');
                    } finally {
                        this.isSyncing = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
