<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN ç®¡ç†ç³»çµ± v61.Final</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f1f5f9; color: #1e293b; font-family: -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif; }
        .fcn-card { background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .nav-header { background: #ffffff; padding: 10px; border-radius: 30px; display: flex; gap: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; }
        .nav-btn { padding: 10px 20px; border-radius: 20px; font-weight: 700; color: #64748b; transition: 0.3s; white-space: nowrap; font-size: 14px; }
        .nav-btn.active { background: #1e2937; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 12px; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .stock-tag { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 12px; }
        .tag-ki { background: #fee2e2; color: #ef4444; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        .tag-ko { background: #d1fae5; color: #059669; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        .tag-soon { background: #fef3c7; color: #d97706; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- ç™»å…¥é é¢ -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                <h2 class="text-2xl font-black mb-6">FCN ç®¡ç†ç³»çµ± v61</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full bg-gray-100 border-none p-4 rounded-xl text-center text-2xl mb-4 outline-none">
                <button @click="login" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg">ç™»å…¥ç³»çµ±</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <!-- å°è¦½åˆ— -->
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">åˆ†è¡Œæ¦‚æ³</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">å®¢æˆ¶åˆ—è¡¨</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦ä¸­å¿ƒ</button>
                <div class="ml-auto flex items-center pr-2">
                    <i @click="loadCSVData" class="fa-solid fa-arrows-rotate text-blue-500 cursor-pointer" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- åˆ†è¡Œæ¦‚æ³ -->
            <div v-if="view === 'branch'" class="grid grid-cols-1 gap-4">
                <div class="fcn-card bg-slate-800 text-white border-none">
                    <div class="text-sm opacity-70 mb-1">Total JPY Portfolio</div>
                    <div class="text-4xl font-black italic">Â¥ {{ formatNum(totalJPY) }} <span class="text-lg">è¬</span></div>
                </div>
                <div class="fcn-card bg-blue-600 text-white border-none">
                    <div class="text-sm opacity-70 mb-1">Total USD Portfolio</div>
                    <div class="text-4xl font-black italic">$ {{ formatNum(totalUSD) }} <span class="text-lg">è¬</span></div>
                </div>
            </div>

            <!-- é è­¦ä¸­å¿ƒ -->
            <div v-if="view === 'alerts'" class="space-y-4">
                <div class="flex bg-white rounded-xl shadow-sm mb-4 border border-gray-200">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">è§¸åŠKI ({{kiList.length}})</button>
                    <button @click="alertTab = 'soon'" :class="['risk-tab', alertTab === 'soon' ? 'active' : '']">å³å°‡å‡ºå ´ ({{soonList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">å·²å‡ºå ´ ({{exitList.length}})</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn" :prices="priceMap"></client-card>
            </div>

            <!-- å®¢æˆ¶åˆ—è¡¨ -->
            <div v-if="view === 'client'" class="space-y-4">
                <input v-model="search" type="text" placeholder="ğŸ” æœå°‹å®¢æˆ¶å§“åæˆ–æ¡ˆè™Ÿ..." class="w-full p-4 rounded-2xl bg-white shadow-sm font-bold border-none outline-none">
                <client-card v-for="item in filteredClients" :item="item" :key="item.sn" :prices="priceMap"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp, reactive } = Vue;

        const ClientCard = {
            props: ['item', 'prices'],
            template: `
                <div class="fcn-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-[10px] font-black text-gray-400 mb-1">{{ item.sn }} | {{ item.sales }}</div>
                            <h3 class="text-2xl font-black text-slate-800">{{ item.client }}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-blue-600 italic">
                                {{ item.currency==='JPY'?'Â¥':'$' }} {{ item.amount }}è¬
                            </div>
                            <div class="text-[10px] font-bold text-gray-400">å¹´åŒ– {{ item.coupon }}%</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-black text-blue-600">{{ s.code }}</span>
                                <span class="text-xs font-bold" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</span>
                            </div>
                            <div class="text-lg font-black mb-2">{{ prices[s.code] || '---' }}</div>
                            <div class="flex flex-wrap gap-1">
                                <span v-if="isKI(item, s)" class="tag-ki">KI</span>
                                <span v-if="isKO(item, s)" class="tag-ko">KO</span>
                                <span v-if="isSoon(item, s)" class="tag-soon">3%å…§KO</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-[10px] font-bold text-gray-400 border-t pt-3">
                        <div>ä¸‹å–®æ—¥: {{ item.date }}</div>
                        <div>åˆ°æœŸæ—¥: <span class="text-blue-500">{{ item.expiry }}</span></div>
                    </div>
                </div>
            `,
            methods: {
                getPerf(item, s) {
                    const cur = this.prices[s.code];
                    return cur ? ((cur / s.init) * 100).toFixed(2) : '---';
                },
                perfColor(item, s) {
                    const p = parseFloat(this.getPerf(item, s));
                    if (isNaN(p)) return 'text-gray-400';
                    return p >= item.koP ? 'text-emerald-500' : (p <= item.kiP ? 'text-rose-500' : 'text-gray-500');
                },
                isKI(item, s) { return parseFloat(this.getPerf(item, s)) <= item.kiP; },
                isKO(item, s) { return parseFloat(this.getPerf(item, s)) >= item.koP; },
                isSoon(item, s) {
                    const p = parseFloat(this.getPerf(item, s));
                    return p < item.koP && p >= (item.koP - 3);
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    isLoggedIn: false, inputPass: '', view: 'branch', alertTab: 'ki',
                    inventory: [], priceMap: {}, search: '', isSyncing: false
                }
            },
            computed: {
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((a, b) => a + b.amount, 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((a, b) => a + b.amount, 0); },
                kiList() { 
                    return this.inventory.filter(i => i.stocks.some(s => {
                        const p = (this.priceMap[s.code] / s.init) * 100;
                        return p <= i.kiP;
                    }));
                },
                exitList() {
                    return this.inventory.filter(i => i.stocks.every(s => {
                        const p = (this.priceMap[s.code] / s.init) * 100;
                        return p >= i.koP;
                    }));
                },
                soonList() {
                    return this.inventory.filter(i => i.stocks.some(s => {
                        const p = (this.priceMap[s.code] / s.init) * 100;
                        return p < i.koP && p >= (i.koP - 3);
                    }));
                },
                currentAlertList() {
                    if (this.alertTab === 'ki') return this.kiList;
                    if (this.alertTab === 'exit') return this.exitList;
                    if (this.alertTab === 'soon') return this.soonList;
                    return [];
                },
                filteredClients() {
                    const q = this.search.toLowerCase();
                    return this.inventory.filter(i => i.client.includes(q) || i.sn.toLowerCase().includes(q));
                }
            },
            methods: {
                login() { if (this.inputPass === '98388') this.isLoggedIn = true; },
                formatNum(n) { return n.toLocaleString(); },
                async loadCSVData() {
                    this.isSyncing = true;
                    Papa.parse("data.csv", {
                        download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                        complete: (results) => {
                            this.inventory = results.data.map(row => ({
                                ...row,
                                stocks: [
                                    { code: row.s1_code, init: row.s1_init },
                                    { code: row.s2_code, init: row.s2_init },
                                    { code: row.s3_code, init: row.s3_init },
                                    { code: row.s4_code, init: row.s4_init }
                                ].filter(s => s.code)
                            }));
                            this.fetchPrices();
                        }
                    });
                },
                async fetchPrices() {
                    // v61 ä½¿ç”¨ç°¡å–®çš„æ¨¡æ“¬æ•¸æ“šæˆ–æ‚¨å¯ä»¥æ›¿æ›ç‚ºå¯¦éš› API
                    const codes = [...new Set(this.inventory.flatMap(i => i.stocks.map(s => s.code)))];
                    codes.forEach(code => {
                        // é€™è£¡æ‡‰å‘¼å«å¯¦éš›åƒ¹æ ¼ API
                        this.priceMap[code] = (Math.random() * 50 + 150).toFixed(2); 
                    });
                    this.isSyncing = false;
                }
            },
            mounted() {
                this.loadCSVData();
            }
        }).mount('#app');
    </script>
</body>
</html>
