<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>上新莊分行 - FCN 管理系統 v54.Turbo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; -webkit-font-smoothing: antialiased; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 105px; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 16px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; white-space: nowrap; font-size: 13px; cursor: pointer; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px 14px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 11px; white-space: nowrap; cursor: pointer; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; background: rgba(37, 99, 235, 0.05); }
        .text-success { color: #10b981; font-weight: 900; }
        .text-danger { color: #ef4444; font-weight: 900; }
        .jpy-tag { color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-weight: 900; }
        .usd-tag { color: #2563eb; background: #eff6ff; padding: 2px 6px; border-radius: 6px; font-weight: 900; }
        .history-badge { font-size: 9px; padding: 1px 5px; border-radius: 5px; font-weight: 900; margin-top: 4px; display: inline-block; }
        .badge-ki { background: #fee2e2; color: #ef4444; }
        .badge-ko { background: #dcfce7; color: #16a34a; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- 登入、導航與預警中心結構與之前相同 -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center">
                <h2 class="text-2xl font-black mb-6 italic">上新莊管理系統</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Password" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl mb-6 outline-none focus:ring-2 ring-blue-500 font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black">LOGIN</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide text-slate-800">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">資產管理</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">按客戶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">按業務員</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">預警中心</button>
                <button @click="view = 'admin_login'" :class="['nav-btn', view.includes('admin') ? 'active' : '']"><i class="fa-solid fa-gear"></i></button>
                <div class="ml-auto flex items-center pr-3">
                    <i @click="fetchAllData" class="fa-solid fa-rotate text-blue-500 cursor-pointer text-lg" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- 預警分頁按鈕 -->
            <div v-if="view === 'alerts'" class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-x-auto scrollbar-hide border border-gray-100">
                <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">歷史KI({{kiList.length}})</button>
                <button @click="alertTab = 'pko'" :class="['risk-tab', alertTab === 'pko' ? 'active' : '']">歷史KO({{partKOList.length}})</button>
                <button @click="alertTab = 'nko'" :class="['risk-tab', alertTab === 'nko' ? 'active' : '']">即將KO({{nearKOList.length}})</button>
                <button @click="alertTab = 'exp'" :class="['risk-tab', alertTab === 'exp' ? 'active' : '']">到期({{expiringList.length}})</button>
            </div>

            <!-- 列表顯示區 -->
            <div class="space-y-4">
                <client-card v-for="item in displayList" :item="item" :key="item.sn + item.client"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'6146.T':'Disco','6501.T':'日立','7011.T':'三菱重工','6857.T':'愛德萬','7012.T':'川崎重工','7013.T':'IHI重工','7974.T':'任天堂','8035.T':'東京威力','5803.T':'藤倉電子','8697.T':'日本交易所','8002.T':'丸紅','NVDA':'輝達','TSLA':'特斯拉','TSM':'台積電','AMD':'超微','MU':'美光','ARM':'安謀','GOOG':'谷歌','AMZN':'亞馬遜','AVGO':'博通','MSFT':'微軟','META':'臉書','DELL':'戴爾','ORCL':'甲骨文','OKLO':'Oklo','PLTR':'帕蘭提爾','NFLX':'網飛','BRK.B':'波克夏'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card border border-gray-100 text-left">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-3xl font-black text-gray-800 italic">{{ item.client }}</h3>
                            <div class="flex items-center gap-1 mt-1 font-bold text-[10px] text-gray-400 uppercase">
                                {{ item.sn }} <span :class="[item.currency === 'JPY' ? 'jpy-tag' : 'usd-tag']">{{ item.currency }}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-1 rounded-lg font-black uppercase">票息: {{ item.coupon }}%</div>
                            <div class="text-[9px] text-gray-400 font-bold mt-1 uppercase">業務: {{ item.sales }}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                            <p class="text-[11px] font-black text-blue-500 uppercase">{{ s.code.replace('.T', '') }}</p>
                            <p class="text-xl font-black tracking-tighter">{{ formatPrice(s.current) }}</p>
                            <div class="text-[8px] font-bold text-gray-400 border-t border-gray-100 pt-1 mt-1">
                                <p>KO: {{ formatPrice(s.init * (item.koP/100)) }}</p>
                                <p>KI: {{ item.kiP > 0 ? formatPrice(s.init * (item.kiP/100)) : 'None' }}</p>
                            </div>
                            <p class="text-[11px] font-black mt-1" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</p>
                            <div v-if="s.histMin > 0 && ((s.histMin / s.init) * 100) <= item.kiP" class="history-badge badge-ki">！曾破 KI</div>
                            <div v-if="s.histMax > 0 && ((s.histMax / s.init) * 100) >= item.koP" class="history-badge badge-ko">！曾觸 KO</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t border-gray-100 pt-4 text-[11px] font-bold text-gray-500">
                        <div>下單: <span class="text-slate-900 italic">{{ item.date }}</span><br>到期: <span class="text-blue-500 italic">{{ item.expiry }}</span></div>
                        <div class="text-right">預估月息:<br><span class="text-emerald-600 font-black text-xl italic">{{ item.currency==='JPY'?'¥':'$' }}{{ formatNum(calcMonthly(item)) }}</span></div>
                    </div>
                </div>
            `,
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                formatPrice(n){ return n ? n.toFixed(2) : '---'; },
                calcMonthly(i){ return ((i.amount||0) * 10000 * (i.coupon/100)) / 12; },
                getPerf(i,s){ return s.current ? ((s.current/s.init)*100).toFixed(2) : '100.00'; },
                perfColor(i,s){
                    const p = parseFloat(this.getPerf(i,s));
                    if(p >= i.koP) return 'text-success';
                    if(p <= i.kiP) return 'text-danger';
                    return 'text-gray-400';
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki', selectedSales: '吳坤達'
                }
            },
            computed: {
                displayList() {
                    if (this.view === 'client') return this.inventory.filter(i => i.client.includes(this.search) || i.sn.includes(this.search));
                    if (this.view === 'sales') return this.inventory.filter(i => i.sales === this.selectedSales);
                    if (this.view === 'alerts') return this.currentAlertList;
                    return [];
                },
                kiList() { return this.inventory.filter(i => i.stocks.some(s => s.histMin > 0 && ((s.histMin/s.init)*100) <= i.kiP)); },
                partKOList() { return this.inventory.filter(i => i.stocks.some(s => s.histMax > 0 && ((s.histMax/s.init)*100) >= i.koP)); },
                nearKOList() { return this.inventory.filter(i => {
                    const lastStock = i.stocks.find(s => ((s.current/s.init)*100) < i.koP);
                    return lastStock && (lastStock.current / (lastStock.init * i.koP / 100)) >= 0.97;
                });},
                expiringList() {
                    const today = new Date();
                    return this.inventory.filter(i => {
                        const diff = (new Date(i.expiry) - today) / 86400000;
                        return diff >= 0 && diff <= 7;
                    });
                },
                currentAlertList() { 
                    const m = {ki:this.kiList, pko:this.partKOList, nko:this.nearKOList, exp:this.expiringList};
                    return m[this.alertTab] || [];
                }
            },
            methods: {
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; sessionStorage.setItem('fcn_auth', 'true'); this.loadCSVData(); } },
                async loadCSVData() {
                    this.isSyncing = true;
                    try {
                        const res = await fetch('data.csv?v=' + Date.now());
                        const text = await res.text();
                        Papa.parse(text, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (results) => {
                                this.inventory = results.data.map(row => {
                                    const stocks = [];
                                    for(let i=1; i<=4; i++) if(row[`s${i}_code`]) stocks.push({ code: row[`s${i}_code`], init: row[`s${i}_init`], current: 0, histMin: 999999, histMax: 0 });
                                    return { ...row, stocks };
                                });
                                this.fetchAllData();
                            }
                        });
                    } catch (e) { console.error("CSV Load Fail"); }
                },
                /**
                 * 極速核心：批次處理所有股票
                 */
                async fetchAllData() {
                    if (this.inventory.length === 0) return;
                    this.isSyncing = true;

                    // 1. 找出所有不重複股票代碼及其最早下單日
                    const symbolMap = {};
                    this.inventory.forEach(item => {
                        const ts = Math.floor(new Date(item.date).getTime() / 1000);
                        item.stocks.forEach(s => {
                            if (!symbolMap[s.code] || ts < symbolMap[s.code]) symbolMap[s.code] = ts;
                        });
                    });

                    const symbols = Object.keys(symbolMap);
                    const nowTs = Math.floor(Date.now() / 1000);

                    // 2. 併行請求 (每種股票只請求一次)
                    try {
                        await Promise.all(symbols.map(async (symbol) => {
                            try {
                                const startTs = symbolMap[symbol];
                                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startTs}&period2=${nowTs}&interval=1d`;
                                const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                                const data = await resp.json();
                                const json = JSON.parse(data.contents);
                                
                                const res = json.chart.result[0];
                                const quote = res.indicators.quote[0];
                                const highs = quote.high.filter(v => v != null);
                                const lows = quote.low.filter(v => v != null);
                                const closes = quote.close.filter(v => v != null);

                                const stats = {
                                    current: closes[closes.length - 1],
                                    min: Math.min(...lows),
                                    max: Math.max(...highs)
                                };

                                // 3. 將數據同步回 inventory 中所有對應的股票
                                this.inventory.forEach(item => {
                                    item.stocks.forEach(s => {
                                        if (s.code === symbol) {
                                            s.current = stats.current;
                                            s.histMin = stats.min;
                                            s.histMax = stats.max;
                                        }
                                    });
                                });
                            } catch (e) { console.warn("Fetch Fail: " + symbol); }
                        }));
                    } finally {
                        this.isSyncing = false;
                    }
                }
            },
            mounted() {
                if (sessionStorage.getItem('fcn_auth') === 'true') {
                    this.isLoggedIn = true;
                    this.loadCSVData();
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
