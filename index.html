<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN é›²ç«¯ç›£æ§ç³»çµ± v20</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", sans-serif; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 105px; }
        .nav-header { background: white; padding: 10px; border-radius: 40px; display: flex; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; }
        .nav-btn { padding: 10px 18px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.3s; white-space: nowrap; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 13px; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .lock-badge { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .currency-tag { font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 6px; margin-left: 6px; text-transform: uppercase; }
        .jpy-tag { background: #e0f2fe; color: #0369a1; }
        .usd-tag { background: #dcfce7; color: #15803d; }
        .text-success { color: #10b981; font-weight: 900; }
        .text-danger { color: #ef4444; font-weight: 900; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ever-ko-tag { background: #10b981 !important; color: white !important; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        
        <!-- 1. ç™»å…¥ä»‹é¢ -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[1000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-xl"><i class="fa-solid fa-lock text-2xl"></i></div>
                <h2 class="text-2xl font-black text-slate-800 mb-2 italic">ä¸Šæ–°èŠç®¡ç†ç³»çµ±</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl tracking-[0.4em] mb-6 outline-none focus:ring-2 ring-blue-500 font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-lg shadow-lg">é€²å…¥ç³»çµ±</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <!-- 2. å°èˆªåˆ— -->
            <div class="nav-header sticky top-4 z-50">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">ä¸Šæ–°èŠè³‡ç”¢ç®¡ç†</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">æŒ‰å®¢æˆ¶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">æŒ‰æ¥­å‹™å“¡</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦</button>
                
                <!-- ğŸš€ åŒ¯å…¥æŒ‰éˆ• -->
                <label class="flex items-center justify-center w-10 h-10 bg-blue-50 text-blue-600 rounded-full cursor-pointer hover:bg-blue-100 transition shadow-sm ml-2">
                    <i class="fa-solid fa-file-import"></i>
                    <input type="file" @change="importCSV" accept=".csv" class="hidden">
                </label>

                <div class="ml-auto flex items-center pr-3">
                    <i @click="fetchRealPrices" class="fa-solid fa-rotate text-gray-300 cursor-pointer" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- 3. é¦–é ï¼šåˆ†è¡Œç¸½è¦½ -->
            <div v-if="view === 'branch'" class="space-y-4 fade-in">
                <div v-if="inventory.length === 0" class="fcn-card text-center py-20">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-200 mb-4"></i>
                    <p class="font-bold text-gray-400 italic">ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹é»æ“Šä¸Šæ–¹è—è‰²æŒ‰éˆ•åŒ¯å…¥ CSV æª”æ¡ˆ</p>
                </div>
                <div v-else v-for="curr in ['JPY', 'USD']" :key="curr" class="fcn-card shadow-xl" :class="curr==='JPY'?'bg-slate-800 text-white border-none':'bg-blue-600 text-white border-none'">
                    <div class="flex justify-between items-start mb-4"><p class="text-xs font-black opacity-60 uppercase">{{ curr }} ç¸½åº«å­˜è¦æ¨¡</p><span class="bg-black/20 px-2 py-1 rounded text-[10px] font-black">{{ curr==='JPY'?countJPY:countUSD }} ç­†</span></div>
                    <div class="text-5xl font-black italic font-mono tracking-tighter">{{ curr==='JPY'?'Â¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} <span class="text-lg font-normal opacity-50">è¬</span></div>
                    <div class="mt-8 pt-4 border-t border-white/10 grid grid-cols-2 gap-4 text-xs font-bold italic">
                        <div><p class="opacity-50 uppercase tracking-widest text-[9px]">äº¤å‰²ä¸­ (å¾…çºŒä½œ)</p><p class="text-xl font-black">{{ curr==='JPY'?settlingJPY:settlingUSD }} ç­†</p></div>
                        <div class="text-right"><p class="opacity-50 uppercase tracking-widest text-[9px]">æœ¬æœˆé è¨ˆæ´¾æ¯</p><p class="text-xl font-black">{{ curr==='JPY'?'Â¥':'$' }}{{ formatNum(curr==='JPY'?monthlyJPY:monthlyUSD) }}</p></div>
                    </div>
                </div>
                <div v-if="inventory.length > 0" class="text-center"><button @click="clearMemory" class="text-[9px] text-gray-400 underline">æ¸…é™¤æ‰€æœ‰åŒ¯å…¥è³‡æ–™</button></div>
            </div>

            <!-- 4. é è­¦ä¸­å¿ƒ -->
            <div v-if="view === 'alerts'" class="space-y-4 fade-in">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-hidden">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">å·²è§¸åŠ KI ({{kiList.length}})</button>
                    <button @click="alertTab = 'ko'" :class="['risk-tab', alertTab === 'ko' ? 'active' : '']">æ›¾é”æ¨™ KO ({{anyKOList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">å³å°‡å‡ºå ´ ({{exitList.length}})</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.id + item.client"></client-card>
            </div>

            <!-- 5. å®¢æˆ¶/æ¥­å‹™å“¡åˆ—è¡¨ (è¤‡ç”¨çµ„ä»¶) -->
            <div v-if="view === 'client' || view === 'sales'" class="space-y-4 fade-in">
                <div v-if="view === 'sales'" class="px-2 mb-4">
                    <select v-model="selectedSales" class="w-full p-4 rounded-3xl bg-white border-none shadow-sm font-black text-blue-600 outline-none"><option v-for="s in salesSummary" :value="s.name">{{ s.name }} ({{ s.count }} ç­†)</option></select>
                </div>
                <div v-if="view === 'client'" class="px-2 mb-2"><input v-model="search" type="text" placeholder="ğŸ” æœå°‹å®¢æˆ¶å§“åæˆ–ä»£ç¢¼" class="w-full p-4 rounded-3xl bg-white shadow-sm font-bold outline-none"></div>
                <client-card v-for="item in filteredList" :item="item" :key="item.id + item.client" @go="goClient"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue
        const stockNames = {'6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','TSM':'å°ç©é›»','AMD':'è¶…å¾®','MU':'ç¾å…‰','ARM':'å®‰è¬€','GOOG':'è°·æ­Œ','AMZN':'äºé¦¬éœ','AVGO':'åšé€š','MSFT':'å¾®è»Ÿ','META':'è‡‰æ›¸','DELL':'æˆ´çˆ¾','ORCL':'ç”²éª¨æ–‡','OKLO':'Oklo','PLTR':'å¸•è˜­æçˆ¾','NFLX':'ç¶²é£›','BRK.B':'æ³¢å…‹å¤'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card fade-in">
                    <div v-if="isLocked(item)" class="absolute right-6 top-4"><span class="lock-badge"><i class="fa-solid fa-lock mr-1"></i>ä¿è­‰é ˜æ¯é–å®šæœŸ</span></div>
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-3xl font-black text-gray-800 tracking-tighter italic">{{ item.client }}</h3>
                            <div class="flex items-center gap-1 mt-1 font-bold text-[10px] text-gray-400 uppercase tracking-widest">{{ item.sn }} <span :class="['currency-tag', item.currency === 'JPY' ? 'jpy-tag' : 'usd-tag']">{{ item.currency }}</span></div>
                        </div>
                        <div class="text-right"><div class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-1 rounded-lg font-black italic">é…æ¯: {{ item.coupon }}%</div><div class="text-[9px] text-gray-400 font-bold mt-1 uppercase">æ¥­å‹™: {{ item.sales }}</div></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag" :class="{'ever-ko-tag': s.current >= (s.init * item.koP / 100)}">
                            <p class="text-[11px] font-black leading-none" :class="s.current >= (s.init * item.koP / 100) ? 'text-white' : 'text-blue-500'">{{ s.code.replace('.T', '') }}</p>
                            <p class="text-[9px] font-bold mb-1 opacity-60">{{ getStockName(s.code) }}</p>
                            <p class="text-xl font-black leading-none my-1 tracking-tighter" :class="s.current >= (s.init * item.koP / 100) ? 'text-white' : 'text-gray-800'">{{ formatNum(s.current) }}</p>
                            <p class="text-[11px] font-black" :class="s.current >= (s.init * item.koP / 100) ? 'text-white' : perfColor(item, s)">{{ getPerf(item, s) }}%</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t border-gray-100 pt-5 text-[11px] font-bold text-gray-500">
                        <div class="space-y-1.5"><p>åº«å­˜é‡‘é¡: <span class="text-gray-900 font-black italic">{{ item.amount === 0 ? 'äº¤å‰²ä¸­' : formatNum(item.amount) + ' è¬' }}</span></p><p>åˆ°æœŸæ—¥æœŸ: <span class="text-blue-500 underline underline-offset-2 italic font-black">{{ item.expiry }}</span></p></div>
                        <div class="text-right space-y-1.5"><p>æœˆåˆ©ç‡: {{ (item.coupon/12).toFixed(4) }}%</p><p>æœˆé ˜æ¯: <span class="text-emerald-600 font-black text-xl italic">{{ item.currency==='JPY'?'Â¥':'$' }}{{ formatNum(calcMonthly(item)) }}</span></p></div>
                    </div>
                    <div class="mt-4 flex justify-between text-[9px] font-black bg-gray-50 p-2.5 rounded-xl text-gray-400 uppercase italic"><span>KO: {{item.koP}}%</span><span>PUT: {{item.strikeP}}%</span><span :class="{'text-danger underline':hasKI(item)}">KI: {{item.kiP}}%</span><span>Start: {{item.koStart}}</span></div>
                </div>
            `,
            methods: {
                formatNum(n){ return Math.floor(n).toLocaleString(); },
                calcMonthly(i){ return (i.amount * 10000 * i.coupon / 100) / 12; },
                getStockName(c){ return stockNames[c] || stockNames[c+'.T'] || ''; },
                getPerf(i,s){ return ((s.current / s.init) * 100).toFixed(2); },
                perfColor(i,s){ const p=parseFloat(this.getPerf(i,s)); if(p>=i.koP) return 'text-success'; if(p<=i.kiP) return 'text-danger'; return 'text-gray-600'; },
                hasKI(i){ 
                    if(i.type==='EKI' && parseFloat(this.getPerf(i, i.stocks[0])) > i.kiP) return false;
                    return i.kiP>0 && i.stocks.some(s => parseFloat(this.getPerf(i, s)) <= i.kiP); 
                },
                isLocked(i){ return new Date() < new Date(i.koStart); }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', alertTab: 'ki', selectedSales: '', search: '', lastTime: '-', isSyncing: false,
                    isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: []
                }
            },
            computed: {
                countJPY() { return this.inventory.filter(i => i.currency === 'JPY').length; },
                countUSD() { return this.inventory.filter(i => i.currency === 'USD').length; },
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + i.amount, 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + i.amount, 0); },
                settlingJPY() { return this.inventory.filter(i => i.currency === 'JPY' && i.amount === 0).length; },
                settlingUSD() { return this.inventory.filter(i => i.currency === 'USD' && i.amount === 0).length; },
                monthlyJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + ((i.amount * 10000 * i.coupon / 100) / 12), 0); },
                monthlyUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + ((i.amount * 10000 * i.coupon / 100) / 12), 0); },
                salesSummary() {
                    const map = {}; this.inventory.forEach(i => map[i.sales] = (map[i.sales] || 0) + 1);
                    return Object.keys(map).map(k => ({ name: k, count: map[k] })).sort((a,b) => b.count - a.count);
                },
                kiList() { return this.inventory.filter(i => this.hasBreachedKI(i)); },
                anyKOList() { return this.inventory.filter(i => i.stocks.some(s => ((s.current/s.init)*100) >= i.koP) && !this.isExit(i)); },
                exitList() { return this.inventory.filter(i => this.isExit(i)); },
                currentAlertList() { return this.alertTab==='ki'?this.kiList:(this.alertTab==='ko'?this.anyKOList:this.exitList); },
                alertCount() { return this.kiList.length + this.exitList.length; },
                filteredList() {
                    let list = this.inventory;
                    if(this.view === 'sales') list = list.filter(i => i.sales === this.selectedSales);
                    if(this.search) list = list.filter(i => i.client.includes(this.search) || i.sn.includes(this.search));
                    return list;
                }
            },
            methods: {
                formatNum(n){ return Math.floor(n).toLocaleString(); },
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; this.loadStorage(); } },
                hasBreachedKI(i){ 
                    if(i.type==='EKI' && (i.stocks[0].current/i.stocks[0].init*100) > i.kiP) return false;
                    return i.kiP>0 && i.stocks.some(s => (s.current/s.init*100) <= i.kiP); 
                },
                isExit(i){
                    return (new Date() >= new Date(i.koStart)) && i.stocks.every(s => (s.current/s.init*100) >= i.koP);
                },
                goClient(name) { this.search = name; this.view = 'client'; },
                importCSV(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        const result = [];
                        for(let i = 1; i < lines.length; i++) {
                            const cols = lines[i].split(',');
                            if(cols.length < 13) continue;
                            const stocks = cols[11].split(';').map(s => {
                                const [code, init] = s.split(':');
                                return { code, init: parseFloat(init), current: parseFloat(init) };
                            });
                            result.push({
                                client: cols[0], sn: cols[1], currency: cols[2], amount: parseFloat(cols[3]),
                                date: cols[4], koStart: cols[5], expiry: cols[6], coupon: parseFloat(cols[7]),
                                koP: parseFloat(cols[8]), strikeP: parseFloat(cols[9]), kiP: parseFloat(cols[10]),
                                stocks: stocks, sales: cols[12], type: cols[13] || 'AKI'
                            });
                        }
                        this.inventory = result;
                        localStorage.setItem('fcn_v20_data', JSON.stringify(result));
                        this.fetchRealPrices();
                    };
                    reader.readAsText(file);
                },
                loadStorage() {
                    const saved = localStorage.getItem('fcn_v20_data');
                    if(saved) { this.inventory = JSON.parse(saved); this.fetchRealPrices(); }
                },
                clearMemory() { localStorage.removeItem('fcn_v20_data'); this.inventory = []; },
                async fetchRealPrices() {
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => i.stocks.map(s => s.code)))];
                    if (symbols.length === 0) { this.isSyncing = false; return; }
                    try {
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}`;
                        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await response.json();
                        const res = JSON.parse(data.contents);
                        if (res.quoteResponse?.result) {
                            res.quoteResponse.result.forEach(q => {
                                this.inventory.forEach(item => {
                                    item.stocks.forEach(s => { if(s.code === q.symbol || s.code+'.T' === q.symbol) s.current = q.regularMarketPrice; });
                                });
                            });
                            this.lastTime = new Date().toLocaleTimeString();
                        }
                    } catch (e) { console.error(e); }
                    finally { this.isSyncing = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
