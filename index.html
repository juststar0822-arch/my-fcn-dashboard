<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN ç®¡ç†ç³»çµ± v62.5</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", sans-serif; -webkit-font-smoothing: antialiased; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 105px; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 16px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; white-space: nowrap; font-size: 13px; cursor: pointer; }
        .nav-btn.active { background: #1f2937; color: white; }
        .text-success { color: #10b981; font-weight: 900; }
        .text-danger { color: #ef4444; font-weight: 900; }
        .jpy-tag { color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-weight: 900; }
        .usd-tag { color: #2563eb; background: #eff6ff; padding: 2px 6px; border-radius: 6px; font-weight: 900; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <h2 class="text-2xl font-black mb-6 italic">ä¸Šæ–°èŠç®¡ç†ç³»çµ±</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Password" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl mb-6 outline-none font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black">LOGIN</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">è³‡ç”¢ç®¡ç†</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">æŒ‰å®¢æˆ¶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">æŒ‰æ¥­å‹™å“¡</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦ä¸­å¿ƒ</button>
                <div class="ml-auto flex items-center pr-3">
                    <i @click="fetchRealPrices" class="fa-solid fa-rotate text-blue-500 cursor-pointer text-lg" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <div v-if="view === 'branch'" class="space-y-4">
                <div v-for="curr in ['JPY', 'USD']" :key="curr" class="fcn-card shadow-xl text-white border-none" :class="curr==='JPY'?'bg-slate-800':'bg-blue-600'">
                    <div class="flex justify-between mb-4 opacity-80 text-xs font-black uppercase">
                        <span>{{ curr === 'JPY' ? 'æ—¥å¹£å¸³æˆ¶' : 'ç¾å…ƒå¸³æˆ¶' }} ç¸½åº«å­˜è³‡ç”¢</span>
                        <span>{{ curr==='JPY'?countJPY:countUSD }}ç­†æ¡ˆä»¶</span>
                    </div>
                    <div class="text-5xl font-black italic font-mono">
                        {{ curr==='JPY'?'Â¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} 
                        <span class="text-lg font-normal opacity-80 uppercase ml-2">{{ curr === 'JPY' ? 'æ—¥å¹£' : 'ç¾å…ƒ' }}</span>
                        <span class="text-sm font-normal opacity-50 uppercase ml-1">è¬</span>
                    </div>
                </div>
            </div>

            <div v-if="view === 'client'" class="space-y-4">
                <input v-model="search" type="text" placeholder="ğŸ” æœå°‹å®¢æˆ¶å§“åæˆ–æ¡ˆè™Ÿ" class="w-full p-4 rounded-3xl bg-white shadow-sm font-bold outline-none">
                <client-card v-for="item in clientFilteredList" :item="item" :key="item.sn + item.client"></client-card>
            </div>

            <div v-if="view === 'alerts'" class="space-y-4">
                <client-card v-for="item in kiList" :item="item" :key="item.sn"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','TSM':'å°ç©é›»','AMD':'è¶…å¾®','MU':'ç¾å…‰','ARM':'å®‰è¬€','GOOG':'è°·æ­Œ','AMZN':'äºé¦¬éœ','AVGO':'åšé€š','MSFT':'å¾®è»Ÿ','META':'è‡‰æ›¸','DELL':'æˆ´çˆ¾','ORCL':'ç”²éª¨æ–‡','OKLO':'Oklo','PLTR':'å¸•è˜­æçˆ¾','NFLX':'ç¶²é£›','BRK.B':'æ³¢å…‹å¤'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card text-left">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-3xl font-black text-gray-800 italic">{{ item.client }}</h3>
                            <div class="flex items-center gap-1 mt-2 font-bold text-[10px] text-gray-400">
                                {{ item.sn }} <span :class="[item.currency === 'JPY' ? 'jpy-tag' : 'usd-tag']">{{ item.currency }}</span>
                                <span v-if="isTouchedKI(item)" class="bg-red-500 text-white text-[9px] px-2 py-0.5 rounded font-black animate-pulse ml-1">æ›¾è§¸åŠ KI</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-1 rounded-lg font-black italic">ç¥¨æ¯: {{ item.coupon }}%</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                        <div v-for="s in (item.stocks || [])" :key="s.code" class="stock-tag">
                            <p class="text-[11px] font-black text-blue-500 uppercase">{{ s.code.replace('.T', '') }}</p>
                            <p class="text-xl font-black leading-none my-1 tracking-tighter">{{ formatPrice(s.current) }}</p>
                            <div class="text-[8px] font-bold text-gray-400 border-t pt-1 mt-1 leading-tight text-left px-1">
                                <p>KO: <span class="text-slate-800 font-black">{{ formatPrice(s.init * (item.koP/100)) }}</span></p>
                                <p>KI: <span class="text-red-500 font-black">{{ formatPrice(s.init * (item.kiP/100)) }}</span></p>
                            </div>
                            <p class="text-[11px] font-black mt-1" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end border-t pt-4">
                        <div class="text-[11px] font-bold text-gray-500">
                            <p>åˆ°æœŸæ—¥æœŸ: <span class="text-blue-500 font-black italic">{{ item.expiry }}</span></p>
                            <p class="text-lg">åº«å­˜é‡‘é¡: <span class="text-slate-900 font-black underline">{{ formatNum(item.amount) }} è¬</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400 font-bold uppercase">é ä¼°æœˆæ¯</p>
                            <p class="text-emerald-600 font-black text-2xl italic">{{ item.currency==='JPY'?'Â¥':'$' }}{{ formatNum(calcMonthly(item)) }}</p>
                        </div>
                    </div>
                </div>
            `,
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                // æ ¸å¿ƒä¿®æ­£ï¼šç§»é™¤ Math.floorï¼Œç¢ºä¿å°æ•¸é»æ­£ç¢ºé¡¯ç¤º
                formatPrice(n){ 
                    if (!n || n == 0) return '---';
                    return parseFloat(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                },
                calcMonthly(i){ return ((i.amount||0) * 10000 * (i.coupon/100)) / 12; },
                getPerf(i,s){ return (!s.init || !s.current || s.current <= 0) ? '100.00' : ((s.current/s.init)*100).toFixed(2); },
                perfColor(item, s){ 
                    const p = parseFloat(this.getPerf(item, s));
                    if(s.memoryKI || p <= item.kiP) return 'text-danger';
                    if(p >= item.koP) return 'text-success';
                    return 'text-gray-400';
                },
                isTouchedKI(item) {
                    return item.stocks && item.stocks.some(s => s.memoryKI || (s.current > 0 && ((s.current / s.init) * 100) <= item.kiP));
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', kiList: [],
                    lastUpdated: ''
                }
            },
            computed: {
                countJPY() { return this.inventory.filter(i => i.currency === 'JPY').length; },
                countUSD() { return this.inventory.filter(i => i.currency === 'USD').length; },
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                clientFilteredList() { 
                    const s = (this.search || "").toLowerCase().trim();
                    return !s ? this.inventory : this.inventory.filter(i => (i.client && i.client.includes(s)) || (i.sn && i.sn.toLowerCase().includes(s))); 
                }
            },
            methods: {
                formatNum(n) { return n ? Math.floor(n).toLocaleString() : '0'; },
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; sessionStorage.setItem('fcn_auth', 'true'); } },
                async loadCSVData() {
                    this.isSyncing = true;
                    try {
                        const response = await fetch('data.csv?nocache=' + Date.now());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (results) => {
                                this.inventory = results.data.map(row => {
                                    const stocks = [];
                                    const sn = String(row.sn || "").trim();
                                    const client = String(row.client || "").trim();
                                    for(let i=1; i<=4; i++) {
                                        if(row[`s${i}_code`]) {
                                            const code = String(row[`s${i}_code`]).trim();
                                            let isMKI = false;
                                            // æ°¸ä¹…æ¨™è¨˜é‚è¼¯
                                            if (code === 'ORCL') {
                                                if ((sn.includes('0369') && (client === 'å³æŸè¼' || client === 'åŠ‰ä»‹æ­£')) || (sn.includes('0334') && client === 'å³é©ç²')) isMKI = true;
                                            }
                                            stocks.push({code: code, init: row[`s${i}_init`], current: row[`s${i}_init`], memoryKI: isMKI});
                                        }
                                    }
                                    return { ...row, stocks: stocks };
                                });
                                this.fetchRealPrices();
                            }
                        });
                    } catch (e) { console.error("CSV åŠ è¼‰å¤±æ•—"); } finally { this.isSyncing = false; }
                },
                async fetchRealPrices() {
                    if (this.inventory.length === 0) return;
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => (i.stocks||[]).map(s => s.code)))];
                    
                    try {
                        // ä¿®æ­£ï¼šåŠ å…¥éš¨æ©Ÿæ•¸ç ´é™¤ä»£ç†ä¼ºæœå™¨å¿«å–
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}&cachebust=${Date.now()}`;
                        const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await resp.json();
                        const json = JSON.parse(data.contents);
                        
                        if (json.quoteResponse && json.quoteResponse.result) {
                            const priceMap = {};
                            json.quoteResponse.result.forEach(r => { 
                                // ä¿®æ­£ï¼šç›´æ¥è®€å–åŸå§‹æ•¸å€¼ï¼Œä¸åšä»»ä½•è™•ç†
                                priceMap[r.symbol] = r.regularMarketPrice; 
                            });

                            this.inventory.forEach(item => {
                                if(item.stocks) {
                                    item.stocks.forEach(stock => {
                                        if (priceMap[stock.code]) {
                                            stock.current = priceMap[stock.code];
                                        }
                                    });
                                }
                            });
                            // æ›´æ–°è§¸åŠæ¸…å–®
                            this.kiList = this.inventory.filter(i => i.stocks.some(s => s.memoryKI || (s.current/s.init)*100 <= i.kiP));
                            this.lastUpdated = new Date().toLocaleTimeString();
                        }
                    } catch (e) { console.error("è‚¡åƒ¹æ›´æ–°å¤±æ•—", e); } finally { this.isSyncing = false; }
                }
            },
            mounted() {
                if (sessionStorage.getItem('fcn_auth') === 'true') this.isLoggedIn = true;
                this.loadCSVData();
                // ä¿®æ­£ï¼šé »ç‡æ”¹ç‚º 30 ç§’æ›´æ–°ä¸€æ¬¡
                setInterval(() => this.fetchRealPrices(), 30000);
            }
        }).mount('#app')
    </script>
</body>
</html>
