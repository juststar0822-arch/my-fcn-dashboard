<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上新莊分行 - FCN 旗艦管理系統 v19</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", sans-serif; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 105px; transition: 0.3s; }
        .nav-header { background: white; padding: 10px; border-radius: 40px; display: flex; gap: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; }
        .nav-btn { padding: 10px 18px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.3s; white-space: nowrap; font-size: 14px; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 13px; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .lock-badge { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .text-success { color: #10b981; font-weight: 900; }
        .text-danger { color: #ef4444; font-weight: 900; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .jpy-tag { color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 6px; }
        .usd-tag { color: #2563eb; background: #eff6ff; padding: 2px 6px; border-radius: 6px; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- 登入介面 -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[1000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6 shadow-xl"><i class="fa-solid fa-lock text-2xl"></i></div>
                <h2 class="text-2xl font-black text-slate-800 mb-2 italic">上新莊管理系統</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="輸入密碼" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl tracking-[0.4em] mb-6 outline-none focus:ring-2 ring-blue-500 font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-lg shadow-lg">登入</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <!-- 頂部導航 -->
            <div class="nav-header sticky top-4 z-[500]">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">資產管理</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">按客戶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">按業務員</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">預警中心</button>
                <button @click="view = 'admin_login'" :class="['nav-btn', view.includes('admin') ? 'active' : '']"><i class="fa-solid fa-gear"></i></button>
                <div class="ml-auto flex items-center pr-3"><i @click="fetchRealPrices" class="fa-solid fa-rotate text-gray-300 cursor-pointer" :class="{'animate-spin': isSyncing}"></i></div>
            </div>

            <!-- 管理員登入畫面 -->
            <div v-if="view === 'admin_login'" class="fade-in max-w-sm mx-auto mt-10 text-center">
                <div class="fcn-card">
                    <h3 class="font-black mb-4 italic text-gray-500 uppercase">Admin Access</h3>
                    <input v-model="adminPassInput" type="password" placeholder="管理員密碼" class="w-full p-4 rounded-2xl bg-gray-100 mb-4 text-center text-xl outline-none border-2 focus:border-blue-500">
                    <button @click="checkAdminPass" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black">驗證身分</button>
                </div>
            </div>

            <!-- 管理員上傳功能 -->
            <div v-if="view === 'admin_panel'" class="fade-in space-y-4">
                <div class="fcn-card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black italic">系統資料同步 (CSV)</h2>
                        <button @click="view = 'branch'" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-2xl">
                            <label class="block text-[10px] font-black text-blue-400 mb-1 uppercase italic">GitHub Token (只需設定一次)</label>
                            <input v-model="githubToken" type="password" placeholder="貼上你的 ghp_ 開頭代碼" class="w-full bg-transparent border-b border-blue-200 p-2 text-sm outline-none font-mono">
                            <p class="text-[9px] text-blue-300 mt-2">* 此代碼會儲存在此電腦瀏覽器中，不需重複輸入。</p>
                        </div>

                        <div class="border-4 border-dashed border-gray-100 rounded-[2rem] p-10 text-center hover:bg-gray-50 transition">
                            <input type="file" id="csvFile" accept=".csv" class="hidden" @change="handleFileUpload">
                            <label for="csvFile" class="cursor-pointer block">
                                <i class="fa-solid fa-file-csv text-5xl text-blue-500 mb-3"></i>
                                <p class="font-black text-gray-700">{{ fileName || '選擇已編輯的 data.csv' }}</p>
                            </label>
                        </div>

                        <button @click="uploadToGithub" :disabled="isUploading || !githubToken || !selectedFile" 
                                class="w-full bg-blue-600 text-white p-5 rounded-2xl font-black shadow-xl disabled:opacity-20 flex items-center justify-center gap-3">
                            <i v-if="isUploading" class="fa-solid fa-spinner animate-spin"></i>
                            {{ isUploading ? '正在上傳至 GitHub...' : '確認更新並發佈' }}
                        </button>
                        <p v-if="uploadStatus" class="text-center text-xs font-black italic" :class="uploadStatus.includes('成功') ? 'text-green-500' : 'text-red-500'">{{ uploadStatus }}</p>
                    </div>
                </div>
            </div>

            <!-- 1. 首頁、2. 預警、3. 業務員、4. 客戶列表 (省略... 同上次代碼) -->
            <!-- [此處保持你原本的 view === 'branch' 等內容，僅在下方 Script 做修改] -->
            <div v-if="view === 'branch'" class="space-y-4 fade-in">
                <h2 class="text-xl font-black px-2 italic uppercase">Branch Summary</h2>
                <div v-for="curr in ['JPY', 'USD']" :key="curr" class="fcn-card shadow-xl" :class="curr==='JPY'?'bg-slate-800 text-white border-none':'bg-blue-600 text-white border-none'">
                    <div class="flex justify-between items-start mb-4"><p class="text-xs font-bold opacity-60 uppercase">{{ curr }} 庫存規模</p><span class="bg-black/20 px-2 py-1 rounded text-[10px] font-black">{{ curr==='JPY'?countJPY:countUSD }} 筆案件</span></div>
                    <div class="text-5xl font-black italic font-mono tracking-tighter">{{ curr==='JPY'?'¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} <span class="text-lg font-normal opacity-50">萬</span></div>
                </div>
            </div>
            <!-- ... 其他 view 區塊 (client, sales, alerts) 同原本代碼 ... -->

        </template>
    </div>

    <script>
        const { createApp } = Vue
        const stockNames = {'6146.T':'Disco','6501.T':'日立','7011.T':'三菱重工','6857.T':'愛德萬','7012.T':'川崎重工','7013.T':'IHI重工','7974.T':'任天堂','8035.T':'東京威力','5803.T':'藤倉電子','8697.T':'日本交易所','8002.T':'丸紅','NVDA':'輝達','TSLA':'特斯拉','TSM':'台積電','AMD':'超微','MU':'美光','ARM':'安謀','GOOG':'谷歌','AMZN':'亞馬遜','AVGO':'博通','MSFT':'微軟','META':'臉書','DELL':'戴爾','ORCL':'甲骨文','OKLO':'Oklo','PLTR':'帕蘭提爾','NFLX':'網飛','BRK.B':'波克夏'};

        const ClientCard = { /* ... 同上次 Card 組件 ... */ };

        createApp({
            components: { 'client-card': { props: ['item'], template: '<div></div>' /* 這裡請填入原本的 Card 代碼 */ } },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    adminPassInput: '', adminPass: '983983',
                    githubToken: localStorage.getItem('fcn_token') || '',
                    selectedFile: null, fileName: '', isUploading: false, uploadStatus: '',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki', selectedSales: '吳坤達'
                }
            },
            computed: {
                countJPY() { return this.inventory.filter(i => i.currency === 'JPY').length; },
                countUSD() { return this.inventory.filter(i => i.currency === 'USD').length; },
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                // ... 其他 computed 同原本 ...
            },
            methods: {
                formatNum(n) { return Math.floor(n).toLocaleString(); },
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; sessionStorage.setItem('fcn_auth', 'true'); } },
                checkAdminPass() {
                    if (this.adminPassInput === this.adminPass) { this.view = 'admin_panel'; }
                    else { alert('管理員密碼錯誤'); }
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) { this.selectedFile = file; this.fileName = file.name; }
                },
                async uploadToGithub() {
                    this.isUploading = true;
                    this.uploadStatus = '正在更新 GitHub 資料...';
                    localStorage.setItem('fcn_token', this.githubToken);

                    const owner = 'juststar0822-arch'; 
                    const repo = 'my-fcn-dashboard';
                    const path = 'data.csv';

                    try {
                        const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                        const res = await fetch(getUrl, { headers: { 'Authorization': `token ${this.githubToken}` } });
                        const fileData = await res.json();
                        
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const content = e.target.result.split(',')[1];
                            const putRes = await fetch(getUrl, {
                                method: 'PUT',
                                headers: { 'Authorization': `token ${this.githubToken}`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: 'Update via WebUI', content: content, sha: fileData.sha })
                            });

                            if (putRes.ok) {
                                this.uploadStatus = '✅ 更新成功！1 分鐘後生效。';
                                setTimeout(() => location.reload(), 2000);
                            } else {
                                this.uploadStatus = '❌ 上傳失敗，請檢查 Token 權限。';
                            }
                        };
                        reader.readAsDataURL(this.selectedFile);
                    } catch (error) {
                        this.uploadStatus = '❌ 錯誤: ' + error.message;
                    } finally { this.isUploading = false; }
                },
                async loadCSVData() {
                    try {
                        const response = await fetch('data.csv?t=' + new Date().getTime());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (results) => {
                                this.inventory = results.data.map(row => {
                                    const stocks = [];
                                    for(let i=1; i<=4; i++) {
                                        if(row[`s${i}_code`]) stocks.push({code: String(row[`s${i}_code`]), init: row[`s${i}_init`], current: row[`s${i}_current`]});
                                    }
                                    return { ...row, stocks: stocks };
                                });
                                this.fetchRealPrices();
                            }
                        });
                    } catch (e) { console.error(e); }
                },
                async fetchRealPrices() {
                    if(this.inventory.length === 0 || this.isSyncing) return;
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => i.stocks.map(s => s.code)))];
                    try {
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}`;
                        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await response.json();
                        const result = JSON.parse(data.contents);
                        if (result.quoteResponse?.result) {
                            const quotes = result.quoteResponse.result;
                            this.inventory.forEach(item => {
                                item.stocks.forEach(stock => {
                                    const q = quotes.find(quote => quote.symbol === stock.code);
                                    if (q) stock.current = q.regularMarketPrice;
                                });
                            });
                        }
                    } catch (e) { console.error(e); }
                    finally { this.isSyncing = false; }
                }
            },
            mounted() {
                if (sessionStorage.getItem('fcn_auth') === 'true') this.isLoggedIn = true;
                this.loadCSVData();
            }
        }).mount('#app')
    </script>
</body>
</html>
