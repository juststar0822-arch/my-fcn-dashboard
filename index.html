<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN æ ¸å¿ƒç®¡ç†ç³»çµ± v20</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f0f2f5; color: #1e293b; font-family: -apple-system, sans-serif; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #edf2f7; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 105px; }
        .nav-btn { padding: 10px 18px; border-radius: 30px; font-weight: 800; color: #64748b; background: white; transition: 0.3s; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 13px; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .lock-badge { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .text-success { color: #10b981; font-weight: 900; }
        .text-danger { color: #ef4444; font-weight: 900; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-3xl mx-auto">
        
        <!-- ç™»å…¥ä»‹é¢ -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[1000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <h2 class="text-2xl font-black mb-6 italic">ä¸Šæ–°èŠç®¡ç†ç³»çµ±</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full bg-slate-100 p-4 rounded-2xl text-center text-3xl mb-6 outline-none focus:ring-2 ring-blue-500 font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-lg shadow-lg">ç™»å…¥ä¸¦åŒæ­¥è³‡æ–™</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <div class="nav-header flex gap-2 sticky top-4 z-[500] bg-[#f0f2f5]/80 py-2 overflow-x-auto">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">ä¸Šæ–°èŠè³‡ç”¢ç®¡ç†</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">æŒ‰å®¢æˆ¶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">æŒ‰æ¥­å‹™å“¡</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦ä¸­å¿ƒ</button>
                <div @click="loadData" class="ml-auto w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer"><i class="fa-solid fa-cloud-arrow-down text-blue-500" :class="{'animate-bounce': isSyncing}"></i></div>
            </div>

            <!-- åˆ†è¡Œç¸½è¦½ (é¦–é ) -->
            <div v-if="view === 'branch'" class="space-y-4 fade-in">
                <div v-for="curr in ['JPY', 'USD']" class="fcn-card text-white border-none" :class="curr==='JPY'?'bg-slate-800':'bg-indigo-700'">
                    <p class="text-xs font-black opacity-60 uppercase mb-4">{{ curr }} ç¸½åº«å­˜</p>
                    <div class="text-5xl font-black italic font-mono">{{ curr==='JPY'?'Â¥':'$' }} {{ formatNum(getTotal(curr)) }} <span class="text-lg opacity-50 font-normal">è¬</span></div>
                    <div class="mt-8 pt-4 border-t border-white/10 flex justify-between text-xs font-bold italic">
                        <span>ç­†æ•¸: {{ getCount(curr) }} (äº¤å‰²ä¸­: {{ getSettling(curr) }})</span>
                        <span>é ä¼°æœˆæ´¾æ¯: {{ curr==='JPY'?'Â¥':'$' }}{{ formatNum(getMonthly(curr)) }}</span>
                    </div>
                </div>
            </div>

            <!-- é è­¦ä¸­å¿ƒåˆ†é  -->
            <div v-if="view === 'alerts'" class="space-y-4">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-hidden border border-gray-100">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">å·²è§¸åŠ KI ({{kiList.length}})</button>
                    <button @click="alertTab = 'ko'" :class="['risk-tab', alertTab === 'ko' ? 'active' : '']">æ¨™çš„é” KO ({{anyKOList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">å³å°‡å‡ºå ´ ({{exitList.length}})</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn + item.client"></client-card>
                <div v-if="currentAlertList.length === 0" class="text-center py-20 text-gray-400 font-bold italic">ç„¡ç¬¦åˆæ¢ä»¶</div>
            </div>

            <!-- å®¢æˆ¶èˆ‡æ¥­å‹™è¦–åœ– -->
            <div v-if="view === 'client' || view === 'sales'" class="space-y-4">
                <div v-if="view === 'sales'" class="px-2 mb-4">
                    <select v-model="selectedSales" class="w-full p-4 rounded-3xl bg-white shadow-sm font-black text-blue-600 outline-none">
                        <option v-for="s in salesSummary" :value="s.name">{{ s.name }} ({{ s.count }} ç­†)</option>
                    </select>
                </div>
                <div v-if="view === 'client'" class="px-2 mb-2">
                    <input v-model="search" type="text" placeholder="ğŸ” æœå°‹å®¢æˆ¶æˆ–æ¡ˆè™Ÿ" class="w-full p-4 rounded-3xl bg-white shadow-sm font-bold outline-none border-none">
                </div>
                <client-card v-for="item in displayList" :item="item" :key="item.sn + item.client"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','TSM':'å°ç©é›»','AMD':'è¶…å¾®','MU':'ç¾å…‰','ARM':'å®‰è¬€','GOOG':'è°·æ­Œ','AMZN':'äºé¦¬éœ','AVGO':'åšé€š','MSFT':'å¾®è»Ÿ','META':'è‡‰æ›¸','DELL':'æˆ´çˆ¾','ORCL':'ç”²éª¨æ–‡','OKLO':'Oklo','PLTR':'å¸•è˜­æçˆ¾','NFLX':'ç¶²é£›','BRK.B':'æ³¢å…‹å¤'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card fade-in">
                    <div v-if="isLocked(item)" class="absolute right-6 top-4"><span class="lock-badge"><i class="fa-solid fa-lock mr-1"></i>ä¿è­‰é ˜æ¯é–å®šæœŸ</span></div>
                    <div class="flex justify-between items-start mb-6">
                        <div><h3 class="text-3xl font-black text-gray-800 tracking-tighter italic">{{item.client}}</h3><p class="text-[10px] font-bold text-gray-400 mt-1 uppercase">{{item.sn}} | {{item.currency}}</p></div>
                        <div class="text-right font-black italic text-indigo-600 text-[11px] bg-indigo-50 px-2 py-1 rounded-lg">æ¯: {{item.coupon}}%</div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                            <p class="text-[11px] font-black text-blue-500 leading-none">{{s.code}}</p>
                            <p class="text-[9px] font-bold opacity-60">{{getStockName(s.code)}}</p>
                            <p class="text-xl font-black my-1 tracking-tighter">{{Math.floor(s.current)}}</p>
                            <p class="text-[11px] font-black" :class="perfColor(item, s)">{{getPerf(item,s)}}%</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t pt-5 text-[11px] font-bold text-gray-500">
                        <div class="space-y-1"><p>é‡‘é¡: <span class="text-gray-900 font-black italic">{{item.amount===0?'äº¤å‰²ä¸­':formatNum(item.amount)+'è¬'}}</span></p><p>åˆ°æœŸ: <span class="text-blue-500">{{item.expiry}}</span></p></div>
                        <div class="text-right space-y-1"><p>æ¥­å‹™: {{item.sales}}</p><p>æœˆé ˜æ¯: <span class="text-emerald-600 font-black text-lg">{{item.currency==='JPY'?'Â¥':'$'}}{{formatNum(calcMonthly(item))}}</span></p></div>
                    </div>
                    <div class="mt-4 flex justify-between text-[9px] font-black bg-gray-50 p-2 rounded-xl text-gray-400 uppercase italic"><span>KO: {{item.koP}}%</span><span>PUT: {{item.strikeP}}%</span><span :class="{'text-danger':hasKI(item)}">KI: {{item.kiP}}%</span><span>OBS: {{item.koStart}}</span></div>
                </div>`,
            methods: {
                formatNum(n){ return Math.floor(n).toLocaleString(); },
                calcMonthly(i){ return (i.amount * 10000 * i.coupon / 100) / 12; },
                getStockName(c){ return stockNames[c] || stockNames[c+'.T'] || ''; },
                getPerf(i,s){ return ((s.current/s.init)*100).toFixed(2); },
                perfColor(i,s){ 
                    const p=parseFloat(this.getPerf(i,s)); 
                    if(p>=i.koP) return 'text-success'; 
                    if(p<=i.strikeP) return 'text-danger'; 
                    return 'text-gray-500'; 
                },
                hasKI(i){ 
                    if(i.type==='EKI' && parseFloat(this.getPerf(i,i.stocks[0])) > i.kiP) return false;
                    return i.kiP>0 && i.stocks.some(s=>parseFloat(this.getPerf(i,s))<=i.kiP);
                },
                isLocked(i){ return new Date() < new Date(i.koStart); }
            }
        };

        createApp({
            components: {'client-card': ClientCard},
            data() {
                return {
                    view: 'branch', alertTab: 'ki', selectedSales: '', search: '', lastTime: '-', isSyncing: false,
                    isLoggedIn: false, inputPass: '', password: '98388', inventory: []
                }
            },
            computed: {
                countJPY(){ return this.inventory.filter(i=>i.currency==='JPY').length; },
                countUSD(){ return this.inventory.filter(i=>i.currency==='USD').length; },
                settlingJPY(){ return this.inventory.filter(i=>i.currency==='JPY'&&i.amount===0).length; },
                settlingUSD(){ return this.inventory.filter(i=>i.currency==='USD'&&i.amount===0).length; },
                salesSummary(){ 
                    const m={}; this.inventory.forEach(i=>m[i.sales]=(m[i.sales]||0)+1);
                    return Object.keys(m).map(k=>({name:k,count:m[k]})).sort((a,b)=>b.count-a.count);
                },
                kiList(){ return this.inventory.filter(i => i.kiP>0 && i.stocks.some(s=>((s.current/s.init)*100)<=i.kiP && i.type!=='EKI')); },
                anyKOList(){ return this.inventory.filter(i => i.stocks.some(s=>((s.current/s.init)*100)>=i.koP)); },
                exitList(){ return this.inventory.filter(i => new Date()>=new Date(i.koStart) && i.stocks.every(s=>((s.current/s.init)*100)>=i.koP)); },
                currentAlertList(){ return this.alertTab==='ki'?this.kiList:(this.alertTab==='ko'?this.anyKOList:this.exitList); },
                displayList(){
                    let list = this.inventory;
                    if(this.view==='sales' && this.selectedSales) list = list.filter(i=>i.sales===this.selectedSales);
                    if(this.view==='client' && this.search) list = list.filter(i=>i.client.includes(this.search)||i.sn.includes(this.search));
                    return list;
                }
            },
            methods: {
                formatNum(n){ return Math.floor(n).toLocaleString(); },
                getTotal(c){ return this.inventory.filter(i=>i.currency===c).reduce((s,i)=>s+i.amount,0); },
                getMonthly(c){ return this.inventory.filter(i=>i.currency===c).reduce((s,i)=>(s+(i.amount*10000*i.coupon/100)/12),0); },
                login(){ if(this.inputPass===this.password){ this.isLoggedIn=true; this.loadData(); } },
                async loadData(){
                    this.isSyncing=true;
                    try {
                        const res = await fetch('data.json?v=' + Date.now());
                        this.inventory = await res.json();
                        await this.fetchRealPrices();
                    } catch(e) { console.error("è³‡æ–™åŠ è¼‰å¤±æ•—"); }
                    this.isSyncing=false;
                },
                async fetchRealPrices(){
                    const symbols = [...new Set(this.inventory.flatMap(i=>i.stocks.map(s=>s.code)))].map(s=>s.includes('.')?s:s);
                    try {
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}`;
                        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await response.json();
                        const result = JSON.parse(data.contents);
                        if (result.quoteResponse?.result) {
                            result.quoteResponse.result.forEach(q=>{
                                this.inventory.forEach(item=>{
                                    item.stocks.forEach(s=>{ if(s.code===q.symbol || s.code+'.T'===q.symbol) s.current=q.regularMarketPrice; });
                                });
                            });
                            this.lastTime = new Date().toLocaleTimeString();
                        }
