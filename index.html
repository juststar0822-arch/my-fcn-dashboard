<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FCN 監控系統 v57.AKI</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f8fafc; color: #1e293b; font-family: -apple-system, "Noto Sans TC", sans-serif; -webkit-font-smoothing: antialiased; }
        .fcn-card { background: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; position: relative; }
        .stock-tag { background: #f8fafc; border: 1.5px solid #f1f5f9; border-radius: 14px; padding: 10px 4px; text-align: center; flex: 1; min-width: 100px; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-btn { padding: 10px 16px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; cursor: pointer; flex: 1; text-align: center; font-size: 13px; }
        .nav-btn.active { background: #1e293b; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 11px; cursor: pointer; }
        .risk-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; background: rgba(79, 70, 229, 0.05); }
        .info-label { color: #94a3b8; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
        .info-value { color: #1e293b; font-size: 12px; font-weight: 800; italic; }
        .text-danger { color: #ef4444; font-weight: 900; }
        .text-success { color: #10b981; font-weight: 900; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <template v-if="isLoggedIn">
            <div class="nav-header sticky top-4 z-[1000]">
                <button @click="view = 'summary'" :class="['nav-btn', view === 'summary' ? 'active' : '']">資產總覽</button>
                <button @click="view = 'clients'" :class="['nav-btn', view === 'clients' ? 'active' : '']">客戶明細</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">預警中心</button>
                <div class="flex items-center px-4"><i @click="fetchRealPrices" class="fa-solid fa-arrows-rotate text-indigo-500 cursor-pointer" :class="{'animate-spin': isSyncing}"></i></div>
            </div>

            <div v-if="view === 'alerts'" class="space-y-4">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 border border-gray-100 overflow-hidden">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">觸及KI ({{kiList.length}})</button>
                    <button @click="alertTab = 'nko'" :class="['risk-tab', alertTab === 'nko' ? 'active' : '']">即將KO</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn + item.client"></client-card>
            </div>

            <div v-if="view === 'clients'" class="space-y-4">
                <div class="relative mb-6">
                    <input v-model="search" type="text" placeholder="搜尋客戶姓名或序號..." class="w-full p-5 pl-12 rounded-3xl bg-white shadow-sm font-bold outline-none border border-gray-100 focus:ring-2 ring-indigo-500">
                    <i class="fa-solid fa-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <client-card v-for="item in clientFilteredList" :item="item" :key="item.sn + item.client"></client-card>
            </div>

            <div v-if="view === 'summary'" class="space-y-4">
                <div v-for="curr in ['JPY', 'USD']" :class="['fcn-card text-white border-none', curr==='JPY'?'bg-slate-800':'bg-indigo-600']">
                    <div class="flex justify-between items-start mb-4 opacity-70 text-[10px] font-black uppercase"><span>Managed Portfolio</span><span>{{ curr==='JPY'?countJPY:countUSD }} Clients</span></div>
                    <div class="text-5xl font-black italic font-mono">{{ curr==='JPY'?'¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} <span class="text-lg font-normal opacity-50 uppercase">萬</span></div>
                </div>
            </div>
        </template>

        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <h2 class="text-2xl font-black mb-1 italic text-slate-800">FCN MONITOR</h2>
                <p class="text-gray-400 text-[10px] font-bold mb-8 uppercase tracking-[0.2em]">Data Source: Central CSV</p>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Password" class="w-full bg-slate-100 border-none p-5 rounded-2xl text-center text-3xl mb-6 outline-none font-mono">
                <button @click="login" class="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black">ACCESS</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'6146.T':'Disco','6501.T':'日立','7011.T':'三菱重工','6857.T':'愛德萬','7012.T':'川崎重工','7013.T':'IHI重工','7974.T':'任天堂','8035.T':'東京威力','5803.T':'藤倉電子','8697.T':'日本交易所','8002.T':'丸紅','NVDA':'輝達','TSLA':'特斯拉','TSM':'台積電','AMD':'超微','MU':'美光','ARM':'安謀','GOOG':'谷歌','AMZN':'亞馬遜','AVGO':'博通','MSFT':'微軟','META':'臉書','DELL':'戴爾','ORCL':'甲骨文','OKLO':'Oklo','PLTR':'帕蘭提爾','NFLX':'網飛','BRK.B':'波克夏'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-3xl font-black text-slate-800 italic leading-none">{{ item.client }}</h3>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{ item.sn }}</span>
                                <span :class="[item.currency === 'JPY' ? 'text-gray-500 bg-gray-100' : 'text-blue-600 bg-blue-50', 'text-[9px] px-2 py-0.5 rounded font-black uppercase']">{{ item.currency }}</span>
                                <span v-if="item.isHistoryKI" class="bg-red-500 text-white text-[9px] px-2 py-0.5 rounded font-black animate-pulse">曾觸及下限</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="bg-indigo-50 text-indigo-600 text-[11px] px-3 py-1 rounded-xl font-black italic border border-indigo-100">Coupon: {{ item.coupon }}%</div>
                            <div class="text-[9px] text-gray-400 font-bold mt-1 uppercase">Sales: {{ item.sales }}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <div>
                            <p class="info-label">下單日期</p>
                            <p class="info-value"><i class="fa-regular fa-calendar-check mr-1 opacity-50"></i>{{ item.trade_date || '---' }}</p>
                        </div>
                        <div>
                            <p class="info-label">KO 觀察開始日</p>
                            <p class="info-value"><i class="fa-regular fa-eye mr-1 opacity-50"></i>{{ item.koStart || '---' }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                        <div v-for="s in (item.stocks || [])" :key="s.code" class="stock-tag">
                            <p class="text-[10px] font-black text-indigo-600 leading-none uppercase">{{ s.code.replace('.T', '') }}</p>
                            <p class="text-[8px] font-bold text-gray-400 mb-1 truncate">{{ getStockName(s.code) }}</p>
                            <p class="text-lg font-black leading-none my-1 tracking-tighter text-slate-700">{{ formatPrice(s.current) }}</p>
                            <p class="text-[9px] font-black text-slate-400 border-t border-slate-200 mt-1 pt-1">履約: {{ formatPrice(s.strike) }}</p>
                            <p class="text-[10px] font-black mt-1" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-end border-t border-gray-50 pt-4">
                        <div class="text-[10px] font-bold text-gray-400 space-y-1 text-left">
                            <p>到期日: <span class="text-slate-700 font-black italic">{{ item.expiry }}</span></p>
                            <p>本金: <span class="text-slate-700 font-black italic">{{ formatNum(item.amount) }} 萬</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-gray-400 uppercase">KI / KO 門檻</p>
                            <p class="text-slate-800 font-black italic text-sm">{{ item.kiP }}% / {{ item.koP }}%</p>
                        </div>
                    </div>
                </div>
            `,
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                formatPrice(n){ return n ? (Math.floor(parseFloat(n) * 100) / 100).toFixed(2) : '---'; },
                getStockName(c){ return stockNames[c] || c; },
                getPerf(i,s){ return s.init && s.current ? ((s.current/s.init)*100).toFixed(2) : '---'; },
                perfColor(i,s){ 
                    const p = parseFloat(this.getPerf(i,s));
                    if(p >= i.koP) return 'text-success';
                    if(p <= i.kiP) return 'text-danger';
                    return 'text-slate-400';
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'summary', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki',
                    // 永久記憶名單：這幾筆會一直顯示在 KI 預警分頁，且標註「曾觸及」
                    permanentKIList: [
                        { sn: '0369', client: '吳柏輝', stock: 'ORCL' },
                        { sn: '0369', client: '劉介正', stock: 'ORCL' },
                        { sn: '0334', client: '吳適玲', stock: 'ORCL' }
                    ]
                }
            },
            computed: {
                kiList() {
                    return this.inventory.filter(i => {
                        if (!i.stocks || !i.kiP || i.kiP <= 0) return false;
                        const isPerm = this.permanentKIList.some(m => String(i.sn).includes(m.sn) && i.client === m.client && i.stocks.some(s => s.code === m.stock));
                        const isCurrent = i.stocks.some(s => s.current > 0 && ((s.current/s.init)*100) <= i.kiP);
                        if (isPerm || isCurrent) {
                            if (isPerm && !isCurrent) i.isHistoryKI = true;
                            return true;
                        }
                        return false;
                    });
                },
                currentAlertList() { return this.alertTab === 'ki' ? this.kiList : []; },
                clientFilteredList() { 
                    const s = (this.search || "").toLowerCase().trim();
                    return this.inventory.filter(i => (i.client && i.client.includes(s)) || (i.sn && String(i.sn).includes(s))); 
                },
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                countJPY() { return this.inventory.filter(i => i.currency === 'JPY').length; },
                countUSD() { return this.inventory.filter(i => i.currency === 'USD').length; }
            },
            methods: {
                login() { if (this.inputPass === this.password) this.isLoggedIn = true; },
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                async loadCSVData() {
                    try {
                        const response = await fetch('data.csv?v=' + Date.now());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (results) => {
                                this.inventory = results.data.map(row => {
                                    const stocks = [];
                                    for(let i=1; i<=4; i++) {
                                        if(row[`s${i}_code`]) {
                                            stocks.push({
                                                code: String(row[`s${i}_code`]).trim(), 
                                                init: row[`s${i}_init`], 
                                                current: row[`s${i}_init`],
                                                strike: row[`s${i}_strike`] // 讀取履約價
                                            });
                                        }
                                    }
                                    return { ...row, stocks: stocks };
                                });
                                this.fetchRealPrices();
                            }
                        });
                    } catch (e) {}
                },
                async fetchRealPrices() {
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => (i.stocks||[]).map(s => s.code)))];
                    await Promise.all(symbols.map(async (symbol) => {
                        try {
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d`;
                            const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                            const data = await resp.json();
                            const price = JSON.parse(data.contents).chart.result[0].meta.regularMarketPrice;
                            if (price) {
                                this.inventory.forEach(item => {
                                    item.stocks?.forEach(s => { if(s.code === symbol) s.current = price; });
                                });
                            }
                        } catch (e) {}
                    }));
                    this.isSyncing = false;
                }
            },
            mounted() { this.loadCSVData(); setInterval(() => this.fetchRealPrices(), 60000); }
        }).mount('#app')
    </script>
</body>
</html>
