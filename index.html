<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>上新莊分行 - FCN 高級預警系統</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", sans-serif; }
        .fcn-card { background: white; border-radius: 24px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; position: relative; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 16px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; white-space: nowrap; font-size: 13px; cursor: pointer; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px 14px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 12px; white-space: nowrap; cursor: pointer; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; background: rgba(37, 99, 235, 0.05); }
        .lock-badge { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .stock-tag { background: #f8fafc; border: 1px solid #edf2f7; border-radius: 12px; padding: 8px; text-align: center; flex: 1; }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        
        <template v-if="!isLoggedIn">
            <div class="fixed inset-0 bg-slate-900 flex items-center justify-center p-6 z-[2000]">
                <div class="bg-white rounded-[2rem] p-8 w-full max-w-sm text-center">
                    <h2 class="text-2xl font-black mb-6 italic">FCN 管理登入</h2>
                    <input v-model="inputPass" type="password" @keyup.enter="login" class="w-full bg-slate-100 p-4 rounded-xl text-center text-2xl mb-4 outline-none">
                    <button @click="login" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">登入系統</button>
                </div>
            </div>
        </template>

        <template v-else>
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">資產管理</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">預警中心</button>
                <div class="ml-auto flex items-center pr-3">
                    <i @click="fetchRealPrices" class="fa-solid fa-rotate text-blue-500 cursor-pointer" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <div v-if="view === 'alerts'" class="space-y-4 fade-in">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-x-auto border border-gray-100 scrollbar-hide">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">觸及KI ({{kiList.length}})</button>
                    <button @click="alertTab = 'near_ko'" :class="['risk-tab', alertTab === 'near_ko' ? 'active' : '']">即將KO ({{nearKOList.length}})</button>
                    <button @click="alertTab = 'ko_watch'" :class="['risk-tab', alertTab === 'ko_watch' ? 'active' : '']">KO即將觀察 ({{koWatchList.length}})</button>
                    <button @click="alertTab = 'expiring'" :class="['risk-tab', alertTab === 'expiring' ? 'active' : '']">即將到期 ({{expiringList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">已出場 ({{exitList.length}})</button>
                </div>

                <div v-if="currentAlertList.length > 0" class="space-y-4">
                    <div v-for="item in currentAlertList" :key="item.sn" class="fcn-card">
                        <div v-if="isLocked(item)" class="absolute right-6 top-4"><span class="lock-badge"><i class="fa-solid fa-lock mr-1"></i>鎖定期內</span></div>
                        
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-black text-gray-800 italic">{{ item.client }}</h3>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">{{ item.sn }} | {{ item.currency }}</p>
                            </div>
                            <div class="text-right">
                                <span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-1 rounded font-black">票息: {{ item.coupon }}%</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                            <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                                <p class="text-[10px] font-black text-blue-500">{{ s.code }}</p>
                                <p class="text-lg font-black tracking-tighter">{{ s.current.toFixed(2) }}</p>
                                <p class="text-[10px] font-bold" :class="perfColor(item, s)">{{ ((s.current/s.init)*100).toFixed(2) }}%</p>
                                <p v-if="koHistory[item.sn]?.includes(s.code)" class="text-[9px] text-green-500 font-bold mt-1"><i class="fa-solid fa-check-circle"></i> 曾達標</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 border-t border-gray-100 pt-4 text-[11px] font-bold text-gray-500">
                            <div class="space-y-1">
                                <p>下單日期: <span class="text-slate-800">{{ item.orderDate || '---' }}</span></p>
                                <p>KO開始日期: <span class="text-orange-600 font-black">{{ item.koStart || '---' }}</span></p>
                            </div>
                            <div class="text-right space-y-1">
                                <p>到期日期: <span class="text-blue-500 font-black">{{ item.expiry }}</span></p>
                                <p>當前本金: <span class="text-gray-900 font-black">{{ item.amount }} 萬</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-20 text-gray-300 font-bold italic uppercase">無符合記錄</div>
            </div>

            <div v-if="view === 'branch'" class="p-4 text-center text-gray-400">請切換至預警中心查看最新邏輯</div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'alerts', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, alertTab: 'near_ko',
                    koHistory: {} // 記錄各 SN 下哪些股票曾達標過 KO
                }
            },
            computed: {
                kiList() { 
                    return this.inventory.filter(i => i.stocks.some(s => ((s.current/s.init)*100) <= i.kiP)); 
                },
                nearKOList() {
                    return this.inventory.filter(i => {
                        // 1. 排除鎖定期
                        if (this.isLocked(i)) return false;
                        // 2. 必須所有標的都曾達過標 (自動記憶)
                        const history = this.koHistory[i.sn] || [];
                        if (history.length < i.stocks.length) return false;
                        // 3. 目前只剩一檔距離 KO 價差 3% 以內 (即介於 koP-3 到 koP 之間)
                        const ratios = i.stocks.map(s => (s.current / s.init) * 100);
                        const belowKO = ratios.filter(r => r < i.koP);
                        return belowKO.length === 1 && belowKO[0] >= (i.koP - 3);
                    });
                },
                koWatchList() {
                    const now = new Date();
                    return this.inventory.filter(i => {
                        // 1. 必須還在鎖定期 (因為是即將觀察)
                        if (!this.isLocked(i)) return false;
                        // 2. 距離觀察期開始只剩 3 天
                        const start = new Date(i.koStart);
                        const diffDays = (start - now) / (1000 * 60 * 60 * 24);
                        if (diffDays < 0 || diffDays > 3) return false;
                        // 3. 只有一檔標的距離 KO 價差 3% 以內
                        const ratios = i.stocks.map(s => (s.current / s.init) * 100);
                        const belowKO = ratios.filter(r => r < i.koP);
                        return belowKO.length === 1 && belowKO[0] >= (i.koP - 3);
                    });
                },
                expiringList() {
                    const now = new Date();
                    return this.inventory.filter(i => {
                        const diff = (new Date(i.expiry) - now) / (1000 * 60 * 60 * 24);
                        return diff >= 0 && diff <= 5;
                    });
                },
                exitList() {
                    // 已出場：所有標的目前都在 KO 價以上
                    return this.inventory.filter(i => i.stocks.every(s => ((s.current/s.init)*100) >= i.koP));
                },
                currentAlertList() {
                    const map = { ki: this.kiList, near_ko: this.nearKOList, ko_watch: this.koWatchList, expiring: this.expiringList, exit: this.exitList };
                    return map[this.alertTab] || [];
                }
            },
            methods: {
                login() { if (this.inputPass === this.password) this.isLoggedIn = true; },
                isLocked(item) { return new Date() < new Date(item.koStart); },
                perfColor(i, s) {
                    const p = (s.current / s.init) * 100;
                    if (p >= i.koP) return 'text-success';
                    if (p <= i.kiP) return 'text-danger';
                    return 'text-gray-400';
                },
                async loadCSVData() {
                    try {
                        const response = await fetch('data.csv?t=' + Date.now());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (res) => {
                                this.inventory = res.data.map(row => {
                                    let stocks = [];
                                    for(let j=1; j<=4; j++) if(row[`s${j}_code`]) stocks.push({code: String(row[`s${j}_code`]), init: row[`s${j}_init`], current: row[`s${j}_init`]});
                                    return { ...row, stocks };
                                });
                                this.fetchRealPrices();
                            }
                        });
                    } catch (e) { console.error("CSV error"); }
                },
                async fetchRealPrices() {
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => i.stocks.map(s => s.code)))];
                    for (const symbol of symbols) {
                        try {
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d`;
                            const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                            const data = await resp.json();
                            const price = JSON.parse(data.contents).chart.result[0].meta.regularMarketPrice;
                            
                            this.inventory.forEach(item => {
                                if (!this.koHistory[item.sn]) this.koHistory[item.sn] = [];
                                item.stocks.forEach(s => {
                                    if (s.code === symbol) {
                                        s.current = price;
                                        // 自動記憶：若達標 KO 則存入歷史
                                        if (((price/s.init)*100) >= item.koP && !this.koHistory[item.sn].includes(symbol)) {
                                            this.koHistory[item.sn].push(symbol);
                                        }
                                    }
                                });
                            });
                        } catch (e) { console.warn("Fetch error", symbol); }
                    }
                    this.isSyncing = false;
                }
            },
            mounted() { this.loadCSVData(); }
        }).mount('#app');
    </script>
</body>
</html>
