<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏äÊñ∞ËéäÂàÜË°å - FCN ÁÆ°ÁêÜÁ≥ªÁµ± v61.History_Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f1f5f9; color: #1e293b; font-family: -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif; }
        .fcn-card { background: white; border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; position: relative; overflow: hidden; }
        .nav-header { background: #ffffff; padding: 10px; border-radius: 30px; display: flex; gap: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 20px; border-radius: 20px; font-weight: 700; color: #64748b; transition: 0.3s; white-space: nowrap; font-size: 14px; cursor: pointer; }
        .nav-btn.active { background: #1e2937; color: white; }
        .risk-tab { padding: 12px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; background: #eff6ff; }
        .stock-tag { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px; padding: 12px; text-align: center; }
        
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: 800; display: inline-block; margin-top: 4px; }
        .badge-ki { background: #fee2e2; color: #ef4444; }
        .badge-ko { background: #d1fae5; color: #059669; }
        .badge-soon { background: #fef3c7; color: #d97706; }
        .badge-exp { background: #f3f4f6; color: #64748b; border: 1px solid #d1d5db; }
        
        .api-status { font-size: 11px; font-weight: 800; color: #10b981; margin-right: 12px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- ÁôªÂÖ•È†ÅÈù¢ -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                <h2 class="text-2xl font-black mb-6">FCN ÁÆ°ÁêÜÁ≥ªÁµ± v61_H</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" class="w-full bg-gray-100 border-none p-4 rounded-xl text-center text-2xl mb-4 outline-none font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold text-lg">ÁôªÂÖ•Á≥ªÁµ±</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <!-- Â∞éË¶ΩÂàó -->
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">ÂàÜË°åÊ¶ÇÊ≥Å</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">ÂÆ¢Êà∂ÂàóË°®</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">È†êË≠¶‰∏≠ÂøÉ</button>
                <div class="ml-auto flex items-center pr-2">
                    <span class="api-status">‚óè TD LIVE</span>
                    <i @click="refreshAll" class="fa-solid fa-arrows-rotate text-blue-500 cursor-pointer" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- ÂàÜË°åÊ¶ÇÊ≥Å -->
            <div v-if="view === 'branch'" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="fcn-card bg-slate-800 text-white border-none">
                    <div class="text-sm opacity-70 mb-1">Total JPY Portfolio</div>
                    <div class="text-4xl font-black italic">¬• {{ formatNum(totalJPY) }} <span class="text-lg">Ëê¨</span></div>
                </div>
                <div class="fcn-card bg-blue-600 text-white border-none">
                    <div class="text-sm opacity-70 mb-1">Total USD Portfolio</div>
                    <div class="text-4xl font-black italic">$ {{ formatNum(totalUSD) }} <span class="text-lg">Ëê¨</span></div>
                </div>
            </div>

            <!-- È†êË≠¶‰∏≠ÂøÉ -->
            <div v-if="view === 'alerts'" class="space-y-4">
                <div class="flex bg-white rounded-xl shadow-sm mb-4 border border-gray-200 overflow-x-auto scrollbar-hide">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">Ëß∏Âèä KI ({{kiList.length}})</button>
                    <button @click="alertTab = 'everKO'" :class="['risk-tab', alertTab === 'everKO' ? 'active' : '']">ÊõæÁ∂ì KO ({{everKOList.length}})</button>
                    <button @click="alertTab = 'soon'" :class="['risk-tab', alertTab === 'soon' ? 'active' : '']">Âç≥Â∞áÂá∫Â†¥ ({{soonExitList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">Â∑≤Âá∫Â†¥ ({{exitList.length}})</button>
                    <button @click="alertTab = 'exp'" :class="['risk-tab', alertTab === 'exp' ? 'active' : '']">Âà∞Êúü ({{expiringList.length}})</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn" :price-data="priceMap"></client-card>
            </div>

            <!-- ÂÆ¢Êà∂ÂàóË°® -->
            <div v-if="view === 'client'" class="space-y-4">
                <input v-model="search" type="text" placeholder="üîç Âø´ÈÄüÊêúÂ∞ãÂÆ¢Êà∂ÂßìÂêçÊàñÊ°àËôü..." class="w-full p-4 rounded-2xl bg-white shadow-sm font-bold border-none outline-none">
                <client-card v-for="item in clientFilteredList" :item="item" :key="item.sn" :price-data="priceMap"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp, reactive } = Vue;
        const TD_API_KEY = "324eeabe4700448ea99da98cafaa09ce"; 

        const ClientCard = {
            props: ['item', 'priceData'],
            template: `
                <div class="fcn-card" :class="{'opacity-70': isExited}">
                    <div v-if="isExited" class="absolute top-0 right-0 bg-indigo-600 text-white px-4 py-1 font-black text-[10px] transform rotate-45 translate-x-4 translate-y-1">EXITED</div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-[10px] font-black text-gray-400 mb-1 uppercase">{{ item.sn }} | {{ item.sales }}</div>
                            <h3 class="text-2xl font-black text-slate-800">{{ item.client }}</h3>
                            <div class="text-[10px] text-gray-400 font-bold mt-1">‰∏ãÂñÆÊó•: {{ item.date }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-blue-600 italic">
                                {{ item.currency==='JPY'?'¬•':'$' }} {{ formatNum(item.amount) }}Ëê¨
                            </div>
                            <div class="mt-1 bg-indigo-50 text-indigo-600 text-[10px] px-2 py-0.5 rounded-full font-black inline-block">Âπ¥Âåñ: {{ item.coupon }}%</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[11px] font-black text-blue-600">{{ s.code }}</span>
                                <span class="text-[11px] font-bold" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</span>
                            </div>
                            <div class="text-xl font-black mb-2 text-slate-700">{{ formatPrice(priceData[s.code]?.current) }}</div>
                            
                            <div class="space-y-1 text-left px-1 border-t pt-2 text-[9px]">
                                <div class="flex justify-between"><span class="text-gray-400">KO</span><span class="font-black text-emerald-600">{{ formatPrice(s.init * (item.koP/100)) }}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">KI</span><span class="font-black text-rose-600">{{ formatPrice(s.init * (item.kiP/100)) }}</span></div>
                            </div>

                            <div class="flex flex-wrap gap-1 justify-center mt-2">
                                <span v-if="checkStockKI(item, s)" class="badge badge-ki">ÊõæËß∏KI</span>
                                <span v-if="checkStockKO(item, s)" class="badge badge-ko">ÊõæÈÅîKO</span>
                                <span v-if="checkStockSoon(item, s)" class="badge badge-soon">Â∑Æ3%KO</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-[10px] font-bold text-gray-400 border-t pt-3 uppercase">
                        <div>ËßÄÂØüËµ∑Âßã: {{ item.koStart || 'N/A' }}</div>
                        <div>Âà∞ÊúüÊó•: <span class="text-blue-500">{{ item.expiry }}</span> <span v-if="isExpiring" class="badge badge-exp !mt-0 ml-1">Âç≥Â∞áÂà∞Êúü</span></div>
                    </div>
                </div>
            `,
            computed: {
                isExited() {
                    if (!this.item.koStart) return false;
                    return this.item.stocks.every(s => this.checkStockKO(this.item, s));
                },
                isExpiring() {
                    const diff = (new Date(this.item.expiry.replace(/-/g, '/')) - new Date()) / 86400000;
                    return diff >= 0 && diff <= 3;
                }
            },
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                formatPrice(n){ return (!n || n == 0) ? '---' : parseFloat(n).toFixed(2); },
                getPerf(item, stock){ 
                    const cur = this.priceData[stock.code]?.current;
                    return cur ? ((cur / stock.init) * 100).toFixed(2) : '---'; 
                },
                perfColor(item, stock){ 
                    const p = parseFloat(this.getPerf(item, stock));
                    if(isNaN(p)) return 'text-slate-400';
                    return p >= item.koP ? 'text-emerald-500' : (p <= item.kiP ? 'text-rose-500' : 'text-slate-400');
                },
                checkStockKI(item, s) {
                    const min = this.priceData[s.code]?.histMinByDate?.[item.date];
                    return min && (min / s.init * 100) <= item.kiP;
                },
                checkStockKO(item, s) {
                    if (!item.koStart) return false;
                    const max = this.priceData[s.code]?.histMaxAfterKOStart?.[item.sn];
                    return max && (max / s.init * 100) >= item.koP;
                },
                checkStockSoon(item, s) {
                    const cur = this.priceData[s.code]?.current;
                    if (!cur || !item.koStart || this.checkStockKO(item, s)) return false;
                    const ratio = cur / (s.init * item.koP / 100);
                    return ratio >= 0.97 && ratio < 1.0;
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki',
                    priceMap: reactive({})
                }
            },
            computed: {
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                
                kiList() { 
                    return this.inventory.filter(i => i.stocks?.some(s => {
                        const min = this.priceMap[s.code]?.histMinByDate?.[i.date];
                        return min && (min / s.init * 100) <= i.kiP;
                    }));
                },
                everKOList() { 
                    return this.inventory.filter(i => i.stocks?.some(s => {
                        const max = this.priceMap[s.code]?.histMaxAfterKOStart?.[i.sn];
                        return max && (max / s.init * 100) >= i.koP;
                    }));
                },
                soonExitList() {
                    return this.inventory.filter(i => {
                        if (!i.koStart) return false;
                        const reached = i.stocks.filter(s => {
                            const max = this.priceMap[s.code]?.histMaxAfterKOStart?.[i.sn];
                            return max && (max / s.init * 100) >= i.koP;
                        });
                        if (reached.length === i.stocks.length - 1) {
                            const remain = i.stocks.find(s => !reached.includes(s));
                            const cur = this.priceMap[remain.code]?.current;
                            return cur && (cur / (remain.init * i.koP / 100)) >= 0.97 && (cur / (remain.init * i.koP / 100)) < 1.0;
                        }
                        return false;
                    });
                },
                exitList() {
                    return this.inventory.filter(i => {
                        if (!i.koStart) return false;
                        return i.stocks?.every(s => {
                            const max = this.priceMap[s.code]?.histMaxAfterKOStart?.[i.sn];
                            return max && (max / s.init * 100) >= i.koP;
                        });
                    });
                },
                expiringList() {
                    return this.inventory.filter(i => {
                        const diff = (new Date(i.expiry.replace(/-/g, '/')) - new Date()) / 86400000;
                        return diff >= 0 && diff <= 3;
                    });
                },
                currentAlertList() { 
                    const m = { ki:this.kiList, everKO:this.everKOList, soon:this.soonExitList, exit:this.exitList, exp:this.expiringList };
                    return m[this.alertTab] || [];
                },
                clientFilteredList() { 
                    const s = this.search.toLowerCase(); 
                    return !s ? this.inventory : this.inventory.filter(i => i.client.includes(s) || i.sn.toLowerCase().includes(s)); 
                }
            },
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; sessionStorage.setItem('fcn_auth', 'true'); this.loadCSVData(); } },
                
                async loadCSVData() {
                    const response = await fetch('data.csv?v=' + Date.now());
                    const text = await response.text();
                    Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true, complete: (res) => {
                        this.inventory = res.data.map(row => {
                            const stocks = [];
                            for(let i=1; i<=4; i++) if(row[`s${i}_code`]) {
                                const code = String(row[`s${i}_code`]).toUpperCase().trim();
                                stocks.push({ code, init: row[`s${i}_init`] });
                                if (!this.priceMap[code]) this.priceMap[code] = { current: 0, histMinByDate: {}, histMaxAfterKOStart: {} };
                            }
                            return { ...row, stocks };
                        });
                        this.refreshAll();
                    }});
                },

                async refreshAll() {
                    if (this.isSyncing) return;
                    this.isSyncing = true;
                    const symbols = Object.keys(this.priceMap);
                    
                    try {
                        // 1. ÊäìÂèñÁèæÂÉπ
                        const quoteUrl = `https://api.twelvedata.com/quote?symbol=${symbols.join(',')}&apikey=${TD_API_KEY}`;
                        const quoteResp = await fetch(quoteUrl);
                        const quoteData = await quoteResp.json();
                        
                        symbols.forEach(sym => {
                            const sData = symbols.length === 1 ? quoteData : quoteData[sym];
                            if (sData && sData.close) {
                                this.priceMap[sym].current = parseFloat(sData.close);
                                this.updateInstantData(sym, sData);
                            }
                        });

                        // 2. ÊäìÂèñÊ≠∑Âè≤ (Â∏∂Âø´Âèñ)
                        const today = new Date().toISOString().split('T')[0];
                        for (const sym of symbols) {
                            const cacheKey = `h_v61_${sym}_${today}`;
                            const cached = localStorage.getItem(cacheKey);
                            
                            if (cached) {
                                this.processHistory(sym, JSON.parse(cached));
                            } else {
                                const url = `https://api.twelvedata.com/time_series?symbol=${sym}&interval=1day&outputsize=5000&apikey=${TD_API_KEY}`;
                                const resp = await fetch(url);
                                const res = await resp.json();
                                if (res.values) {
                                    this.processHistory(sym, res.values);
                                    localStorage.setItem(cacheKey, JSON.stringify(res.values));
                                    if (symbols.length > 1) await new Promise(r => setTimeout(r, 8000));
                                }
                            }
                        }
                    } catch (e) { console.error("Sync Error", e); }
                    this.isSyncing = false;
                },

                processHistory(sym, values) {
                    this.inventory.forEach(inv => {
                        if (!inv.stocks.some(s => s.code === sym)) return;
                        const orderDate = new Date(inv.date.replace(/-/g, '/'));
                        const histLows = values.filter(v => new Date(v.datetime) >= orderDate).map(v => parseFloat(v.low));
                        this.priceMap[sym].histMinByDate[inv.date] = Math.min(...histLows, this.priceMap[sym].current || 99999);

                        if (inv.koStart) {
                            const koDate = new Date(inv.koStart.replace(/-/g, '/'));
                            const histHighs = values.filter(v => new Date(v.datetime) >= koDate).map(v => parseFloat(v.high));
                            this.priceMap[sym].histMaxAfterKOStart[inv.sn] = Math.max(...histHighs, this.priceMap[sym].current || 0);
                        }
                    });
                },

                updateInstantData(sym, sData) {
                    this.inventory.forEach(inv => {
                        if (!inv.stocks.some(s => s.code === sym)) return;
                        const curMin = this.priceMap[sym].histMinByDate[inv.date] || 99999;
                        if (parseFloat(sData.low) < curMin) this.priceMap[sym].histMinByDate[inv.date] = parseFloat(sData.low);
                        if (inv.koStart) {
                            const curMax = this.priceMap[sym].histMaxAfterKOStart[inv.sn] || 0;
                            if (parseFloat(sData.high) > curMax) this.priceMap[sym].histMaxAfterKOStart[inv.sn] = parseFloat(sData.high);
                        }
                    });
                }
            },
            mounted() { if (sessionStorage.getItem('fcn_auth') === 'true') { this.isLoggedIn = true; this.loadCSVData(); } }
        }).mount('#app');
    </script>
</body>
</html>
