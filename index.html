<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN ç®¡ç†ç³»çµ± v58.Premium</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1e293b; font-family: -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif; }
        .fcn-card { background: white; border-radius: 32px; padding: 28px; margin-bottom: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; position: relative; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 18px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; white-space: nowrap; font-size: 13px; cursor: pointer; border: none; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px 14px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 11px; cursor: pointer; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; background: rgba(37, 99, 235, 0.05); }
        
        /* å¼·åŒ–æ¨™ç±¤ */
        .stock-tag { background: #ffffff; border: 2px solid #f1f5f9; border-radius: 20px; padding: 12px 8px; text-align: center; transition: 0.3s; }
        .stock-tag:hover { border-color: #e2e8f0; transform: translateY(-2px); }
        .breach-tag { background: #fee2e2; color: #ef4444; font-size: 10px; padding: 2px 8px; border-radius: 6px; margin-top: 6px; display: inline-block; font-weight: 900; }
        .ko-tag { background: #d1fae5; color: #059669; font-size: 10px; padding: 2px 8px; border-radius: 6px; margin-top: 6px; display: inline-block; font-weight: 900; }
        
        /* é‡‘é¡èˆ‡æ¢ä»¶å¤§å­— */
        .price-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
        .price-value { font-family: 'Monaco', 'Consolas', monospace; font-weight: 800; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- ç™»å…¥èˆ‡å°è¦½ (åŒå‰) -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6"><i class="fa-solid fa-lock text-2xl"></i></div>
                <h2 class="text-2xl font-black mb-2 italic">ä¸Šæ–°èŠç®¡ç†ç³»çµ±</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Password" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl tracking-[0.4em] mb-6 outline-none focus:ring-2 ring-blue-500 font-mono">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-lg">LOGIN</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide text-slate-800">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">è³‡ç”¢ç®¡ç†</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">æŒ‰å®¢æˆ¶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">æŒ‰æ¥­å‹™å“¡</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦ä¸­å¿ƒ</button>
                <div class="ml-auto flex items-center pr-3">
                    <i @click="fetchHistoryData" class="fa-solid fa-rotate text-blue-500 cursor-pointer text-lg" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- æ•¸æ“šè¦–åœ–å…§å®¹ (ç¶­æŒåŸæ¨£) -->
            <div v-if="view === 'alerts'" class="space-y-4">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-x-auto text-slate-800 scrollbar-hide border border-gray-100">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">å…¨æœŸè§¸KI({{kiList.length}})</button>
                    <button @click="alertTab = 'pko'" :class="['risk-tab', alertTab === 'pko' ? 'active' : '']">è§€å¯ŸæœŸKO({{partKOList.length}})</button>
                    <button @click="alertTab = 'obs'" :class="['risk-tab', alertTab === 'obs' ? 'active' : '']">å³å°‡è§€å¯Ÿ</button>
                    <button @click="alertTab = 'exp'" :class="['risk-tab', alertTab === 'exp' ? 'active' : '']">åˆ°æœŸ</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn + item.client"></client-card>
            </div>

            <div v-if="view === 'client'" class="space-y-4">
                <input v-model="search" type="text" placeholder="ğŸ” æœå°‹å®¢æˆ¶æˆ–ç·¨è™Ÿ..." class="w-full p-5 rounded-3xl bg-white shadow-sm font-bold outline-none text-slate-800 pl-8 mb-4">
                <client-card v-for="item in clientFilteredList" :item="item" :key="item.sn + item.client"></client-card>
            </div>

            <div v-if="view === 'branch'" class="space-y-4">
                <div v-for="curr in ['JPY', 'USD']" :key="curr" class="fcn-card bg-slate-800 text-white border-none shadow-2xl" :class="curr==='USD' ? 'bg-blue-700' : ''">
                    <div class="flex justify-between items-center opacity-70 mb-2 font-black text-xs uppercase tracking-widest"><span>Total Portfolio</span><span>{{ curr }}</span></div>
                    <div class="text-5xl font-black italic tracking-tighter">{{ curr==='JPY'?'Â¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} <span class="text-xl">è¬</span></div>
                </div>
            </div>
            
            <div v-if="view === 'sales'" class="space-y-4">
                <select v-model="selectedSales" class="w-full p-4 rounded-3xl bg-white shadow-sm font-black text-blue-600 outline-none text-lg mb-4">
                    <option v-for="s in salesSummary" :value="s.name">{{ s.name }} ({{ s.count }} ç­†)</option>
                </select>
                <client-card v-for="item in salesFilteredList" :item="item" :key="item.sn + item.client"></client-card>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;
        const stockNames = {'6146.T':'Disco','6501.T':'æ—¥ç«‹','7011.T':'ä¸‰è±é‡å·¥','6857.T':'æ„›å¾·è¬','7012.T':'å·å´é‡å·¥','7013.T':'IHIé‡å·¥','7974.T':'ä»»å¤©å ‚','8035.T':'æ±äº¬å¨åŠ›','5803.T':'è—¤å€‰é›»å­','8697.T':'æ—¥æœ¬äº¤æ˜“æ‰€','8002.T':'ä¸¸ç´…','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','TSM':'å°ç©é›»','AMD':'è¶…å¾®','MU':'ç¾å…‰','ARM':'å®‰è¬€','GOOG':'è°·æ­Œ','AMZN':'äºé¦¬éœ','AVGO':'åšé€š','MSFT':'å¾®è»Ÿ','META':'è‡‰æ›¸','DELL':'æˆ´çˆ¾','ORCL':'ç”²éª¨æ–‡','OKLO':'Oklo','PLTR':'å¸•è˜­æçˆ¾','NFLX':'ç¶²é£›','BRK.B':'æ³¢å…‹å¤'};

        const ClientCard = {
            props: ['item'],
            template: `
                <div class="fcn-card">
                    <!-- Top Info: Client & Amount -->
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-slate-900 text-white text-[10px] px-2 py-0.5 rounded-full font-black tracking-tighter">{{ item.sn }}</span>
                                <span :class="[item.currency === 'JPY' ? 'bg-slate-100 text-slate-500' : 'bg-blue-100 text-blue-600']" class="text-[10px] px-2 py-0.5 rounded-full font-black">{{ item.currency }}</span>
                            </div>
                            <h3 class="text-4xl font-black text-slate-800 tracking-tighter italic leading-none">{{ item.client }}</h3>
                            <p class="text-[11px] text-gray-400 font-bold mt-2 uppercase tracking-widest"><i class="fa-solid fa-user-tie mr-1"></i> {{ item.sales }} | <i class="fa-regular fa-calendar-check mr-1"></i> {{ item.date }} ä¸‹å–®</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[11px] font-black text-slate-400 uppercase leading-none mb-1">åº«å­˜é‡‘é¡</p>
                            <p class="text-4xl font-black text-blue-600 tracking-tighter italic leading-none">
                                <span class="text-xl mr-1">{{ item.currency==='JPY'?'Â¥':'$' }}</span>{{ formatNum(item.amount) }}<span class="text-lg ml-1">è¬</span>
                            </p>
                            <div class="mt-2 bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black inline-block">å¹´åŒ–ç¥¨æ¯: {{ item.coupon }}%</div>
                        </div>
                    </div>

                    <!-- Core Conditions Dashboard -->
                    <div class="grid grid-cols-3 gap-4 bg-slate-50 rounded-2xl p-4 mb-6 border border-slate-100">
                        <div class="text-center border-r border-slate-200">
                            <p class="price-label text-emerald-500"><i class="fa-solid fa-arrow-trend-up"></i> KO å‡ºå ´åƒ¹</p>
                            <p class="text-xl font-black text-slate-800 leading-none">{{ item.koP }}%</p>
                        </div>
                        <div class="text-center border-r border-slate-200">
                            <p class="price-label text-amber-500"><i class="fa-solid fa-shield-halved"></i> Strike å±¥ç´„åƒ¹</p>
                            <p class="text-xl font-black text-slate-800 leading-none">{{ item.strikeP }}%</p>
                        </div>
                        <div class="text-center">
                            <p class="price-label text-rose-500"><i class="fa-solid fa-skull-crossbones"></i> KI è½å…¥åƒ¹</p>
                            <p class="text-xl font-black text-slate-800 leading-none">{{ item.kiP > 0 ? item.kiP + '%' : 'None' }}</p>
                        </div>
                    </div>

                    <!-- Individual Stock Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div v-for="s in (item.stocks || [])" :key="s.code" class="stock-tag shadow-sm">
                            <div class="flex justify-between items-start px-1">
                                <span class="text-[12px] font-black text-blue-600 uppercase">{{ s.code.replace('.T', '') }}</span>
                                <span class="text-[11px] font-black" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</span>
                            </div>
                            <p class="text-[9px] font-bold text-gray-400 truncate mb-2 px-1">{{ getStockName(s.code) }}</p>
                            <p class="text-2xl font-black text-slate-800 leading-none tracking-tighter mb-3">{{ formatPrice(s.current) }}</p>
                            
                            <!-- Detailed Condition Prices per Stock -->
                            <div class="space-y-1 text-left px-1">
                                <div class="flex justify-between text-[9px]">
                                    <span class="text-gray-400">KO</span>
                                    <span class="font-black text-emerald-600">{{ formatPrice(s.init * (item.koP/100)) }}</span>
                                </div>
                                <div class="flex justify-between text-[9px]">
                                    <span class="text-gray-400">Strike</span>
                                    <span class="font-black text-amber-600">{{ formatPrice(s.init * (item.strikeP/100)) }}</span>
                                </div>
                                <div v-if="item.kiP > 0" class="flex justify-between text-[9px]">
                                    <span class="text-gray-400">KI</span>
                                    <span class="font-black text-rose-600">{{ formatPrice(s.init * (item.kiP/100)) }}</span>
                                </div>
                            </div>

                            <!-- Breach Status -->
                            <div v-if="s.histMin && (s.histMin/s.init*100) <= item.kiP" class="breach-tag">å…¨æœŸæ›¾è§¸KI</div>
                            <div v-if="s.histMaxObs && (s.histMaxObs/s.init*100) >= item.koP" class="ko-tag">è§€å¯ŸæœŸæ›¾KO</div>
                        </div>
                    </div>

                    <!-- Footer Info -->
                    <div class="flex justify-between items-center border-t pt-4 text-[11px] font-bold text-slate-400 uppercase tracking-tighter">
                        <div><i class="fa-regular fa-clock mr-1"></i> è§€å¯ŸæœŸèµ·å§‹: <span class="text-slate-800 font-black">{{ item.koStart || 'N/A' }}</span></div>
                        <div class="text-right">åˆ°æœŸæ—¥: <span class="text-blue-500 font-black">{{ item.expiry }}</span></div>
                    </div>
                </div>
            `,
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                formatPrice(n){ return (!n || n == 0) ? '---' : parseFloat(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); },
                getStockName(c){ return stockNames[c] || c; },
                getPerf(i,s){ return (!s.init || !s.current) ? '100.00' : ((s.current/s.init)*100).toFixed(2); },
                perfColor(i,s){ 
                    const p = parseFloat(this.getPerf(i,s));
                    if(p >= i.koP) return 'text-emerald-500';
                    if(p <= i.kiP) return 'text-rose-500';
                    return 'text-slate-400';
                }
            }
        };

        // --- Vue App Logic (ç¶­æŒä¹‹å‰çš„æ­·å²æ•¸æ“šåŒæ­¥é‚è¼¯) ---
        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki', selectedSales: 'å³å¤é”'
                }
            },
            computed: {
                countJPY() { return this.inventory.filter(i => i.currency === 'JPY').length; },
                countUSD() { return this.inventory.filter(i => i.currency === 'USD').length; },
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                salesSummary() {
                    const map = {}; this.inventory.forEach(i => { if(i.sales) map[i.sales] = (map[i.sales] || 0) + 1; });
                    return Object.keys(map).map(k => ({ name: k, count: map[k] })).sort((a,b) => b.count - a.count);
                },
                kiList() { return this.inventory.filter(i => i.kiP > 0 && (i.stocks || []).some(s => s.histMin > 0 && ((s.histMin / s.init) * 100) <= i.kiP)); },
                partKOList() { return this.inventory.filter(i => (i.stocks || []).some(s => s.histMaxObs > 0 && ((s.histMaxObs / s.init) * 100) >= i.koP)); },
                observationList() {
                    const now = new Date();
                    return this.inventory.filter(i => {
                        if(!i.koStart) return false;
                        const start = new Date(String(i.koStart).replace(/-/g, '/'));
                        const diff = Math.ceil((start - now) / 86400000);
                        return diff >= 0 && diff <= 3;
                    });
                },
                expiringList() {
                    const now = new Date();
                    return this.inventory.filter(i => {
                        if(!i.expiry) return false;
                        const exp = new Date(String(i.expiry).replace(/-/g, '/'));
                        const diff = Math.ceil((exp - now) / 86400000);
                        return diff >= 0 && diff <= 7;
                    });
                },
                currentAlertList() { 
                    const m = {ki:this.kiList, pko:this.partKOList, obs:this.observationList, exp:this.expiringList};
                    return m[this.alertTab] || [];
                },
                clientFilteredList() { 
                    const s = (this.search || "").toLowerCase().trim();
                    return !s ? this.inventory : this.inventory.filter(i => (i.client && i.client.includes(s)) || (i.sn && i.sn.toLowerCase().includes(s))); 
                },
                salesFilteredList() { return this.inventory.filter(i => i.sales === this.selectedSales); }
            },
            methods: {
                login() { if (this.inputPass === this.password) { this.isLoggedIn = true; sessionStorage.setItem('fcn_auth', 'true'); this.loadCSVData(); } },
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                async loadCSVData() {
                    this.isSyncing = true;
                    try {
                        const response = await fetch('data.csv?v=' + Date.now());
                        const csvText = await response.text();
                        Papa.parse(csvText, {
                            header: true, dynamicTyping: true, skipEmptyLines: true,
                            complete: (results) => {
                                this.inventory = results.data.map(row => {
                                    const stocks = [];
                                    for(let i=1; i<=4; i++) {
                                        if(row[`s${i}_code`]) {
                                            stocks.push({
                                                code: String(row[`s${i}_code`]).trim(), 
                                                init: row[`s${i}_init`], 
                                                current: row[`s${i}_init`],
                                                histMin: row[`s${i}_init`],
                                                histMaxObs: 0
                                            });
                                        }
                                    }
                                    return { ...row, stocks };
                                });
                                this.fetchHistoryData();
                            }
                        });
                    } catch (e) { this.isSyncing = false; }
                },
                async fetchHistoryData() {
                    if (this.inventory.length === 0) return;
                    this.isSyncing = true;
                    const nowSec = Math.floor(Date.now() / 1000);
                    const taskMap = new Map();
                    this.inventory.forEach(item => {
                        if (!item.date || !item.stocks) return;
                        const startSec = Math.floor(new Date(String(item.date).replace(/-/g, '/')).getTime() / 1000);
                        item.stocks.forEach(s => {
                            const key = `${s.code}_${startSec}`;
                            if (!taskMap.has(key)) taskMap.set(key, { code: s.code, start: startSec });
                        });
                    });

                    const results = {};
                    const tasks = Array.from(taskMap.values());
                    for (let i = 0; i < tasks.length; i++) {
                        const task = tasks[i];
                        try {
                            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${task.code}?period1=${task.start}&period2=${nowSec}&interval=1d`;
                            const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                            const data = await resp.json();
                            const json = JSON.parse(data.contents);
                            if (json.chart.result?.[0]) {
                                const res = json.chart.result[0];
                                results[`${task.code}_${task.start}`] = {
                                    timestamps: res.timestamp,
                                    lows: res.indicators.quote[0].low,
                                    highs: res.indicators.quote[0].high,
                                    current: res.meta.regularMarketPrice
                                };
                            }
                        } catch (e) { }
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 100));
                    }

                    this.inventory.forEach(item => {
                        const startSec = Math.floor(new Date(String(item.date).replace(/-/g, '/')).getTime() / 1000);
                        const koStartSec = item.koStart ? Math.floor(new Date(String(item.koStart).replace(/-/g, '/')).getTime() / 1000) : 0;
                        item.stocks?.forEach(s => {
                            const res = results[`${s.code}_${startSec}`];
                            if (res) {
                                s.current = res.current;
                                s.histMin = Math.min(...res.lows.filter(v => v != null), res.current);
                                const obsHighs = res.highs.filter((val, idx) => val != null && res.timestamps[idx] >= koStartSec);
                                s.histMaxObs = obsHighs.length > 0 ? Math.max(...obsHighs, res.current) : 0;
                            }
                        });
                    });
                    this.isSyncing = false;
                }
            },
            mounted() {
                if (sessionStorage.getItem('fcn_auth') === 'true') { this.isLoggedIn = true; this.loadCSVData(); }
            }
        }).mount('#app');
    </script>
</body>
</html>
