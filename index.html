<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸Šæ–°èŠåˆ†è¡Œ - FCN å°ˆæ¥­ç®¡ç†ç³»çµ± v73</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f8fafc; color: #1e293b; font-family: -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif; }
        .fcn-card { background: white; border-radius: 32px; padding: 28px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; position: relative; }
        .nav-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 8px; border-radius: 40px; display: flex; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
        .nav-btn { padding: 10px 18px; border-radius: 30px; font-weight: 800; color: #64748b; transition: 0.2s; white-space: nowrap; font-size: 13px; cursor: pointer; border: none; }
        .nav-btn.active { background: #1f2937; color: white; }
        .risk-tab { padding: 12px 14px; font-weight: 800; color: #94a3b8; border-bottom: 3px solid transparent; flex: 1; text-align: center; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .risk-tab.active { color: #2563eb; border-bottom-color: #2563eb; background: rgba(37, 99, 235, 0.05); }
        .stock-tag { background: #ffffff; border: 2px solid #f1f5f9; border-radius: 20px; padding: 12px 8px; text-align: center; }
        .breach-tag { background: #fee2e2; color: #ef4444; font-size: 9px; padding: 2px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; font-weight: 900; }
        .ko-tag { background: #d1fae5; color: #059669; font-size: 9px; padding: 2px 6px; border-radius: 6px; margin-top: 4px; display: inline-block; font-weight: 900; }
        .soon-tag { background: #fef3c7; color: #d97706; font-size: 10px; padding: 2px 8px; border-radius: 6px; margin-top: 4px; display: inline-block; font-weight: 900; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" v-cloak class="max-w-4xl mx-auto">
        <!-- ç™»å…¥ä»‹é¢ (æš´åŠ›è§£æ³•ï¼šå…ˆç™»å…¥ï¼Œå†èƒŒæ™¯è®€å–) -->
        <div v-if="!isLoggedIn" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-6">
            <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm text-center shadow-2xl">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-6"><i class="fa-solid fa-key text-2xl"></i></div>
                <h2 class="text-2xl font-black mb-2 italic">ä¸Šæ–°èŠç®¡ç†ç³»çµ±</h2>
                <input v-model="inputPass" type="password" @keyup.enter="login" placeholder="Password" class="w-full bg-slate-100 border-none p-4 rounded-2xl text-center text-3xl mb-6 outline-none font-mono tracking-widest">
                <button @click="login" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-black text-lg">LOGIN</button>
            </div>
        </div>

        <template v-if="isLoggedIn">
            <!-- å°èˆªåˆ— -->
            <div class="nav-header sticky top-4 z-[1000] scrollbar-hide text-slate-800">
                <button @click="view = 'branch'" :class="['nav-btn', view === 'branch' ? 'active' : '']">è³‡ç”¢ç®¡ç†</button>
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">æŒ‰å®¢æˆ¶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">æŒ‰æ¥­å‹™å“¡</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">é è­¦ä¸­å¿ƒ</button>
                <div class="ml-auto flex items-center pr-3">
                    <span v-if="isSyncing" class="text-[10px] mr-2 font-black text-blue-500 italic animate-pulse">æ›´æ–°ä¸­...</span>
                    <i @click="refreshAll" class="fa-solid fa-rotate text-blue-500 cursor-pointer text-lg" :class="{'animate-spin': isSyncing}"></i>
                </div>
            </div>

            <!-- é è­¦ä¸­å¿ƒ -->
            <div v-if="view === 'alerts' && inventory.length > 0" class="space-y-4">
                <div class="flex bg-white rounded-2xl shadow-sm mb-4 overflow-x-auto scrollbar-hide border border-gray-100">
                    <button @click="alertTab = 'ki'" :class="['risk-tab', alertTab === 'ki' ? 'active' : '']">è§¸åŠKI({{kiList.length}})</button>
                    <button @click="alertTab = 'everKO'" :class="['risk-tab', alertTab === 'everKO' ? 'active' : '']">æ›¾ç¶“KO({{everKOList.length}})</button>
                    <button @click="alertTab = 'soon'" :class="['risk-tab', alertTab === 'soon' ? 'active' : '']">å³å°‡å‡ºå ´({{soonExitList.length}})</button>
                    <button @click="alertTab = 'exit'" :class="['risk-tab', alertTab === 'exit' ? 'active' : '']">å·²å‡ºå ´({{exitList.length}})</button>
                    <button @click="alertTab = 'exp'" :class="['risk-tab', alertTab === 'exp' ? 'active' : '']">åˆ°æœŸ({{expiringList.length}})</button>
                </div>
                <client-card v-for="item in currentAlertList" :item="item" :key="item.sn" :price-data="priceMap"></client-card>
            </div>

            <!-- å®¢æˆ¶åˆ—è¡¨ -->
            <div v-if="view === 'client' && inventory.length > 0" class="space-y-4">
                <input v-model="search" type="text" placeholder="ğŸ” æœå°‹..." class="w-full p-5 rounded-3xl bg-white shadow-sm font-bold border-none outline-none">
                <client-card v-for="item in clientFilteredList" :item="item" :key="item.sn" :price-data="priceMap"></client-card>
            </div>

            <!-- å¦‚æœ CSV æ²’è®€åˆ°ï¼Œé¡¯ç¤ºæ­¤æç¤º -->
            <div v-if="inventory.length === 0 && !isSyncing" class="fcn-card text-center py-20 text-slate-300">
                <p class="font-bold mb-4">å°šæœªåŠ è¼‰è³‡æ–™</p>
                <p class="text-xs mb-6 italic">è«‹ç¢ºä¿ data.csv ä½æ–¼ index.html æ—é‚Š<br>æˆ–ä½¿ç”¨ä¼ºæœå™¨ (å¦‚ GitHub) é–‹å•Ÿ</p>
                <!-- å³ä½¿æ‚¨ä¸æƒ³ä¸Šå‚³ï¼Œé€™æ˜¯ä¸€å€‹æœ€å¾Œçš„å‚™æ¡ˆ -->
                <input type="file" @change="handleManualFile" accept=".csv" class="hidden" id="manualCsv">
                <label for="manualCsv" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black cursor-pointer shadow-lg hover:bg-blue-700 transition">é»æ­¤é¸å– data.csv æª”æ¡ˆ</label>
            </div>

            <!-- è³‡ç”¢ç®¡ç† -->
            <div v-if="view === 'branch' && inventory.length > 0" class="space-y-4">
                <div v-for="curr in ['JPY', 'USD']" :key="curr" class="fcn-card text-white border-none shadow-2xl" :class="curr==='USD' ? 'bg-blue-600' : 'bg-slate-800'">
                    <div class="flex justify-between items-center opacity-70 mb-2 font-black text-xs uppercase"><span>Assets</span><span>{{ curr }}</span></div>
                    <div class="text-5xl font-black italic tracking-tighter">{{ curr==='JPY'?'Â¥':'$' }} {{ formatNum(curr==='JPY'?totalJPY:totalUSD) }} <span class="text-xl">è¬</span></div>
                </div>
            </div>
        </template>
    </div>

    <script>
        const { createApp, reactive } = Vue;
        const TD_API_KEY = "58c13a9bdeae41eb8b29bf3a75f34ffd"; // æ‚¨çš„é‡‘é‘°
        const stockNames = {'6146':'Disco','6501':'æ—¥ç«‹','7011':'ä¸‰è±é‡å·¥','6857':'æ„›å¾·è¬','7012':'å·å´é‡å·¥','7013':'IHIé‡å·¥','7974':'ä»»å¤©å ‚','8035':'æ±äº¬å¨åŠ›','5803':'è—¤å€‰é›»å­','8697':'æ—¥æœ¬äº¤æ˜“æ‰€','8002':'ä¸¸ç´…','NVDA':'è¼é”','TSLA':'ç‰¹æ–¯æ‹‰','TSM':'å°ç©é›»','AMD':'è¶…å¾®','MU':'ç¾å…‰','ARM':'å®‰è¬€','GOOG':'è°·æ­Œ','AMZN':'äºé¦¬éœ','AVGO':'åšé€š','MSFT':'å¾®è»Ÿ','META':'è‡‰æ›¸','DELL':'æˆ´çˆ¾','ORCL':'ç”²éª¨æ–‡','OKLO':'Oklo','PLTR':'å¸•è˜­æçˆ¾','NFLX':'ç¶²é£›','BRK.B':'æ³¢å…‹å¤'};

        const ClientCard = {
            props: ['item', 'priceData'],
            template: `
                <div class="fcn-card">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span class="bg-slate-900 text-white text-[10px] px-2 py-0.5 rounded-full font-black mr-2">{{ item.sn }}</span>
                            <h3 class="text-4xl font-black text-slate-800 tracking-tighter italic leading-none mt-2">{{ item.client }}</h3>
                            <p class="text-[11px] text-gray-400 font-bold mt-2 uppercase tracking-widest">{{ item.sales }} | {{ item.date }} ä¸‹å–®</p>
                        </div>
                        <div class="text-right">
                            <p class="text-4xl font-black text-blue-600 tracking-tighter italic leading-none">
                                <span class="text-xl mr-1">{{ item.currency==='JPY'?'Â¥':'$' }}</span>{{ formatNum(item.amount) }}<span class="text-lg ml-1">è¬</span>
                            </p>
                            <div class="mt-2 bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black inline-block">å¹´åŒ–: {{ item.coupon }}%</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div v-for="s in item.stocks" :key="s.code" class="stock-tag shadow-sm">
                            <div class="flex justify-between items-start px-1 mb-1">
                                <span class="text-[12px] font-black text-blue-600 uppercase">{{ s.code }}</span>
                                <span class="text-[11px] font-black" :class="perfColor(item, s)">{{ getPerf(item, s) }}%</span>
                            </div>
                            <p class="text-2xl font-black text-slate-800 leading-none tracking-tighter mb-3">{{ formatPrice(priceData[s.code]?.current) }}</p>
                            <div class="space-y-1 text-left px-1 border-t pt-2 text-[9px]">
                                <div class="flex justify-between text-gray-400"><span>KO</span><span class="font-black text-emerald-600">{{ formatPrice(s.init * (item.koP/100)) }}</span></div>
                                <div class="flex justify-between text-gray-400"><span>KI</span><span class="font-black text-rose-600">{{ formatPrice(s.init * (item.kiP/100)) }}</span></div>
                            </div>
                            <div v-if="checkKI(item, s)" class="breach-tag">æ›¾è§¸åŠ KI</div>
                            <div v-if="checkEverKO(item, s)" class="ko-tag">æ›¾è§¸åŠ KO</div>
                            <div v-if="checkSoon(item, s)" class="soon-tag">é›¢KOå·®3%</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t pt-4 text-[10px] font-black text-slate-400 uppercase">
                        <div>è§€å¯ŸæœŸèµ·å§‹: <span class="text-slate-800">{{ item.koStart || 'N/A' }}</span></div>
                        <div class="text-right">åˆ°æœŸæ—¥: <span class="text-blue-500">{{ item.expiry }}</span></div>
                    </div>
                </div>
            `,
            methods: {
                formatNum(n){ return n ? Math.floor(n).toLocaleString() : '0'; },
                formatPrice(n){ return (!n || n == 0) ? '---' : parseFloat(n).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); },
                getPerf(item, s){ 
                    const cur = this.priceData[s.code]?.current;
                    return cur ? ((cur / s.init) * 100).toFixed(2) : '100.00'; 
                },
                perfColor(item, s){ 
                    const p = parseFloat(this.getPerf(item, s));
                    if(p >= item.koP) return 'text-emerald-500';
                    if(p <= item.kiP) return 'text-rose-500';
                    return 'text-slate-400';
                },
                checkKI(item, s) {
                    const min = this.priceData[s.code]?.histMinByDate?.[item.date];
                    return min && (min / s.init * 100) <= item.kiP;
                },
                checkEverKO(item, s) {
                    const max = this.priceData[s.code]?.histMaxAfterKOStart?.[item.sn];
                    return max && (max / s.init * 100) >= item.koP;
                },
                checkSoon(item, s) {
                    const cur = this.priceData[s.code]?.current;
                    if (!cur || this.checkEverKO(item, s)) return false;
                    const p = (cur / s.init * 100);
                    return p < item.koP && (p / item.koP) >= 0.97;
                }
            }
        };

        createApp({
            components: { 'client-card': ClientCard },
            data() {
                return {
                    view: 'branch', isLoggedIn: false, inputPass: '', password: '98388',
                    inventory: [], isSyncing: false, search: '', alertTab: 'ki', selectedSales: 'å³å¤é”',
                    priceMap: reactive({})
                }
            },
            computed: {
                totalJPY() { return this.inventory.filter(i => i.currency === 'JPY').reduce((s, i) => s + (i.amount||0), 0); },
                totalUSD() { return this.inventory.filter(i => i.currency === 'USD').reduce((s, i) => s + (i.amount||0), 0); },
                kiList() { return this.inventory.filter(i => i.stocks?.some(s => this.checkKI(i, s))); },
                everKOList() { return this.inventory.filter(i => i.stocks?.some(s => this.checkEverKO(i, s))); },
                soonExitList() { return this.inventory.filter(i => {
                    if (!i.koStart || new Date() < new Date(i.koStart.replace(/-/g, '/'))) return false;
                    const reached = i.stocks.filter(s => this.checkEverKO(i, s));
                    if (i.stocks.length - reached.length === 1) {
                        const last = i.stocks.find(s => !reached.includes(s));
                        const cur = this.priceMap[last.code]?.current;
                        return cur && (cur / (last.init * i.koP / 100)) >= 0.97;
                    }
                    return false;
                }); },
                exitList() { return this.inventory.filter(i => {
                    if (!i.koStart || new Date() < new Date(i.koStart.replace(/-/g, '/'))) return false;
                    return i.stocks?.every(s => this.checkEverKO(i, s));
                }); },
                expiringList() { return this.inventory.filter(i => {
                    const diff = Math.ceil((new Date(i.expiry.replace(/-/g, '/')) - new Date()) / 86400000);
                    return diff >= 0 && diff <= 3;
                }); },
                currentAlertList() { 
                    const m = {ki:this.kiList, everKO:this.everKOList, soon:this.soonExitList, exit:this.exitList, exp:this.expiringList};
                    return m[this.alertTab] || [];
                },
                clientFilteredList() { const s = this.search.toLowerCase(); return !s ? this.inventory : this.inventory.filter(i => i.client.includes(s) || i.sn.toLowerCase().includes(s)); },
                salesFilteredList() { return this.inventory.filter(i => i.sales === this.selectedSales); }
            },
            methods: {
                checkKI(i, s) { const min = this.priceMap[s.code]?.histMinByDate?.[i.date]; return min && (min / s.init * 100) <= i.kiP; },
                checkEverKO(i, s) { const max = this.priceMap[s.code]?.histMaxAfterKOStart?.[i.sn]; return max && (max / s.init * 100) >= i.koP; },
                login() {
                    // æ¥µé€Ÿç™»å…¥ï¼šä¸æª¢æŸ¥æª”æ¡ˆï¼Œç›´æ¥é€²å»
                    if (this.inputPass === this.password) {
                        this.isLoggedIn = true;
                        sessionStorage.setItem('fcn_auth', 'true');
                        // é€²å»å¾Œ 0.5 ç§’é–‹å§‹æŠ“æª”æ¡ˆ
                        setTimeout(() => this.loadCSVData(), 500);
                    } else {
                        alert('å¯†ç¢¼éŒ¯èª¤');
                    }
                },
                handleManualFile(e) {
                    const file = e.target.files[0];
                    if (file) {
                        Papa.parse(file, { header: true, dynamicTyping: true, skipEmptyLines: true, complete: (res) => this.initProcess(res.data) });
                    }
                },
                async loadCSVData() {
                    this.isSyncing = true;
                    try {
                        const response = await fetch('data.csv?v=' + Date.now());
                        if (!response.ok) throw new Error();
                        const text = await response.text();
                        Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true, complete: (res) => this.initProcess(res.data) });
                    } catch (e) {
                        this.isSyncing = false;
                        console.warn("ç„¡æ³•è‡ªå‹•ç²å– data.csvï¼Œè«‹æ‰‹å‹•é¸å–æª”æ¡ˆã€‚");
                    }
                },
                initProcess(data) {
                    this.inventory = data.map(row => {
                        const stocks = [];
                        for(let i=1; i<=4; i++) if(row[`s${i}_code`]) {
                            const code = String(row[`s${i}_code`]).toUpperCase().replace('.T', '').trim();
                            stocks.push({ code, init: row[`s${i}_init`] });
                            if (!this.priceMap[code]) this.priceMap[code] = { current: 0, histMinByDate: {}, histMaxAfterKOStart: {} };
                        }
                        return { ...row, stocks };
                    });
                    this.refreshAll();
                },
                refreshAll() { this.fetchTDData(); },
                async fetchTDData() {
                    this.isSyncing = true;
                    const symbols = Object.keys(this.priceMap);
                    if (symbols.length === 0) { this.isSyncing = false; return; }
                    try {
                        // ç¾åƒ¹
                        const qUrl = `https://api.twelvedata.com/quote?symbol=${symbols.join(',')}&apikey=${TD_API_KEY}`;
                        const qRes = await (await fetch(qUrl)).json();
                        symbols.forEach(s => {
                            const d = symbols.length === 1 ? qRes : qRes[s];
                            if (d && d.close) this.priceMap[s].current = parseFloat(d.close);
                        });
                        // æ­·å²
                        for (const s of symbols) {
                            const hUrl = `https://api.twelvedata.com/time_series?symbol=${s}&interval=1day&outputsize=200&apikey=${TD_API_KEY}`;
                            const hRes = await (await fetch(hUrl)).json();
                            if (hRes.values) {
                                this.inventory.forEach(inv => {
                                    if (!inv.stocks?.find(st => st.code === s)) return;
                                    const oD = new Date(inv.date.replace(/-/g, '/'));
                                    const lows = hRes.values.filter(v => new Date(v.datetime) >= oD).map(v => parseFloat(v.low));
                                    this.priceMap[s].histMinByDate[inv.date] = Math.min(...lows, this.priceMap[s].current || 999999);
                                    if (inv.koStart) {
                                        const kD = new Date(inv.koStart.replace(/-/g, '/'));
                                        const highs = hRes.values.filter(v => new Date(v.datetime) >= kD).map(v => parseFloat(v.high));
                                        this.priceMap[s].histMaxAfterKOStart[inv.sn] = highs.length > 0 ? Math.max(...highs, this.priceMap[s].current || 0) : this.priceMap[s].current;
                                    }
                                });
                            }
                            await new Promise(r => setTimeout(r, 650));
                        }
                    } catch (e) { console.error("API Error"); }
                    this.isSyncing = false;
                }
            },
            mounted() { if (sessionStorage.getItem('fcn_auth') === 'true') { this.isLoggedIn = true; this.loadCSVData(); } }
        }).mount('#app');
    </script>
</body>
</html>
