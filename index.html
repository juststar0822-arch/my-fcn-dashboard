<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上新莊分行 - FCN 專業管理</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; color: #1f2937; }
        .fcn-card { background: white; border-radius: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stock-tag { background: #f3f4f6; border-radius: 8px; padding: 6px 12px; min-width: 80px; text-align: center; }
        .text-danger { color: #ef4444; font-weight: bold; }
        .text-success { color: #10b981; font-weight: bold; }
        .nav-btn { background: white; border-radius: 20px; padding: 8px 16px; font-weight: 600; color: #4b5563; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-btn.active { background: #1f2937; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" v-cloak class="max-w-md mx-auto space-y-6">
        
        <!-- 頂部功能列 -->
        <div class="flex justify-between items-center gap-2 overflow-x-auto pb-2">
            <div class="flex gap-2">
                <button @click="view = 'client'" :class="['nav-btn', view === 'client' ? 'active' : '']">按客戶</button>
                <button @click="view = 'sales'" :class="['nav-btn', view === 'sales' ? 'active' : '']">按業務</button>
                <button @click="view = 'alerts'" :class="['nav-btn', view === 'alerts' ? 'active' : '']">預警</button>
            </div>
            <button @click="fetchRealPrices" class="p-3 bg-white rounded-full shadow-md hover:bg-gray-50">
                <i class="fa-solid fa-rotate" :class="{'animate-spin': isSyncing}"></i>
            </button>
        </div>

        <!-- 搜尋欄 -->
        <div class="relative">
            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input v-model="search" type="text" placeholder="搜尋客戶或代碼" class="w-full pl-12 pr-4 py-3 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- 客戶列表 -->
        <div v-for="item in filteredList" :key="item.id" class="fcn-card p-6 space-y-4 relative border border-gray-100">
            <!-- 狀態標籤 -->
            <div v-if="isAllKO(item)" class="absolute right-6 top-6 bg-emerald-100 text-emerald-600 text-[10px] px-2 py-1 rounded font-black uppercase">READY TO EXIT</div>
            <div v-if="hasBreachedKI(item)" class="absolute right-6 top-6 bg-rose-100 text-rose-600 text-[10px] px-2 py-1 rounded font-black uppercase animate-pulse">KI BREACHED</div>

            <div>
                <h3 class="text-xl font-black text-gray-800">{{ item.client }}</h3>
                <p class="text-[11px] font-bold text-gray-400 uppercase tracking-widest mt-1">{{ item.sn }}</p>
            </div>

            <!-- 標的標籤列 -->
            <div class="flex flex-wrap gap-2">
                <div v-for="s in item.stocks" :key="s.code" class="stock-tag">
                    <p class="text-[10px] font-bold text-gray-500 uppercase">{{ s.code.replace('.T','') }}</p>
                    <p class="text-sm font-black" :class="stockColor(item, s)">{{ getPerf(item, s) }}%</p>
                </div>
            </div>

            <!-- 數據格網 -->
            <div class="grid grid-cols-2 gap-y-3 pt-2 border-t border-gray-50">
                <div>
                    <p class="text-[11px] text-gray-400 font-bold">庫存金額: <span class="text-gray-800">{{ formatNum(item.amount) }} 萬</span></p>
                    <p class="text-[11px] text-gray-400 font-bold">下單日期: <span class="text-gray-800">{{ item.date }}</span></p>
                    <p class="text-[11px] text-gray-400 font-bold">到期日期: <span class="text-gray-800 text-blue-600">{{ item.expiry }}</span></p>
                </div>
                <div class="text-right">
                    <p class="text-[11px] text-gray-400 font-bold">配息年率: <span class="text-gray-800">{{ item.coupon }}%</span></p>
                    <p class="text-[11px] text-gray-400 font-bold">月領利息: <span class="text-emerald-600 font-black">{{ item.currency === 'JPY' ? '¥' : '$' }}{{ formatNum(calcMonthly(item)) }}</span></p>
                    <p class="text-[11px] text-gray-400 font-bold">業務: <span class="text-gray-600">{{ item.sales }}</span></p>
                </div>
            </div>

            <!-- 門檻資訊 -->
            <div class="flex justify-between items-center text-[10px] font-black bg-gray-50 p-2 rounded-lg text-gray-500">
                <span>KO: {{ item.koP }}%</span>
                <span class="text-blue-500">PUT (履約): {{ item.strikeP }}%</span>
                <span :class="{'text-rose-500': hasBreachedKI(item)}">KI: {{ item.kiP }}%</span>
                <span class="text-gray-400 uppercase">Type: AKI</span>
            </div>
        </div>

        <div class="text-center text-[10px] text-gray-400 font-bold py-6">
            上新莊分行資產管理系統 · {{ lastTime }}
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    view: 'client', search: '', lastTime: '-', isSyncing: false,
                    inventory: [
                        {id:1, client:'吳柏輝', sn:'SNUBSELN01051', currency:'JPY', amount:5300, date:'2026/01/06', expiry:'2026/07/17', coupon:12.76, koP:95, strikeP:70, kiP:55, stocks:[{code:'6146.T', initial:54200, current:56880}, {code:'6501.T', initial:5445, current:5124}, {code:'7011.T', initial:4260, current:4233}], sales:'吳坤達' },
                        {id:2, client:'江雪嬌', sn:'SNUBSELN01051', currency:'JPY', amount:200, date:'2026/01/06', expiry:'2026/07/17', coupon:12.76, koP:95, strikeP:70, kiP:55, stocks:[{code:'6146.T', initial:54200, current:56880}, {code:'6501.T', initial:5445, current:5124}, {code:'7011.T', initial:4260, current:4233}], sales:'陳雅鈴' },
                        {id:3, client:'江雪嬌', sn:'SNUBSELN01051', currency:'JPY', amount:200, date:'2026/01/06', expiry:'2026/07/17', coupon:12.76, koP:95, strikeP:70, kiP:55, stocks:[{code:'6146.T', initial:54200, current:56880}, {code:'6501.T', initial:5445, current:5124}, {code:'7011.T', initial:4260, current:4233}], sales:'陳雅鈴' },
                        {id:4, client:'陳潤纓', sn:'SNJPMELN01153', currency:'USD', amount:33, date:'2026/01/02', expiry:'2026/07/15', coupon:18.00, koP:100, strikeP:80.76, kiP:0, stocks:[{code:'NVDA', initial:189, current:189}, {code:'TSLA', initial:438, current:431}, {code:'TSM', initial:320, current:319}], sales:'賴婉甄' },
                        {id:5, client:'劉介正', sn:'SNJPMELN01155', currency:'USD', amount:2, date:'2026/01/02', expiry:'2026/10/14', coupon:11.53, koP:100, strikeP:75, kiP:65, stocks:[{code:'AMD', initial:223, current:210}, {code:'NVDA', initial:189, current:189}, {code:'TSM', initial:320, current:319}], sales:'黃思婷' },
                        {id:6, client:'江雪嬌', sn:'SNNOELN01419', currency:'USD', amount:11, date:'2025/12/31', expiry:'2026/07/10', coupon:13.91, koP:100, strikeP:75, kiP:55, stocks:[{code:'MU', initial:285, current:340}, {code:'NVDA', initial:187, current:189}, {code:'TSLA', initial:450, current:431}], sales:'陳雅鈴' },
                        {id:7, client:'江雪嬌', sn:'SNBARELN00625', currency:'USD', amount:10, date:'2025/12/31', expiry:'2026/07/13', coupon:17.70, koP:100, strikeP:85, kiP:55, stocks:[{code:'MU', initial:285, current:340}, {code:'NVDA', initial:187, current:189}, {code:'TSLA', initial:450, current:431}], sales:'陳雅鈴' },
                        {id:8, client:'徐冠榮', sn:'SNNOELN01419', currency:'USD', amount:1, date:'2025/12/31', expiry:'2026/07/10', coupon:13.91, koP:100, strikeP:75, kiP:55, stocks:[{code:'MU', initial:285, current:340}, {code:'NVDA', initial:187, current:189}, {code:'TSLA', initial:450, current:431}], sales:'吳坤達' },
                        {id:9, client:'江雪嬌', sn:'SNUBSELN01039', currency:'USD', amount:10, date:'2025/12/29', expiry:'2026/09/11', coupon:19.17, koP:100, strikeP:75, kiP:65, stocks:[{code:'ARM', initial:111, current:116}, {code:'MU', initial:294, current:340}, {code:'NVDA', initial:188, current:189}, {code:'TSLA', initial:460, current:431}], sales:'陳雅鈴' },
                        {id:10, client:'吳適玲', sn:'SNUBSELN00988', currency:'JPY', amount:5300, date:'2025/12/04', expiry:'2026/06/16', coupon:13.76, koP:95, strikeP:70, kiP:60, stocks:[{code:'6857.T', initial:20700, current:20555}, {code:'7011.T', initial:4048, current:4233}, {code:'7012.T', initial:10680, current:11955}], sales:'吳坤達' },
                        {id:11, client:'蔡玉梅', sn:'SNUBSELN00988', currency:'JPY', amount:500, date:'2025/12/04', expiry:'2026/06/16', coupon:13.76, koP:95, strikeP:70, kiP:60, stocks:[{code:'6857.T', initial:20700, current:20555}, {code:'7011.T', initial:4048, current:4233}, {code:'7012.T', initial:10680, current:11955}], sales:'賴秋萍' },
                        {id:12, client:'劉介正', sn:'SNNOELN01366', currency:'USD', amount:2, date:'2025/12/03', expiry:'2026/06/12', coupon:15.88, koP:100, strikeP:75, kiP:60, stocks:[{code:'GOOG', initial:321, current:322}, {code:'MU', initial:234, current:340}, {code:'TSM', initial:295, current:319}], sales:'黃思婷' },
                        {id:13, client:'江雪嬌', sn:'SNNOELN01366', currency:'USD', amount:2, date:'2025/12/03', expiry:'2026/06/12', coupon:15.88, koP:100, strikeP:75, kiP:60, stocks:[{code:'GOOG', initial:321, current:322}, {code:'MU', initial:234, current:340}, {code:'TSM', initial:295, current:319}], sales:'陳雅鈴' },
                        {id:14, client:'佑昌投資', sn:'SNGSELN01264', currency:'JPY', amount:7000, date:'2025/12/01', expiry:'2026/06/10', coupon:12.78, koP:97, strikeP:75, kiP:65, stocks:[{code:'7013.T', initial:2730, current:3144}, {code:'7974.T', initial:13065, current:10215}, {code:'8035.T', initial:31630, current:37120}], sales:'吳坤達' },
                        {id:15, client:'吳柏輝', sn:'SNUBSELN00980', currency:'JPY', amount:0, date:'2025/11/19', expiry:'2026/06/01', coupon:12.48, koP:95, strikeP:67.5, kiP:60, stocks:[{code:'VOD.L', initial:100, current:100}], sales:'吳坤達' },
                        {id:18, client:'佑昌投資', sn:'SNMSELN02394', currency:'USD', amount:30, date:'2025/11/18', expiry:'2026/05/29', coupon:12.26, koP:100, strikeP:75, kiP:65, stocks:[{code:'AMZN', initial:223, current:242}, {code:'ARM', initial:136, current:116}, {code:'AVGO', initial:341, current:344}, {code:'TSM', initial:278, current:319}], sales:'吳坤達' },
                        {id:19, client:'江雪嬌', sn:'SNMSELN02390', currency:'JPY', amount:300, date:'2025/11/12', expiry:'2026/05/22', coupon:15.79, koP:100, strikeP:75, kiP:60, stocks:[{code:'5803.T', initial:20075, current:21000}, {code:'6857.T', initial:19830, current:20555}, {code:'8697.T', initial:1797, current:1748}], sales:'陳雅鈴' },
                        {id:21, client:'江雪嬌', sn:'SNMSELN02380', currency:'USD', amount:30, date:'2025/11/06', expiry:'2026/02/20', coupon:35.23, koP:999, strikeP:80, kiP:65, stocks:[{code:'AVGO', initial:355, current:344}, {code:'NVDA', initial:187, current:189}, {code:'OKLO', initial:106, current:98}, {code:'TSM', initial:289, current:319}], sales:'陳雅鈴' },
                        {id:22, client:'李麗娟', sn:'SNMSELN02369', currency:'USD', amount:1, date:'2025/11/03', expiry:'2026/05/14', coupon:12.69, koP:95, strikeP:68.5, kiP:64, stocks:[{code:'ARM', initial:168, current:116}, {code:'AVGO', initial:362, current:344}, {code:'DELL', initial:160, current:120}, {code:'ORCL', initial:257, current:193}], sales:'王淑濱' },
                        {id:26, client:'劉介正', sn:'SNBARELN00447', currency:'USD', amount:2, date:'2025/10/30', expiry:'2026/09/11', coupon:11.30, koP:100, strikeP:75, kiP:55, stocks:[{code:'ARM', initial:165, current:116}, {code:'NVDA', initial:203, current:189}, {code:'TSM', initial:303, current:319}], sales:'黃思婷' },
                        {id:33, client:'吳柏輝', sn:'SNBARELN00369', currency:'USD', amount:30, date:'2025/10/15', expiry:'2026/04/27', coupon:12.00, koP:95, strikeP:70.44, kiP:60, stocks:[{code:'AVGO', initial:351, current:344}, {code:'DELL', initial:153, current:120}, {code:'GOOGL', initial:250, current:322}, {code:'ORCL', initial:303, current:193}], sales:'吳坤達' },
                        {id:36, client:'吳適玲', sn:'SNBARELN00334', currency:'USD', amount:30, date:'2025/10/08', expiry:'2026/04/22', coupon:12.00, koP:95, strikeP:73.04, kiP:63, stocks:[{code:'AVGO', initial:345, current:344}, {code:'GOOGL', initial:244, current:322}, {code:'META', initial:717, current:649}, {code:'ORCL', initial:288, current:193}], sales:'吳坤達' },
                        {id:41, client:'吳柏輝', sn:'SNMSELN02205', currency:'USD', amount:30, date:'2025/08/19', expiry:'2026/03/03', coupon:12.88, koP:100, strikeP:75, kiP:65, stocks:[{code:'AVGO', initial:295, current:344}, {code:'NFLX', initial:121, current:91}, {code:'NVDA', initial:176, current:189}, {code:'TSM', initial:233, current:319}], sales:'吳坤達' }
                    ]
                }
            },
            computed: {
                filteredList() {
                    let list = this.inventory;
                    if (this.search) {
                        list = list.filter(i => i.client.includes(this.search) || i.sn.includes(this.search));
                    }
                    if (this.view === 'alerts') {
                        list = list.filter(i => this.hasBreachedKI(i) || this.isAllKO(i));
                    }
                    return list;
                },
                clientNames() { return [...new Set(this.inventory.map(i => i.client))].sort(); },
                alertCount() { return this.inventory.filter(i => this.hasBreachedKI(i) || this.isAllKO(i)).length; },
                groupedBySales() {
                    const g = {};
                    this.inventory.forEach(i => { if (!g[i.sales]) g[i.sales] = []; g[i.sales].push(i); });
                    return g;
                }
            },
            methods: {
                formatNum(n) { return Math.floor(n).toLocaleString(); },
                calcMonthly(item) { return (item.amount * 10000 * item.coupon / 100) / 12; },
                getPerf(item, s) { return ((s.current / s.initial) * 100).toFixed(2); },
                stockColor(item, s) {
                    const p = parseFloat(this.getPerf(item, s));
                    if (p >= item.koP) return 'text-success';
                    if (p <= item.strikeP) return 'text-danger';
                    return 'text-gray-800';
                },
                hasBreachedKI(item) { return item.kiP > 0 && item.stocks.some(s => parseFloat(this.getPerf(item, s)) <= item.kiP); },
                isAllKO(item) { return item.stocks.every(s => parseFloat(this.getPerf(item, s)) >= item.koP); },
                goClient(name) { this.search = name; this.view = 'client'; },
                navClass(active) { return `nav-btn ${active ? 'active' : ''}`; },
                async fetchRealPrices() {
                    this.isSyncing = true;
                    const symbols = [...new Set(this.inventory.flatMap(i => i.stocks.map(s => s.code)))];
                    try {
                        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols.join(',')}`;
                        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                        const data = await response.json();
                        const result = JSON.parse(data.contents);
                        if (result.quoteResponse && result.quoteResponse.result) {
                            const quotes = result.quoteResponse.result;
                            this.inventory.forEach(item => {
                                item.stocks.forEach(stock => {
                                    const q = quotes.find(quote => quote.symbol === stock.code);
                                    if (q) stock.current = q.regularMarketPrice;
                                });
                            });
                            this.lastTime = new Date().toLocaleTimeString();
                        }
                    } catch (e) { console.error(e); }
                    finally { this.isSyncing = false; }
                }
            },
            mounted() {
                this.fetchRealPrices();
                setInterval(() => this.fetchRealPrices(), 60000);
            }
        }).mount('#app')
    </script>
</body>
</html>
