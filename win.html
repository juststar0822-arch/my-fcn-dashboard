<!-- 1. è¼¸å…¥é¢æ¿ -->
<div class="control-panel">
    <h2 class="text-xl font-bold text-center mb-4 text-yellow-500">ğŸ† æ¦®è­½æ¦œç”Ÿæˆå™¨</h2>
    
    <div class="grid grid-cols-2 gap-3 mb-4 border-b border-gray-600 pb-4">
        <div><label>æ—¥æœŸ</label><input type="date" v-model="globalDate"></div>
        <div>
            <label>æ¥­ä»£</label>
            <select v-model="repIndex">
                <option v-for="(rep, index) in repList" :value="index">{{ rep.name }}</option>
            </select>
        </div>
    </div>

    <div class="bg-gray-800 p-3 rounded-lg mb-4">
        <h3 class="text-sm font-bold text-gray-400 mb-2">æ–°å¢æˆäº¤ç´€éŒ„</h3>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div>
                <label>å•†å“</label>
                <select v-model="form.productType" @change="handleProductChange">
                    <option value="FCN">FCN</option>
                    <option value="U6">å…ƒå…ƒè‡´å¯Œ U6</option>
                    <option value="U5">å…ƒå…ƒè‡´å¯Œ U5</option>
                    <option value="BOND">æµ·å¤–å‚µ</option>
                </select>
            </div>
            <div><label>BP</label><input type="number" v-model="form.bp" :disabled="isFixedBP"></div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <div>
                <label>å¹£åˆ¥</label>
                <select v-model="form.currency" @change="updateExRate">
                    <option value="USD">USD</option>
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
            </div>
            <div class="relative">
                <label>åŒ¯ç‡ <span v-if="loadingRate" class="text-yellow-500 animate-pulse text-xs">...</span></label>
                <input type="number" v-model="form.exRate" step="0.01">
            </div>
            <div><label>é‡‘é¡</label><input type="number" v-model="form.amount" class="text-yellow-400 font-bold"></div>
        </div>
        <button @click="addToCart" class="w-full bg-blue-600 text-white font-bold py-2 rounded mt-2 active:scale-95 transition">
            â• åŠ å…¥æ¸…å–®
        </button>
    </div>
</div>

<!-- 2. æ¸…å–® -->
<div class="list-panel" v-if="cart.length > 0">
    <h3 class="text-sm font-bold text-gray-400 mb-2">å·²åŠ å…¥ {{ cart.length }} ç­†</h3>
    <div v-for="(item, idx) in cart" :key="idx" class="item-card">
        <div>
            <span class="font-bold text-yellow-500 mr-2">{{ item.productType }}</span>
            <span class="text-gray-300">{{ item.currency }} {{ formatNumber(item.amount) }}</span>
        </div>
        <button @click="removeFromCart(idx)" class="text-red-500 font-bold px-2">âœ•</button>
    </div>
    <div class="bg-gray-700 p-3 rounded mt-4 border border-gray-500 text-sm">
        <div class="flex justify-between font-bold mb-1">
            <span class="text-gray-300">ç¸½æ‰‹æ”¶</span>
            <span class="text-white">NT$ {{ formatNumber(totalRevenue) }}</span>
        </div>
        <div class="flex justify-between font-bold">
            <span class="text-gray-300">ç¸½çé‡‘</span>
            <span class="text-yellow-400">NT$ {{ formatNumber(totalBonus) }}</span>
        </div>
    </div>
    <button @click="generateImage" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow mt-4 active:scale-95 transition text-lg">
        ç”Ÿæˆåœ–ç‰‡ (é•·æŒ‰å„²å­˜)
    </button>
</div>

<div class="list-panel text-center text-gray-500 py-4" v-else>è«‹å…ˆè¼¸å…¥ä¸¦åŠ å…¥æ¸…å–®</div>

<!-- 3. çµæœ -->
<div id="result-area">
    <p class="text-yellow-400 font-bold mb-2 animate-bounce">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
    <img id="final-img" alt="é•·æŒ‰å„²å­˜">
</div>

<!-- 4. é è¦½ç•«å¸ƒ -->
<div id="preview-container">
    <div id="certificate-node" class="certificate" :style="scaleStyle">
        
        <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>

        <svg class="svg-layer" viewBox="0 0 800 535" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="ribbonGrad" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#FFD700" stop-opacity="0.2"/>
                    <stop offset="100%" stop-color="#FF5722" stop-opacity="0.1"/>
                </linearGradient>
                <linearGradient id="gold" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stop-color="#FDB931"/><stop offset="50%" stop-color="#FFD700"/><stop offset="100%" stop-color="#B78628"/>
                </linearGradient>
            </defs>
            <path d="M-50 100 Q 200 300 400 50 T 850 200" stroke="url(#ribbonGrad)" stroke-width="60" fill="none" opacity="0.6"/>
            <path d="M850 400 Q 600 200 400 450 T -50 300" stroke="url(#ribbonGrad)" stroke-width="40" fill="none" opacity="0.5"/>
            <circle cx="100" cy="100" r="10" fill="#4CAF50" opacity="0.2"/>
            <circle cx="700" cy="400" r="15" fill="#2196F3" opacity="0.2"/>
            <rect x="600" y="80" width="20" height="20" fill="#FFC107" opacity="0.2" transform="rotate(30 610 90)"/>
            <rect x="150" y="450" width="15" height="15" fill="#E91E63" opacity="0.2" transform="rotate(45 157 457)"/>

            <g transform="translate(20, 60) scale(1.1)">
                <path d="M80 130 C -20 130, -20 260, 90 280" fill="none" stroke="#FDB931" stroke-width="25" stroke-linecap="round"/>
                <path d="M320 130 C 420 130, 420 260, 310 280" fill="none" stroke="#FDB931" stroke-width="25" stroke-linecap="round"/>
                <path d="M80 100 L320 100 L280 300 C 280 360, 120 360, 120 300 Z" fill="url(#gold)" stroke="#B8860B" stroke-width="3"/>
                <ellipse cx="200" cy="100" rx="120" ry="20" fill="#FFF8E1" stroke="#B8860B" stroke-width="3"/>
                <path d="M180 360 L220 360 L230 400 L170 400 Z" fill="#8B4513"/>
                <path d="M130 400 L270 400 L280 440 L120 440 Z" fill="#5D4037"/>
                <text x="200" y="180" text-anchor="middle" font-weight="900" fill="#B71C1C" font-size="50" font-family="'Microsoft JhengHei', 'Noto Sans TC', sans-serif" stroke="rgba(255,255,255,0.3)" stroke-width="1">ä¸Š</text>
                <text x="200" y="240" text-anchor="middle" font-weight="900" fill="#B71C1C" font-size="50" font-family="'Microsoft JhengHei', 'Noto Sans TC', sans-serif" stroke="rgba(255,255,255,0.3)" stroke-width="1">æ–°</text>
                <text x="200" y="300" text-anchor="middle" font-weight="900" fill="#B71C1C" font-size="50" font-family="'Microsoft JhengHei', 'Noto Sans TC', sans-serif" stroke="rgba(255,255,255,0.3)" stroke-width="1">èŠ</text>
            </g>

            <g transform="translate(320, 10) rotate(-10)">
                <circle cx="70" cy="70" r="60" stroke="#D93025" stroke-width="4" fill="none" stroke-dasharray="10,5"/>
                <text x="70" y="110" text-anchor="middle" font-size="100" font-weight="900" fill="#D93025" font-family="'Noto Serif TC', serif">è³€</text>
            </g>
        </svg>

        <div class="field field-date text-outline">{{ rocDate }}</div>

        <div class="field field-name text-outline">
            <div class="name-text">{{ currentRep.name }}</div>
            <div class="title-text">{{ currentRep.title }}</div>
        </div>

        <!-- å•†å“ -->
        <div class="field field-product">
            <div class="product-list">
                <div v-for="prod in finalProductList" :key="prod" class="product-box">
                    {{ prod }}
                </div>
            </div>
            <div class="count-text text-outline">å…±è¨ˆ{{ cart.length }}ç­†</div>
        </div>

        <!-- é‡‘é¡ (è‡ªå‹•æ›ç®—è¬å–®ä½) -->
        <div class="field field-amount text-outline">
            <div v-for="item in finalAmountList" :key="item.curr" class="amount-row">
                <span class="amount-text" :style="{ fontSize: amountFontSize }">{{ item.val }}</span>
                <span class="currency-text">{{ item.curr }}</span>
            </div>
        </div>

        <div class="field field-stats text-outline">
            <div class="stat-line">æ‰‹æ”¶ï¼š{{ formatNumber(totalRevenue) }}å…ƒ</div>
            <div class="stat-line" style="color:#b91c1c;">çé‡‘ï¼š{{ formatNumber(totalBonus) }}å…ƒ</div>
        </div>

        <div style="position: absolute; bottom: 15px; right: 15px;">
             <svg width="60" height="40" viewBox="0 0 100 60">
                 <rect x="30" y="20" width="40" height="40" fill="#ccc"/>
                 <rect x="0" y="35" width="30" height="25" fill="#aaa"/>
                 <rect x="70" y="45" width="30" height="15" fill="#eee"/>
                 <text x="50" y="50" text-anchor="middle" fill="white" font-weight="bold" font-size="20">1</text>
            </svg>
        </div>
    </div>
</div>