<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>市場即時追蹤</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --price-blue: #0040ff;
            --up-red: #ff3b30;
            --down-green: #34c759;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 15px; 
            display: flex; flex-direction: column; align-items: center;
        }

        .main-header { text-align: center; margin-bottom: 15px; }
        .main-header h1 { font-size: 22px; font-weight: 800; color: var(--text-main); margin: 0; }
        #update-time { font-size: 11px; color: var(--text-sub); margin-top: 5px; font-family: 'SF Mono', monospace; }

        .container { width: 100%; max-width: 450px; }
        
        /* 指數區塊 */
        .stock-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .mini-card {
            background: var(--card-bg); padding: 12px; border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .mini-name { font-size: 12px; font-weight: 700; color: var(--text-sub); display: block; margin-bottom: 4px; }
        .mini-price { font-size: 16px; font-weight: 800; color: var(--text-main); font-family: 'SF Mono'; }
        
        /* 匯率區塊 */
        .highlight-label {
            font-size: 15px; font-weight: 900; border-left: 4px solid var(--price-blue);
            padding-left: 10px; margin: 20px 0 10px; color: var(--text-main);
        }
        .rate-card {
            background: var(--card-bg); border-radius: 14px; padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .rate-val { font-size: 24px; font-weight: 900; color: var(--price-blue); font-family: 'SF Mono'; }
        .rate-info { text-align: right; }

        .up { color: var(--up-red); }
        .down { color: var(--down-green); }
    </style>
</head>
<body>

    <div class="main-header">
        <h1>市場即時追蹤</h1>
        <div id="update-time">正在獲取數據...</div>
    </div>

    <div class="container">
        <div class="stock-grid" id="stock-grid"></div>
        <div id="rate-list"></div>
    </div>

    <script>
        const symbols = [
            { id: "TWII", sym: "^TWII", name: "台股加權", prec: 0, grid: true },
            { id: "DJI", sym: "^DJI", name: "道瓊工業", prec: 0, grid: true },
            { id: "IXIC", sym: "^IXIC", name: "那斯達克", prec: 0, grid: true },
            { id: "TSM", sym: "TSM", name: "台積電 ADR", prec: 1, grid: true },
            { id: "USD", sym: "TWD=X", name: "美元/台幣", prec: 3, grid: false, unit: "USD" },
            { id: "JPY", sym: "JPYTWD=X", name: "日圓/台幣", prec: 4, grid: false, unit: "JPY" }
        ];

        async function updateMarket() {
            for (const item of symbols) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${item.sym}?interval=1m&range=1d`;
                    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&disableCache=true`);
                    const json = await res.json();
                    const data = JSON.parse(json.contents).chart.result[0];
                    
                    const price = data.meta.regularMarketPrice;
                    const prevClose = data.meta.chartPreviousClose;
                    const change = ((price - prevClose) / prevClose * 100).toFixed(2);

                    if (item.grid) {
                        renderGrid(item, price, change);
                    } else {
                        renderRate(item, price, change);
                    }
                } catch (e) {
                    console.log("Error fetching " + item.id);
                }
            }
            document.getElementById('update-time').innerText = `最後更新時間：${new Date().toLocaleTimeString()}`;
        }

        function renderGrid(item, price, change) {
            let el = document.getElementById(`box-${item.id}`);
            if (!el) {
                el = document.createElement('div');
                el.id = `box-${item.id}`;
                el.className = 'mini-card';
                document.getElementById('stock-grid').appendChild(el);
            }
            const isUp = change >= 0;
            el.innerHTML = `
                <span class="mini-name">${item.name}</span>
                <span class="mini-price">${price.toLocaleString(undefined, {maximumFractionDigits: item.prec})}</span>
                <div style="font-size:11px; margin-top:2px;" class="${isUp?'up':'down'}">
                    ${isUp?'▲':'▼'}${Math.abs(change)}%
                </div>
            `;
        }

        function renderRate(item, price, change) {
            let el = document.getElementById(`rate-${item.id}`);
            if (!el) {
                const list = document.getElementById('rate-list');
                const label = document.createElement('div');
                label.className = 'highlight-label';
                label.innerText = item.name;
                list.appendChild(label);

                el = document.createElement('div');
                el.id = `rate-${item.id}`;
                el.className = 'rate-card';
                list.appendChild(el);
            }
            
            const isUp = change >= 0;
            el.innerHTML = `
                <div class="rate-val">${item.unit} ${price.toFixed(item.prec)}</div>
                <div class="rate-info">
                    <div class="${isUp?'up':'down'}" style="font-size:13px; font-weight:700;">
                        ${isUp?'▲':'▼'}${Math.abs(change)}%
                    </div>
                </div>
            `;
        }

        updateMarket();
        setInterval(updateMarket, 30000); // 30秒自動刷新
    </script>
</body>
</html>