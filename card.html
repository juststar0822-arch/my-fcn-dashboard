<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­ä¿¡ç”¨å¡ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .mode-active { border: 2px solid #4f46e5; background-color: #eef2ff; color: #4f46e5; }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 999px; }
    </style>
</head>
<body class="pb-32">

    <!-- Header -->
    <header class="bg-white border-b p-4 sticky top-0 z-50">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">ğŸ’³ ä¿¡ç”¨å¡ç²¾ç´°ç®¡ç†</h1>
            <div class="flex gap-4 text-gray-500">
                <button onclick="toggleModal('usageModal')"><i class="fa-solid fa-chart-pie text-xl"></i></button>
                <button onclick="toggleModal('historyModal')"><i class="fa-solid fa-list-ul text-xl"></i></button>
            </div>
        </div>
    </header>

    <!-- æ¬Šç›Šæ¨¡å¼å³æ™‚åˆ‡æ›å€ -->
    <section class="max-w-md mx-auto p-4 space-y-4">
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-3">ç•¶å‰æ¬Šç›Šæ¨¡å¼è¨­å®š</h2>
            <div class="space-y-4">
                <!-- CUBE æ¨¡å¼ -->
                <div>
                    <p class="text-xs font-bold mb-2">åœ‹æ³° CUBEï¼š</p>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="cubeModes">
                        <button onclick="updateMode('cube', 'ç©æ•¸ä½')" class="cube-btn mode-active whitespace-nowrap px-3 py-1 rounded-lg border text-xs">ç©æ•¸ä½</button>
                        <button onclick="updateMode('cube', 'æ¨‚é¥—è³¼')" class="cube-btn border whitespace-nowrap px-3 py-1 rounded-lg text-xs">æ¨‚é¥—è³¼</button>
                        <button onclick="updateMode('cube', 'è¶£æ—…è¡Œ')" class="cube-btn border whitespace-nowrap px-3 py-1 rounded-lg text-xs">è¶£æ—…è¡Œ</button>
                        <button onclick="updateMode('cube', 'é›†ç²¾é¸')" class="cube-btn border whitespace-nowrap px-3 py-1 rounded-lg text-xs">é›†ç²¾é¸</button>
                    </div>
                </div>
                <!-- Unicard æ¨¡å¼ -->
                <div>
                    <p class="text-xs font-bold mb-2">ç‰å±± Unicardï¼š</p>
                    <div class="flex gap-2" id="uniModes">
                        <button onclick="updateMode('uni', 'ç°¡å–®é¸')" class="uni-btn mode-active px-3 py-1 rounded-lg border text-xs">ç°¡å–®é¸</button>
                        <button onclick="updateMode('uni', 'ä»»æ„é¸')" class="uni-btn border px-3 py-1 rounded-lg text-xs">ä»»æ„é¸</button>
                        <button onclick="updateMode('uni', 'è¨‚è£½é¸')" class="uni-btn border px-3 py-1 rounded-lg text-xs">è¨‚è£½é¸(5%)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœå°‹å»ºè­° -->
        <div class="relative">
            <input type="text" id="merchantSearch" onkeyup="searchMerchant()" placeholder="è¼¸å…¥æ¶ˆè²»é€šè·¯ (å¦‚ï¼šè¦çš®ã€UberEats...)" 
                class="w-full p-4 rounded-2xl shadow-sm border-none focus:ring-2 focus:ring-indigo-500">
            <div id="searchSuggestions" class="absolute w-full bg-white shadow-xl rounded-b-2xl z-10 hidden max-h-60 overflow-y-auto"></div>
        </div>

        <!-- å¡ç‰‡é¡åº¦åˆ—è¡¨ -->
        <div id="cardList" class="space-y-4">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </section>

    <!-- æ¶ˆè²»è¼¸å…¥å½ˆçª— -->
    <div id="calcModal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6">
            <h3 id="modalTitle" class="text-xl font-bold mb-2">è¨˜éŒ„æ¶ˆè²»</h3>
            <p id="modalSub" class="text-sm text-gray-400 mb-4 font-medium"></p>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500">æ¶ˆè²»é‡‘é¡ (NTD)</label>
                    <input type="number" id="inputAmount" class="w-full text-3xl font-bold border-b-2 border-gray-200 focus:border-indigo-600 outline-none py-2">
                </div>
                <button onclick="saveTransaction()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200">ç¢ºèªå­˜æª”</button>
                <button onclick="toggleModal('calcModal')" class="w-full text-gray-400 py-2 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // 1. æ›´ç²¾ç´°çš„å¡ç‰‡èˆ‡ä¸Šé™è³‡æ–™åº«
        const cardConfig = {
            cube: {
                name: "åœ‹æ³° CUBE",
                mode: "ç©æ•¸ä½",
                color: "amber-500",
                rules: {
                    "ç©æ•¸ä½": { "ç¶²è³¼": 3, "ä¸²æµ": 3, "è¦çš®": 3, "momo": 3, "é…·æ¾": 3 },
                    "æ¨‚é¥—è³¼": { "ç™¾è²¨": 3, "é¤é£²": 3, "å¤–é€": 3, "UberEats": 3, "èª å“": 3 },
                    "è¶£æ—…è¡Œ": { "ä½å®¿": 3, "æ©Ÿç¥¨": 3, "å«è»Š": 3, "Uber": 3, "åœ‹å¤–æ¶ˆè²»": 3 },
                    "é›†ç²¾é¸": { "å…¨å®¶": 3, "å…¨è¯": 3, "ä¸­æ²¹": 3, "UberEats": 3 }
                },
                cap: Infinity // ç„¡ä¸Šé™
            },
            gogo: {
                name: "å°æ–° GoGo",
                color: "red-600",
                rules: { "all": { "LINE Pay": 3.8, "å…¨æ”¯ä»˜": 3.8, "å°æ–°Pay": 3.8, "è¦çš®": 3.8, "momo": 3.8, "PChome": 3.8 } },
                cap: 30303 // 3.3%åŠ ç¢¼ä¸Šé™1000é»ï¼Œæ¨ç®—æ¶ˆè²»é¡
            },
            legend: {
                name: "æ˜Ÿå±•å‚³èªªå°æ±º",
                color: "slate-800",
                rules: { "all": { "UberEats": 10, "Foodpanda": 10, "Netflix": 10, "Disney+": 10, "Spotify": 10, "AppStore": 10 } },
                cap: 4285 // 7%åŠ ç¢¼ä¸Šé™300é»
            },
            unicard: {
                name: "ç‰å±± Unicard",
                mode: "ç°¡å–®é¸",
                color: "emerald-600",
                rules: {
                    "ç°¡å–®é¸": { "all": 1 },
                    "ä»»æ„é¸": { "ç‰¹åº—": 3.5 },
                    "è¨‚è£½é¸": { "LINE Pay": 5, "å…¨å®¶": 5, "momo": 5 }
                },
                cap: 10000 // ä¾æ¨¡å¼ä¸åŒï¼Œé€™è£¡è¨­ä¸€å€‹å¹³å‡é è­¦å€¼
            }
        };

        // 2. æœ¬åœ°å„²å­˜èˆ‡ç´¯è¨ˆ
        let logs = JSON.parse(localStorage.getItem('fina_logs')) || [];
        let currentEditingCard = '';

        function updateMode(type, mode) {
            cardConfig[type].mode = mode;
            // æ›´æ–° UI æ¨£å¼
            document.querySelectorAll(`.${type}-btn`).forEach(b => b.classList.remove('mode-active'));
            event.target.classList.add('mode-active');
            renderCards();
        }

        function getCardUsage(cardKey) {
            const currentMonth = new Date().getMonth();
            return logs
                .filter(l => l.cardKey === cardKey && new Date(l.date).getMonth() === currentMonth)
                .reduce((sum, l) => sum + parseFloat(l.amount), 0);
        }

        function renderCards() {
            const container = document.getElementById('cardList');
            container.innerHTML = '';

            Object.keys(cardConfig).forEach(key => {
                const card = cardConfig[key];
                const usage = getCardUsage(key);
                const progress = card.cap === Infinity ? 0 : (usage / card.cap) * 100;
                const statusColor = progress > 90 ? 'bg-red-500' : 'bg-indigo-500';

                const div = document.createElement('div');
                div.className = "bg-white rounded-2xl p-5 shadow-sm border border-gray-100";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-black text-gray-800">${card.name}</h3>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Current Mode: ${card.mode || 'Normal'}</p>
                        </div>
                        <button onclick="openCalc('${key}')" class="bg-gray-100 px-3 py-1 rounded-full text-xs font-bold text-gray-600">è¨˜å¸³ +</button>
                    </div>
                    
                    ${card.cap !== Infinity ? `
                    <div class="space-y-1 mb-4">
                        <div class="flex justify-between text-[10px] font-bold">
                            <span class="text-gray-400 uppercase">Monthly Cap Usage</span>
                            <span class="${progress > 90 ? 'text-red-500' : 'text-gray-600'}">${Math.round(usage).toLocaleString()} / ${card.cap.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                            <div class="progress-bar ${statusColor} h-full" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                    </div>
                    ` : '<div class="h-4"></div>'}

                    <div class="grid grid-cols-2 gap-2">
                        ${getTopRewards(key)}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function getTopRewards(key) {
            const card = cardConfig[key];
            const activeRules = card.mode ? card.rules[card.mode] : card.rules.all;
            return Object.entries(activeRules).slice(0, 4).map(([name, rate]) => `
                <div class="bg-gray-50 p-2 rounded-lg flex justify-between items-center">
                    <span class="text-[10px] font-bold text-gray-500">${name}</span>
                    <span class="text-xs font-black text-red-500">${rate}%</span>
                </div>
            `).join('');
        }

        // 3. æœå°‹é‚è¼¯ (æ›´ç´°ç·»çš„åŒ¹é…)
        const merchants = [
            { name: "è¦çš®", tags: ["ç¶²è³¼", "æ”¯ä»˜"], best: ["gogo", "cube"] },
            { name: "UberEats", tags: ["å¤–é€"], best: ["legend", "cube"] },
            { name: "LINE Pay", tags: ["æ”¯ä»˜"], best: ["unicard", "gogo"] },
            { name: "Netflix", tags: ["å½±éŸ³"], best: ["legend"] },
            { name: "æ—¥æœ¬æ—…éŠ", tags: ["æ—…éŠ", "åœ‹å¤–"], best: ["cube", "jcb"] }
        ];

        function searchMerchant() {
            const val = document.getElementById('merchantSearch').value;
            const sug = document.getElementById('searchSuggestions');
            if(!val) { sug.classList.add('hidden'); return; }

            const results = merchants.filter(m => m.name.includes(val) || m.tags.some(t => t.includes(val)));
            sug.innerHTML = results.map(r => `
                <div class="p-4 border-b hover:bg-gray-50 cursor-pointer flex justify-between items-center" onclick="applySearch('${r.name}')">
                    <div>
                        <span class="font-bold text-gray-800">${r.name}</span>
                        <p class="text-[10px] text-gray-400">${r.tags.join(', ')}</p>
                    </div>
                    <div class="flex gap-1">
                        ${r.best.map(b => `<span class="bg-indigo-100 text-indigo-600 text-[10px] px-2 py-1 rounded-md font-bold">${cardConfig[b].name}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            sug.classList.remove('hidden');
        }

        function applySearch(name) {
            document.getElementById('merchantSearch').value = name;
            document.getElementById('searchSuggestions').classList.add('hidden');
        }

        // 4. è¨˜å¸³é‚è¼¯
        function openCalc(key) {
            currentEditingCard = key;
            document.getElementById('modalTitle').innerText = cardConfig[key].name;
            document.getElementById('modalSub').innerText = `ç›®å‰æ¨¡å¼ï¼š${cardConfig[key].mode || 'åŸºæœ¬æ¬Šç›Š'}`;
            toggleModal('calcModal');
        }

        function saveTransaction() {
            const amt = document.getElementById('inputAmount').value;
            if(!amt) return;

            const log = {
                id: Date.now(),
                cardKey: currentEditingCard,
                cardName: cardConfig[currentEditingCard].name,
                amount: amt,
                date: new Date().toISOString()
            };

            logs.push(log);
            localStorage.setItem('fina_logs', JSON.stringify(logs));
            document.getElementById('inputAmount').value = '';
            toggleModal('calcModal');
            renderCards();
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        // åˆå§‹åŒ–
        window.onload = renderCards;
    </script>
</body>
</html>